<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeu de l'Oie Coquin</title>
    <!-- Ligne pour ins√©rer le favicon avec l'emoji üíã -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíã</text></svg>">
    <style>
        /* Variables CSS pour les couleurs et l'ambiance */
        :root {
            --color-primary: #FF69B4; /* Rose vif */
            --color-secondary: #FFC0CB; /* Rose p√¢le */
            --color-text: #333;
            --color-background-start: #FCE4EC; /* Tr√®s p√¢le pour le d√©but */
            --color-background-level1: #FFEBEE; /* Rose l√©ger */
            --color-background-level2: #FFCDD2; /* Rose moyen */
            --color-background-level3: #EF9A9A; /* Rose plus soutenu */
            --color-background-level4: #E57373; /* Rouge-rose intense */
            --color-background-level5: #8B008B; /* Violet fonc√© pour le niveau 5 */
            --color-button: #FF1493; /* Rose profond */
            --color-button-hover: #C71585; /* Rose plus fonc√© */
            --color-debug-bg: rgba(255, 255, 0, 0.9);
            --color-debug-border: #999;

            /* Couleurs pour le th√®me bleu (joueur homme) */
            --color-blue-primary: #007bff; /* Bleu standard */
            --color-blue-secondary: #6cbfff; /* Bleu clair */
            --color-blue-button: #0056b3; /* Bleu fonc√© pour bouton */
            --color-blue-button-hover: #004085; /* Bleu encore plus fonc√© */
        }

        /* Styles g√©n√©raux pour le corps de la page */
        html, body {
            height: 100%; /* Ensure full height for vh units to work correctly */
            margin: 0;
            padding: 0;
            overflow: hidden; /* Emp√™che le scroll par d√©faut du body */
        }

        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: var(--color-background-start);
            color: var(--color-text);
            transition: background-color 0.8s ease-in-out; /* Transition pour le changement de fond */
        }

        /* --- √âcran d'accueil --- */
        #start-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            text-align: center;
            max-width: 350px;
            width: 90%;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-height: 85vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        #start-screen h1 {
            color: var(--color-primary);
            margin-bottom: 25px;
            font-size: 2.2em;
        }

        #start-screen label {
            margin-top: 15px;
            font-weight: bold;
            color: var(--color-primary);
        }

        #start-screen input[type="text"],
        #start-screen input[type="number"] { /* Style pour les inputs num√©riques aussi */
            padding: 12px;
            margin-top: 8px;
            border: 2px solid var(--color-secondary);
            border-radius: 8px;
            width: calc(100% - 24px);
            font-size: 1.1em;
            text-align: center;
        }

        /* Styles pour la s√©lection d'emojis */
        .emoji-selection {
            margin-top: 20px;
            width: 100%;
        }

        .emoji-options {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .emoji-option {
            font-size: 2.5em;
            cursor: pointer;
            padding: 4px;
            border: 2px solid transparent;
            border-radius: 8px;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }

        .emoji-option:hover {
            background-color: var(--color-secondary);
        }

        .emoji-option.selected {
            border-color: var(--color-button);
            background-color: var(--color-secondary);
        }

        #start-screen button {
            background-color: var(--color-button);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 30px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #start-screen button:hover {
            background-color: var(--color-button-hover);
        }

        /* Loading indicator (kept for visual consistency, but not used by Firebase anymore) */
        #loading-indicator {
            margin-top: 20px;
            font-size: 1.2em;
            color: var(--color-primary);
            display: none; /* Hide by default now */
        }

        /* --- √âcran de jeu --- */
        #game-screen {
            display: none; /* Cach√© par d√©faut, affich√© par JS */
            flex-direction: column;
            width: 100%;
            height: 100vh;
            position: relative;
            align-items: center;
        }

        #game-board-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            white-space: nowrap;
            position: relative;
            height: 200px;
            display: flex;
            align-items: center;
            margin-top: 50px;
            padding-bottom: 20px;
        }

        .case {
            display: inline-flex;
            flex-shrink: 0;
            width: 150px;
            height: 150px;
            background-color: var(--color-secondary);
            border: 2px solid var(--color-primary);
            border-radius: 10px;
            margin: 0 5px;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--color-primary);
            transition: background-color 0.5s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* Styles pour les niveaux d'intensit√© des cases (appliqu√©s par JS) */
        .level-1 { background-color: var(--color-background-level1); border-color: var(--color-primary); }
        .level-2 { background-color: var(--color-background-level2); border-color: var(--color-primary); }
        .level-3 { background-color: var(--color-background-level3); border-color: #D32F2F; }
        .level-4 { background-color: var(--color-background-level4); border-color: #B71C1C; }
        .level-5 { background-color: var(--color-background-level5); border-color: #4B0082; color: white; }


        /* Base style for all case emojis */
        .case .emoji-icon {
            position: absolute;
            font-size: 0.8em; /* Slightly smaller than case number */
        }

        /* Specific positions for each icon */
        .case .go-back-emoji { top: 5px; right: 5px; }
        .case .undress-emoji { top: 5px; left: 5px; }
        .case .action-emoji { bottom: 5px; right: 5px; }
        .case .truth-dare-emoji { bottom: 5px; left: 5px; }
        .case .massage-sensory-emoji { top: 5px; /* Adjust as needed for centering */ }
        .case .role-play-emoji { bottom: 5px; /* Adjust as needed for centering */ }
        .case .sexual-position-emoji { right: 5px; /* Adjust as needed for centering */ }


        /* Style for special cases borders/shadows */
        .case.go-back-case { border-color: #FF0000; box-shadow: 0 0 15px rgba(255, 0, 0, 0.4); }
        .case.undress-case { border-color: #FFD700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }
        .case.action-case { border-color: #00FF00; box-shadow: 0 0 15px rgba(0, 255, 0, 0.4); }
        .case.truth-dare-case { border-color: #00BFFF; /* Bleu clair */ box-shadow: 0 0 15px rgba(0, 191, 255, 0.4); }
        .case.massage-sensory-case { border-color: #FF69B4; /* Rose vif */ box-shadow: 0 0 15px rgba(255, 105, 180, 0.4); }
        .case.role-play-case { border-color: #9370DB; /* Violet moyen */ box-shadow: 0 0 15px rgba(147, 112, 219, 0.4); }
        .case.sexual-position-case { border-color: #4B0082; /* Bordure plus fonc√©e pour le violet */ box-shadow: 0 0 15px rgba(75, 0, 130, 0.4); }

        /* Styles pour les cases Vestiaire - √âclaircies et texte visible */
        .case.vestiaire-case {
            background-color: #A9A9A9; /* Gris plus clair */
            border-color: #666666; /* Bordure fonc√©e mais visible */
            color: white; /* Texte blanc pour contraster */
            font-size: 1.8em; /* Rendre le texte "Vestiaire" visible */
            flex-direction: column; /* Pour empiler ic√¥ne et texte si besoin */
            position: relative;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
        }

        .vestiaire-case .vestiaire-icon {
            font-size: 2.5em; /* Grande ic√¥ne */
            color: white; /* Couleur de l'ic√¥ne - reste blanc pour contraster avec le gris clair */
            margin-bottom: 5px; /* Espace entre ic√¥ne et texte */
            position: static; /* Supprime le positionnement absolu pour le flux normal */
        }

        /* Style pour la case D√©part */
        .case.start-case {
            background-color: #4CAF50; /* Vert pour le d√©part */
            border-color: #388E3C;
            color: white;
            font-size: 2em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }


        .player-token {
            position: absolute;
            top: calc(50% - 25px);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: left 0.8s ease-in-out, transform 0.3s ease;
            z-index: 10;
            font-size: 2.5em;
            color: white;
        }
        .player-token.male { background-color: #00BFFF; }
        .player-token.female { background-color: #FF69B4; }

        /* Styles pour les pions sur la m√™me case */
        .player-token.on-same-case.male { transform: translateX(-15px); }
        .player-token.on-same-case.female { transform: translateX(15px); }


        /* --- Zone du d√© --- */
        #dice-area {
            position: fixed;
            bottom: 100px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 20;
        }

        /* Styles pour le nouveau d√© visuel */
        #dice-container {
            width: 80px; /* Taille du d√© */
            height: 80px;
            background-color: white; /* Default white background for female player */
            border: 2px solid var(--color-primary); /* Pink border by default for female player */
            position: relative; /* Pour positionner les points */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px; /* Espace entre le d√© et le bouton */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden; /* Pour s'assurer que les points ne d√©bordent pas */
            transition: background-color 0.3s ease, border-color 0.3s ease; /* Transition pour les couleurs du d√© */
        }

        /* Styles pour le d√© quand le joueur masculin joue */
        #dice-container.blue-theme {
            background-color: var(--color-blue-primary); /* Blue background for male player */
            border-color: var(--color-blue-primary); /* Blue border for male player */
        }

        .dot {
            position: absolute;
            width: 15px; /* Taille du point */
            height: 15px;
            background-color: black; /* Default black dots for female player */
            border-radius: 50%;
            opacity: 0; /* Cach√© par d√©faut */
            transition: opacity 0.1s ease, background-color 0.3s ease; /* Transition douce pour les points */
        }

        /* Points blancs pour le d√© quand le joueur masculin joue */
        #dice-container.blue-theme .dot {
            background-color: white; /* White dots for male player */
        }

        /* Positionnement des points */
        .dot.top-left { top: 10px; left: 10px; }
        .dot.top-right { top: 10px; right: 10px; }
        .dot.middle-left { top: 50%; left: 10px; transform: translateY(-50%); }
        .dot.center { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .dot.middle-right { top: 50%; right: 10px; transform: translateY(-50%); }
        .dot.bottom-left { bottom: 10px; left: 10px; }
        .dot.bottom-right { bottom: 10px; right: 10px; }


        #roll-dice-button {
            background-color: var(--color-button);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 12px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        #roll-dice-button:hover {
            background-color: var(--color-button-hover);
        }

        #roll-dice-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* --- Pop-up de gage et de victoire (styles partag√©s) --- */
        #gag-popup, #victory-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #gag-popup.active, #victory-popup.active {
            opacity: 1;
            visibility: visible;
        }

        .gag-content { /* Appliqu√© aux deux pop-ups */
            background-color: white;
            padding: 20px 30px; /* Adjusted padding */
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            width: 400px;
            max-height: 95vh; /* Increased max-height for more scroll space */
            overflow-y: auto; /* Active le d√©filement vertical si le contenu d√©passe */
            box-sizing: border-box; /* Ensures padding is included in height calculation */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            color: var(--color-text);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #gag-popup.active .gag-content, #victory-popup.active .gag-content {
            transform: scale(1);
        }

        .gag-content h2 {
            color: var(--color-button);
            margin-top: 0;
            font-size: 2em;
        }

        .gag-content p {
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 20px;
            /* Removed overflow-y: auto and max-height from p tag, as parent .gag-content handles it */
        }

        /* Style pour l'image du gage */
        .gag-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .gag-content button {
            background-color: var(--color-button);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 5px; /* Pour espacer les boutons de victoire */
        }

        .gag-content button:hover {
            background-color: var(--color-button-hover);
        }

        /* Petit indicateur de joueur actuel */
        #current-player-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1em;
            color: var(--color-primary);
            z-index: 50;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* --- Debug Controls --- */
        #toggle-debug-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            z-index: 60;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        #debug-controls {
            display: none;
            position: fixed;
            top: 60px;
            right: 20px;
            background-color: var(--color-debug-bg);
            border: 1px solid var(--color-debug-border);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 55;
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
        }

        #debug-controls label {
            font-weight: bold;
            color: var(--color-text);
            font-size: 0.9em;
        }

        #debug-controls input[type="number"] {
            width: 80px;
            padding: 8px;
            border: 1px solid var(--color-debug-border);
            border-radius: 5px;
            font-size: 1em;
        }

        #debug-controls button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #debug-controls button:hover {
            background-color: #218838;
        }

        /* Styles pour le th√®me bleu (joueur homme) */
        #current-player-indicator.blue-theme {
            color: var(--color-blue-primary);
        }

        #dice-area.blue-theme #roll-dice-button {
            background-color: var(--color-blue-button);
        }

        #dice-area.blue-theme #roll-dice-button:hover {
            background-color: var(--color-blue-button-hover);
        }

        /* Admin Mode Popup (Login) */
        #admin-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #admin-popup.active {
            opacity: 1;
            visibility: visible;
        }

        .admin-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            width: 500px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            color: var(--color-text);
        }

        #admin-popup.active .admin-content {
            transform: scale(1);
        }

        .admin-content h2 {
            color: #4CAF50; /* Green for admin */
            margin-top: 0;
            font-size: 2em;
        }

        .admin-content p {
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .admin-content input[type="password"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            width: calc(100% - 20px);
            margin-bottom: 15px;
        }

        .admin-content button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 5px;
        }

        .admin-content button:hover {
            background-color: #388E3C;
        }

        /* Admin Panel (after login) */
        #admin-panel-content {
            display: none; /* Hidden by default, shown after login */
            flex-direction: column;
            width: 100%;
            max-width: 600px; /* Max width for larger screens */
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            box-sizing: border-box;
            max-height: 90vh; /* Limit height for mobile */
            overflow-y: auto; /* Scrollable list */
            position: relative;
        }

        #admin-panel-content h3 {
            color: var(--color-primary);
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
        }

        #gages-list-container {
            flex-grow: 1; /* Allows list to take available space */
            overflow-y: auto; /* Scrollable list */
            padding-right: 5px; /* For scrollbar */
        }

        .gage-item {
            background-color: var(--color-secondary);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative; /* For action buttons positioning */
        }

        .gage-item-title {
            font-weight: bold;
            color: var(--color-button);
            font-size: 1.1em;
        }

        .gage-item-details {
            font-size: 0.9em;
            color: var(--color-text);
        }

        .gage-item-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: flex-end; /* Align buttons to the right */
        }

        .gage-item-actions button {
            background-color: #6c757d; /* Grey for action buttons */
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .gage-item-actions button.edit-button { background-color: #007bff; }
        .gage-item-actions button.delete-button { background-color: #dc3545; }

        .gage-item-actions button:hover {
            opacity: 0.8;
        }

        #add-gage-button-main {
            background-color: #28a745; /* Green for add button */
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 20px;
            width: 100%; /* Full width on mobile */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        #add-gage-button-main:hover {
            background-color: #218838;
        }

        /* Gage Form Popup (for Add/Edit) */
        #gage-form-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200; /* Higher z-index than admin popup */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #gage-form-popup.active {
            opacity: 1;
            visibility: visible;
        }

        .gage-form-content {
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 95%; /* Max width for mobile */
            width: 500px; /* Max width for larger screens */
            max-height: 95vh; /* Limit height for mobile */
            overflow-y: auto; /* Scrollable form */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            color: var(--color-text);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #gage-form-popup.active .gage-form-content {
            transform: scale(1);
        }

        .gage-form-content h2 {
            color: var(--color-button);
            margin-top: 0;
            text-align: center;
            font-size: 1.8em;
        }

        .gage-form-content label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block; /* Make labels block for better spacing */
            color: var(--color-primary);
        }

        .gage-form-content input[type="text"],
        .gage-form-content input[type="number"],
        .gage-form-content input[type="url"],
        .gage-form-content textarea,
        .gage-form-content select {
            width: calc(100% - 20px); /* Adjust for padding */
            padding: 10px;
            border: 1px solid var(--color-secondary);
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 10px; /* Space after each input */
            box-sizing: border-box; /* Include padding in width */
        }

        .gage-form-content textarea {
            min-height: 80px;
            resize: vertical;
        }

        .gage-form-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            gap: 10px;
        }

        .gage-form-buttons button {
            background-color: var(--color-button);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            flex: 1; /* Distribute space evenly */
        }

        .gage-form-buttons button.cancel-button {
            background-color: #6c757d; /* Grey for cancel */
        }
        .gage-form-buttons button.cancel-button:hover {
            background-color: #5a6268;
        }
        .gage-form-buttons button.save-button:hover {
            background-color: var(--color-button-hover);
        }

        /* Custom Message Box */
        #message-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            font-size: 1.2em;
            max-width: 80%;
        }

        /* Confirmation Modal */
        #confirmation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; /* Higher than other popups */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #confirmation-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .confirmation-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            width: 350px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            color: var(--color-text);
        }

        #confirmation-modal.active .confirmation-content {
            transform: scale(1);
        }

        .confirmation-content p {
            font-size: 1.2em;
            margin-bottom: 25px;
        }

        .confirmation-buttons {
            display: flex;
            justify-content: space-around;
            gap: 15px;
        }

        .confirmation-buttons button {
            background-color: var(--color-button);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            flex: 1;
        }

        .confirmation-buttons button.cancel-btn {
            background-color: #6c757d;
        }
        .confirmation-buttons button.confirm-btn:hover {
            background-color: var(--color-button-hover);
        }
        .confirmation-buttons button.cancel-btn:hover {
            background-color: #5a6268;
        }

        /* New Game Button Styling */
        #new-game-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: #FF5722; /* Orange pour "Nouvelle Partie" */
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            z-index: 60;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
        }

        #new-game-button:hover {
            background-color: #E64A19; /* Orange plus fonc√© au survol */
        }

    </style>
</head>
<body>

    <!-- √âcran de D√©marrage -->
    <div id="start-screen">
        <h1>Le Jeu des Amoureux</h1>
        <label for="player1-name">Pr√©nom de Monsieur :</label>
        <input type="text" id="player1-name" placeholder="Ex: Jean">

        <div class="emoji-selection">
            <label>Choisissez l'emoji de Monsieur :</label>
            <div id="male-emoji-options" class="emoji-options">
                <!-- Emojis pour homme g√©n√©r√©s par JS -->
            </div>
        </div>

        <label for="player1-clothes">Nombre de v√™tements de Monsieur :</label>
        <input type="number" id="player1-clothes" min="0" value="3">
        <label for="player1-underwear">Nombre de sous-v√™tements de Monsieur :</label>
        <input type="number" id="player1-underwear" min="0" value="1">

        <label for="player2-name">Pr√©nom de Madame :</label>
        <input type="text" id="player2-name" placeholder="Ex: Sophie">

        <div class="emoji-selection">
            <label>Choisissez l'emoji de Madame :</label>
            <div id="female-emoji-options" class="emoji-options">
                <!-- Emojis pour femme g√©n√©r√©s par JS -->
            </div>
        </div>

        <label for="player2-clothes">Nombre de v√™tements de Madame :</label>
        <input type="number" id="player2-clothes" min="0" value="3">
        <label for="player2-underwear">Nombre de sous-v√™tements de Madame :</label>
        <input type="number" id="player2-underwear" min="0" value="1">

        <button id="start-game-button">Commencer le jeu !</button>
        <button id="admin-mode-button">Mode Administrateur</button>
        <div id="loading-indicator">Chargement du jeu...</div>
    </div>

    <!-- √âcran de Jeu -->
    <div id="game-screen">
        <div id="current-player-indicator">Au tour de : <span id="current-player-name"></span></div>

        <!-- Bouton Nouvelle Partie -->
        <button id="new-game-button">Nouvelle Partie</button>

        <!-- Bouton pour afficher/masquer les contr√¥les de d√©bogage -->
        <button id="toggle-debug-button">D√©bogage</button>

        <!-- Panneau de contr√¥les de d√©bogage -->
        <div id="debug-controls">
            <label for="target-square-input">Aller √† la case :</label>
            <input type="number" id="target-square-input" min="1" max="69" value="1">
            <button id="manual-move-button">D√©placer √† la case</button>
        </div>

        <div id="game-board-container">
            <!-- Les cases seront g√©n√©r√©es ici par JavaScript -->
            <!-- Les pions utilisent maintenant les emojis choisis -->
            <div id="player1-token" class="player-token male"></div>
            <div id="player2-token" class="player-token female"></div>
        </div>

        <div id="dice-area">
            <!-- Nouveau d√© visuel -->
            <div id="dice-container">
                <span class="dot top-left"></span>
                <span class="dot top-right"></span>
                <span class="dot middle-left"></span>
                <span class="dot center"></span>
                <span class="dot middle-right"></span>
                <span class="dot bottom-left"></span>
                <span class="dot bottom-right"></span>
            </div>
            <button id="roll-dice-button">Lancer le d√© !</button>
        </div>
    </div>

    <!-- Pop-up de Gage -->
    <div id="gag-popup">
        <div class="gag-content">
            <h2 id="gag-title">D√©fi Coquin !</h2>
            <img id="gag-image" src="" alt="Image du gage" class="gag-image" onerror="this.style.display='none'">
            <p id="gag-text"></p>
            <button id="gag-done-button">Gage termin√© !</button>
        </div>
    </div>

    <!-- Pop-up de Victoire -->
    <div id="victory-popup">
        <div class="gag-content">
            <h2 id="victory-title">F√©licitations !</h2>
            <p id="victory-message"></p>
            <button id="restart-game-button">Recommencer une nouvelle partie</button>
            <button id="end-session-button">Terminer la session</button>
        </div>
    </div>

    <!-- Admin Mode Popup (Login) -->
    <div id="admin-popup">
        <div class="admin-content">
            <h2>Mode Administrateur</h2>
            <p>Veuillez entrer le mot de passe administrateur.</p>
            <input type="password" id="admin-password-input" placeholder="Mot de passe">
            <button id="admin-login-button">Se connecter</button>
            <button id="admin-close-button">Fermer</button>
            <!-- Admin Panel Content (visible apr√®s connexion) -->
            <div id="admin-panel-content">
                <h3>Gestion des Gages</h3>
                <div id="gages-list-container">
                    <!-- Les gages seront affich√©s ici -->
                </div>
                <button id="add-gage-button-main">Ajouter un nouveau Gage</button>
            </div>
        </div>
    </div>

    <!-- Gage Form Popup (Add/Edit Gage) -->
    <div id="gage-form-popup">
        <div class="gage-form-content">
            <h2 id="gage-form-title">Ajouter un Gage</h2>
            <form id="gage-form">
                <input type="hidden" id="gage-id-input"> <!-- Pour stocker l'ID du gage en modification -->

                <label for="gage-title-input">Titre du Gage :</label>
                <input type="text" id="gage-title-input" required>

                <label for="gage-text-input">Texte du Gage :</label>
                <textarea id="gage-text-input" rows="4" required></textarea>

                <label for="gage-category-select">Cat√©gorie :</label>
                <select id="gage-category-select" required>
                    <option value="">S√©lectionner une cat√©gorie</option>
                    <option value="action">Action</option>
                    <option value="undress">D√©shabillage</option>
                    <option value="truth_dare">V√©rit√© ou Ose</option>
                    <option value="massage_sensory">Massage / Sensoriel</option>
                    <option value="role_play">Jeu de R√¥le</option>
                    <option value="sexual_positions">Positions Sexuelles</option>
                    <option value="go_back">Retour en arri√®re</option>
                    <option value="surprise">Surprise (m√™me case)</option>
                    <option value="final_gage">Gage Final</option>
                    <option value="vestiaire">Vestiaire</option>
                </select>

                <div id="conditional-fields">
                    <label for="gage-level-input" id="gage-level-label" style="display: none;">Niveau (1-4) :</label>
                    <input type="number" id="gage-level-input" min="1" max="4" style="display: none;">

                    <label for="gage-type-select" id="gage-type-label" style="display: none;">Type (D√©shabillage) :</label>
                    <select id="gage-type-select" style="display: none;">
                        <option value="clothes">V√™tements</option>
                        <option value="underwear">Sous-v√™tements</option>
                    </select>
                </div>

                <label for="gage-duration-input">Dur√©e estim√©e :</label>
                <input type="text" id="gage-duration-input" placeholder="Ex: 30s, 1min">

                <label for="gage-accessories-input">Accessoires (s√©par√©s par des virgules) :</label>
                <input type="text" id="gage-accessories-input" placeholder="Ex: Plume, Huile de massage">

                <label for="gage-image-url-input">URL de l'image :</label>
                <input type="url" id="gage-image-url-input" placeholder="https://example.com/image.jpg">

                <div class="gage-form-buttons">
                    <button type="submit" class="save-button">Sauvegarder</button>
                    <button type="button" class="cancel-button" id="cancel-gage-form-button">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="message-box"></div>

    <!-- Confirmation Modal (New) -->
    <div id="confirmation-modal">
        <div class="confirmation-content">
            <p id="confirmation-message"></p>
            <div class="confirmation-buttons">
                <button id="confirm-yes-button" class="confirm-btn">Oui</button>
                <button id="confirm-no-button" class="cancel-btn">Non</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importe les fonctions n√©cessaires de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURATION FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDXxfz5VdNiInngWzn3wtKVDJlBBz0272U",
            authDomain: "jeuoiecoquin.firebaseapp.com",
            projectId: "jeuoiecoquin",
            storageBucket: "jeuoiecoquin.firebasestorage.app",
            messagingSenderId: "642698244266",
            appId: "1:642698244266:web:5c7a7e041b6be50bd7a0d3"
        };

        const appId = firebaseConfig.projectId || 'default-app-id';

        console.log("[Firebase Config] Parsed firebaseConfig:", firebaseConfig);
        console.log("[Firebase Config] Using appId:", appId);

        if (!firebaseConfig || Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey || firebaseConfig.apiKey === "VOTRE_API_KEY") {
            console.error("[Firebase Config] Erreur: La configuration Firebase est manquante ou la cl√© API n'est pas d√©finie. Si tu ex√©cutes ce fichier localement, assure-toi d'avoir remplac√© les valeurs par d√©faut dans 'firebaseConfig'.");
            document.addEventListener('DOMContentLoaded', () => {
                showMessage("Erreur de configuration Firebase: Cl√© API manquante ou incorrecte. Le jeu ne pourra pas sauvegarder la progression. Si tu es en local, mets √† jour 'firebaseConfig' dans le code.");
                const startGameButton = document.getElementById('start-game-button');
                const adminModeButton = document.getElementById('admin-mode-button');
                if (startGameButton) startGameButton.disabled = true;
                if (adminModeButton) adminModeButton.disabled = true;
            });
        }

        let app;
        let auth;
        let db;
        if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey !== "VOTRE_API_KEY") {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } else {
            console.warn("[Firebase Init] Firebase ne sera pas initialis√© car la configuration est invalide ou manquante. La sauvegarde ne fonctionnera pas.");
        }

        // Variables globales pour Firebase
        let userId = null;
        let gameDocRef = null;

        // Constantes du jeu
        const totalOriginalCases = 69;
        const numVestiaireCases = 2;
        const startCaseIndex = 0;
        const finalCaseArrayIndex = totalOriginalCases + numVestiaireCases;
        const totalBoardCases = finalCaseArrayIndex + 1;

        const vestiaire1Index = 31;
        const vestiaire2Index = 62;
        const sexualPositionsStartCase = 63;

        // Variables d'√©tat du jeu
        let player1Name = '';
        let player2Name = '';
        let currentPlayer = 1;
        let player1Position = startCaseIndex;
        let player2Position = startCaseIndex;
        let player1Clothes = 0;
        let player1Underwear = 0;
        let player2Clothes = 0;
        let player2Underwear = 0;

        let gameReady = false;
        let isMoving = false;

        let selectedMaleEmoji = 'üé©';
        let selectedFemaleEmoji = 'üíã';

        let goBackCases = [];
        let undressCases = [];
        let actionCases = [];
        let truthOrDareCases = [];
        let massageSensoryCases = [];
        let rolePlayCases = [];

        let resolveGagPromise = null;
        let resolveVictoryPromise = null;
        let resolveConfirmationPromise = null; // Nouvelle variable pour la promesse de confirmation

        // --- Donn√©es de Gages (charg√©es depuis Firestore) ---
        let allGagesData = {}; // Objet pour stocker tous les gages par cat√©gorie, avec ID unique
        let goBackGagesData = [];
        let surpriseGagesData = [];
        let actionGagesData = [];
        let undressGagesData = [];
        let truthOrDareGagesData = [];
        let massageSensoryGagesData = [];
        let rolePlayGagesData = [];
        let sexualPositionsGagesData = [];
        let finalGageData = [];
        let vestiaireGagesData = {};

        // R√©f√©rences aux √©l√©ments DOM
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const player1NameInput = document.getElementById('player1-name');
        const player2NameInput = document.getElementById('player2-name');
        const player1ClothesInput = document.getElementById('player1-clothes');
        const player1UnderwearInput = document.getElementById('player1-underwear');
        const player2ClothesInput = document.getElementById('player2-clothes');
        const player2UnderwearInput = document.getElementById('player2-underwear');
        const startGameButton = document.getElementById('start-game-button');
        const maleEmojiOptionsDiv = document.getElementById('male-emoji-options');
        const femaleEmojiOptionsDiv = document.getElementById('female-emoji-options');
        const gameBoardContainer = document.getElementById('game-board-container');
        const player1Token = document.getElementById('player1-token');
        const player2Token = document.getElementById('player2-token');
        const rollDiceButton = document.getElementById('roll-dice-button');
        const diceContainer = document.getElementById('dice-container');
        const gagPopup = document.getElementById('gag-popup');
        const gagTitle = document.getElementById('gag-title');
        const gagText = document.getElementById('gag-text');
        const gagImage = document.getElementById('gag-image');
        const gagDoneButton = document.getElementById('gag-done-button');
        const currentPlayerNameDisplay = document.getElementById('current-player-name');
        const loadingIndicator = document.getElementById('loading-indicator');
        const diceArea = document.getElementById('dice-area');

        const toggleDebugButton = document.getElementById('toggle-debug-button');
        const debugControls = document.getElementById('debug-controls');
        const targetSquareInput = document.getElementById('target-square-input');
        const manualMoveButton = document.getElementById('manual-move-button');

        const victoryPopup = document.getElementById('victory-popup');
        const victoryTitle = document.getElementById('victory-title');
        const victoryMessage = document.getElementById('victory-message');
        const restartGameButton = document.getElementById('restart-game-button');
        const endSessionButton = document.getElementById('end-session-button');

        const adminModeButton = document.getElementById('admin-mode-button');
        const adminPopup = document.getElementById('admin-popup');
        const adminPasswordInput = document.getElementById('admin-password-input');
        const adminLoginButton = document.getElementById('admin-login-button');
        const adminCloseButton = document.getElementById('admin-close-button');
        const adminPanelContent = document.getElementById('admin-panel-content');
        const addGageButtonMain = document.getElementById('add-gage-button-main');
        const gagesListContainer = document.getElementById('gages-list-container');

        const gageFormPopup = document.getElementById('gage-form-popup');
        const gageFormTitle = document.getElementById('gage-form-title');
        const gageForm = document.getElementById('gage-form');
        const gageIdInput = document.getElementById('gage-id-input');
        const gageTitleInput = document.getElementById('gage-title-input');
        const gageTextInput = document.getElementById('gage-text-input');
        const gageCategorySelect = document.getElementById('gage-category-select');
        const gageLevelLabel = document.getElementById('gage-level-label');
        const gageLevelInput = document.getElementById('gage-level-input');
        const gageTypeLabel = document.getElementById('gage-type-label');
        const gageTypeSelect = document.getElementById('gage-type-select');
        const gageDurationInput = document.getElementById('gage-duration-input');
        const gageAccessoriesInput = document.getElementById('gage-accessories-input');
        const gageImageUrlInput = document.getElementById('gage-image-url-input');
        const cancelGageFormButton = document.getElementById('cancel-gage-form-button');
        const conditionalFields = document.getElementById('conditional-fields');

        const messageBox = document.getElementById('message-box');

        // Nouvelles r√©f√©rences pour la modale de confirmation
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmYesButton = document.getElementById('confirm-yes-button');
        const confirmNoButton = document.getElementById('confirm-no-button');

        // Nouveau bouton "Nouvelle Partie"
        const newGameButton = document.getElementById('new-game-button');


        const diceDots = {
            'top-left': document.querySelector('#dice-container .top-left'),
            'top-right': document.querySelector('#dice-container .top-right'),
            'middle-left': document.querySelector('#dice-container .middle-left'),
            'center': document.querySelector('#dice-container .center'),
            'middle-right': document.querySelector('#dice-container .middle-right'),
            'bottom-left': document.querySelector('#dice-container .bottom-left'),
            'bottom-right': document.querySelector('#dice-container .bottom-right')
        };


        const maleEmojis = ['üé©', 'ü§µ', 'üî•', 'üï∫', 'üí™', 'üëë'];
        const femaleEmojis = ['üíã', 'üë†', 'üíÉ', '‚ù§Ô∏è', 'üíÖ', 'üë∏'];


        // --- Fonctions utilitaires ---

        /**
         * G√©n√®re un ID unique simple.
         * @returns {string} Un ID unique.
         */
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        /**
         * Affiche un message personnalis√© dans une bo√Æte temporaire.
         * Remplace les alertes natives du navigateur.
         * @param {string} message - Le message √† afficher.
         * @param {number} duration - La dur√©e d'affichage du message en ms.
         */
        function showMessage(message, duration = 3000) {
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }

        /**
         * Affiche une modale de confirmation personnalis√©e.
         * @param {string} message - Le message √† afficher dans la modale.
         * @returns {Promise<boolean>} Une promesse qui se r√©sout √† true si l'utilisateur confirme, false sinon.
         */
        function showConfirmation(message) {
            return new Promise(resolve => {
                confirmationMessage.textContent = message;
                confirmationModal.style.display = 'flex';
                setTimeout(() => confirmationModal.classList.add('active'), 10);

                // G√®re les clics sur les boutons de la modale
                const handleConfirm = () => {
                    confirmationModal.classList.remove('active');
                    setTimeout(() => confirmationModal.style.display = 'none', 300);
                    confirmYesButton.removeEventListener('click', handleConfirm);
                    confirmNoButton.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    confirmationModal.classList.remove('active');
                    setTimeout(() => confirmationModal.style.display = 'none', 300);
                    confirmYesButton.removeEventListener('click', handleConfirm);
                    confirmNoButton.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                confirmYesButton.addEventListener('click', handleConfirm);
                confirmNoButton.addEventListener('click', handleCancel);
            });
        }

        /**
         * Initialise les options d'emojis pour un joueur donn√©.
         * @param {HTMLElement} container - Le conteneur DOM pour les options d'emojis.
         * @param {Array<string>} emojis - La liste des emojis √† afficher.
         * @param {string} playerType - 'male' ou 'female'.
         */
        function initializeEmojiOptions(container, emojis, playerType) {
            console.log(`[initializeEmojiOptions] D√©but pour ${playerType}. Conteneur:`, container);
            if (!container) {
                console.error(`[initializeEmojiOptions] Erreur: Conteneur d'emojis non trouv√© pour ${playerType}.`);
                return;
            }
            container.innerHTML = '';
            emojis.forEach(emoji => {
                const emojiDiv = document.createElement('div');
                emojiDiv.classList.add('emoji-option');
                emojiDiv.textContent = emoji;
                emojiDiv.dataset.emoji = emoji;

                if ((playerType === 'male' && emoji === selectedMaleEmoji) ||
                    (playerType === 'female' && emoji === selectedFemaleEmoji)) {
                    emojiDiv.classList.add('selected');
                }

                emojiDiv.addEventListener('click', () => {
                    const currentSelected = container.querySelector('.emoji-option.selected');
                    if (currentSelected) {
                        currentSelected.classList.remove('selected');
                    }
                    emojiDiv.classList.add('selected');
                    if (playerType === 'male') {
                        selectedMaleEmoji = emoji;
                    } else {
                        selectedFemaleEmoji = emoji;
                    }
                    console.log(`[initializeEmojiOptions] Emoji s√©lectionn√© pour ${playerType}: ${emoji}`);
                });
                container.appendChild(emojiDiv);
            });
            console.log(`[initializeEmojiOptions] Emojis initialis√©s pour ${playerType}. Nombre d'options: ${container.children.length}`);
        }

        /**
         * S√©lectionne al√©atoirement des cases uniques pour les cat√©gories sp√©ciales.
         * @param {number} count - Le nombre de cases √† s√©lectionner.
         * @param {Array<number>} availableIndices - La liste des index de cases disponibles.
         * @param {Array<number>} selectedIndices - Le tableau o√π stocker les index s√©lectionn√©s.
         */
        function assignRandomUniqueCases(count, availableIndices, selectedIndices) {
            for (let i = 0; i < count; i++) {
                if (availableIndices.length === 0) {
                    console.warn(`Pas assez de cases disponibles pour assigner ${count - i} cases.`);
                    break;
                }
                const randomIndex = Math.floor(Math.random() * availableIndices.length);
                const caseIndex = availableIndices[randomIndex];
                selectedIndices.push(caseIndex);
                availableIndices.splice(randomIndex, 1);
            }
        }

        /**
         * Convertit un index de tableau de case en son num√©ro de case visuel (1 √† 69).
         * G√®re la case de d√©part et les vestiaires qui ne sont pas num√©rot√©s.
         * @param {number} arrayIndex - L'index de la case dans le tableau.
         * @returns {number} Le num√©ro de case visuel (1-69) ou 0 pour la case de d√©part, ou un float pour les vestiaires.
         */
        function getVisualCaseNumber(arrayIndex) {
            if (arrayIndex === startCaseIndex) return 0;
            if (arrayIndex === vestiaire1Index) return 30.5;
            if (arrayIndex === vestiaire2Index) return 60.5;

            let visualNumber = arrayIndex;
            if (arrayIndex > vestiaire2Index) {
                visualNumber -= numVestiaireCases;
            } else if (arrayIndex > vestiaire1Index) {
                visualNumber -= 1;
            }
            visualNumber -= 0;

            return visualNumber;
        }


        /**
         * G√©n√®re dynamiquement les cases du plateau de jeu et leur applique les styles de niveau.
         */
        function createBoard() {
            console.log("[createBoard] Cr√©ation du plateau de jeu...");
            gameBoardContainer.innerHTML = '';

            gameBoardContainer.appendChild(player1Token);
            gameBoardContainer.appendChild(player2Token);

            goBackCases = [];
            undressCases = [];
            actionCases = [];
            truthOrDareCases = [];
            massageSensoryCases = [];
            rolePlayCases = [];

            const levelRangesForRandomAssignment = [
                { startIdx: 1, endIdx: 15, level: 1, goBack: 1, undress: 2, action: 3, truthDare: 5, massage: 4, rolePlay: 0 },
                { startIdx: 16, endIdx: 30, level: 2, goBack: 1, undress: 2, action: 3, truthDare: 4, massage: 3, rolePlay: 2 },
                { startIdx: 32, endIdx: 46, level: 3, goBack: 1, undress: 2, action: 3, truthDare: 3, massage: 3, rolePlay: 3 },
                { startIdx: 47, endIdx: 61, level: 4, goBack: 1, undress: 2, action: 3, truthDare: 3, massage: 3, rolePlay: 3 }
            ];

            levelRangesForRandomAssignment.forEach(range => {
                let currentAvailable = [];
                for (let i = range.startIdx; i <= range.endIdx; i++) {
                    if (i !== vestiaire1Index && i !== vestiaire2Index && i !== startCaseIndex && i !== finalCaseArrayIndex) {
                        currentAvailable.push(i);
                    }
                }
                assignRandomUniqueCases(range.goBack, currentAvailable, goBackCases);
                assignRandomUniqueCases(range.undress, currentAvailable, undressCases);
                assignRandomUniqueCases(range.action, currentAvailable, actionCases);
                assignRandomUniqueCases(range.truthDare, currentAvailable, truthOrDareCases);
                assignRandomUniqueCases(range.massage, currentAvailable, massageSensoryCases);
                assignRandomUniqueCases(range.rolePlay, currentAvailable, rolePlayCases);
            });


            let currentNumberedCaseCount = 0;
            for (let i = 0; i < totalBoardCases; i++) {
                const caseDiv = document.createElement('div');
                caseDiv.classList.add('case');
                caseDiv.dataset.caseIndex = i;

                if (i === startCaseIndex) {
                    caseDiv.classList.add('start-case');
                    caseDiv.textContent = "D√©part";
                } else if (i === vestiaire1Index) {
                    caseDiv.classList.add('vestiaire-case');
                    addEmojiToCase(caseDiv, 'üíÉ', 'vestiaire-icon');
                    const textSpan = document.createElement('span');
                    textSpan.textContent = "Vestiaire";
                    caseDiv.appendChild(textSpan);
                } else if (i === vestiaire2Index) {
                    caseDiv.classList.add('vestiaire-case');
                    addEmojiToCase(caseDiv, 'üòâ', 'vestiaire-icon');
                    const textSpan = document.createElement('span');
                    textSpan.textContent = "Vestiaire";
                    caseDiv.appendChild(textSpan);
                } else if (i === finalCaseArrayIndex) {
                    caseDiv.textContent = "Arriv√©e üèÅ"; // Ajout du drapeau √† damier
                    caseDiv.classList.add('level-5');
                }
                else {
                    currentNumberedCaseCount++;
                    caseDiv.textContent = currentNumberedCaseCount;

                    const visualCaseNum = currentNumberedCaseCount;
                    if (visualCaseNum >= 1 && visualCaseNum <= 15) {
                        caseDiv.classList.add('level-1');
                    } else if (visualCaseNum >= 16 && visualCaseNum <= 30) {
                        caseDiv.classList.add('level-2');
                    } else if (visualCaseNum >= 31 && visualCaseNum <= 45) {
                        caseDiv.classList.add('level-3');
                    } else if (visualCaseNum >= 46 && visualCaseNum <= 60) {
                        caseDiv.classList.add('level-4');
                    } else if (visualCaseNum >= 61 && visualCaseNum <= 69) {
                        caseDiv.classList.add('level-5');
                        caseDiv.classList.add('sexual-position-case');
                        addEmojiToCase(caseDiv, 'üî•', 'sexual-position-emoji');
                    }

                    if (goBackCases.includes(i)) {
                        caseDiv.classList.add('go-back-case');
                        addEmojiToCase(caseDiv, '‚Ü©Ô∏è', 'go-back-emoji');
                    }
                    if (undressCases.includes(i)) {
                        caseDiv.classList.add('undress-case');
                        addEmojiToCase(caseDiv, 'üëó', 'undress-emoji');
                    }
                    if (actionCases.includes(i)) {
                        caseDiv.classList.add('action-case');
                        addEmojiToCase(caseDiv, '‚ö°', 'action-emoji');
                    }
                    if (truthOrDareCases.includes(i)) {
                        caseDiv.classList.add('truth-dare-case');
                        addEmojiToCase(caseDiv, '‚ùì', 'truth-dare-emoji');
                    }
                    if (massageSensoryCases.includes(i)) {
                        caseDiv.classList.add('massage-sensory-case');
                        addEmojiToCase(caseDiv, 'üñêÔ∏è', 'massage-sensory-emoji');
                    }
                    if (rolePlayCases.includes(i)) {
                        caseDiv.classList.add('role-play-case');
                        addEmojiToCase(caseDiv, 'üé≠', 'role-play-emoji');
                    }
                }
                gameBoardContainer.appendChild(caseDiv);
            }
            updatePlayerTokenPositions(player1Token, player1Position);
            updatePlayerTokenPositions(player2Token, player2Position);
            scrollBoardToPlayers();
            console.log("[createBoard] Plateau de jeu cr√©√©.");
        }

        /**
         * Ajoute un √©l√©ment emoji √† une case.
         * @param {HTMLElement} caseDiv - L'√©l√©ment DIV de la case.
         * @param {string} emojiChar - Le caract√®re emoji.
         * @param {string} className - La classe CSS √† ajouter au span de l'emoji.
         */
        function addEmojiToCase(caseDiv, emojiChar, className) {
            const emojiSpan = document.createElement('span');
            emojiSpan.classList.add('emoji-icon', className);
            emojiSpan.textContent = emojiChar;
            caseDiv.appendChild(emojiSpan);
        }

        /**
         * Met √† jour la position visuelle d'un pion sur le plateau.
         * @param {HTMLElement} tokenElement - L'√©l√©ment DOM du pion (player1Token ou player2Token).
         * @param {number} position - La nouvelle position (index de la case).
         */
        function updatePlayerTokenPositions(tokenElement, position) {
            const caseElement = document.querySelector(`.case[data-case-index="${position}"]`);
            if (caseElement) {
                tokenElement.style.left = `${caseElement.offsetLeft + (caseElement.offsetWidth / 2) - (tokenElement.offsetWidth / 2)}px`;
            }

            if (player1Position === player2Position && player1Position !== startCaseIndex) {
                player1Token.classList.add('on-same-case');
                player2Token.classList.add('on-same-case');
            } else {
                player1Token.classList.remove('on-same-case');
                player2Token.classList.remove('on-same-case');
            }
        }

        /**
         * Fait d√©filer le conteneur du plateau pour centrer la vue sur le joueur actif.
         */
        function scrollBoardToPlayers() {
            const currentPositionIndex = currentPlayer === 1 ? player1Position : player2Position;
            const caseElement = document.querySelector(`.case[data-case-index="${currentPositionIndex}"]`);

            if (caseElement) {
                const targetScrollLeft = caseElement.offsetLeft - (gameBoardContainer.offsetWidth / 2) + (caseElement.offsetWidth / 2);

                gameBoardContainer.scrollTo({
                    left: targetScrollLeft,
                    behavior: 'smooth'
                });
            }
        }

        /**
         * Anime le d√©placement d'un pion case par case. Retourne une Promesse.
         * @param {HTMLElement} tokenElement - Le pion √† animer.
         * @param {number} startPos - Position de d√©part (index de la case).
         * @param {number} endPos - Position d'arriv√©e (index de la case).
         * @returns {Promise<void>} Une promesse qui se r√©sout une fois l'animation termin√©e.
         */
        function animatePlayerMovement(tokenElement, startPos, endPos) {
            return new Promise(resolve => {
                let currentPos = startPos;
                const stepDuration = 200;

                const moveStep = () => {
                    if (currentPos === endPos) {
                        resolve();
                        return;
                    }

                    const direction = (endPos > currentPos) ? 1 : -1;
                    currentPos += direction;

                    updatePlayerTokenPositions(tokenElement, currentPos);
                    scrollBoardToPlayers();

                    setTimeout(moveStep, stepDuration);
                };

                moveStep();
            });
        }

        /**
         * Affiche la face du d√© avec les points correspondants au nombre.
         * @param {number} number - Le nombre √† afficher sur le d√© (1-6).
         */
        function displayDiceFace(number) {
            Object.values(diceDots).forEach(dot => {
                if (dot) dot.style.opacity = '0';
            });

            switch (number) {
                case 1:
                    if (diceDots.center) diceDots.center.style.opacity = '1';
                    break;
                case 2:
                    if (diceDots['top-left']) diceDots['top-left'].style.opacity = '1';
                    if (diceDots['bottom-right']) diceDots['bottom-right'].style.opacity = '1';
                    break;
                case 3:
                    if (diceDots['top-left']) diceDots['top-left'].style.opacity = '1';
                    if (diceDots.center) diceDots.center.style.opacity = '1';
                    if (diceDots['bottom-right']) diceDots['bottom-right'].style.opacity = '1';
                    break;
                case 4:
                    if (diceDots['top-left']) diceDots['top-left'].style.opacity = '1';
                    if (diceDots['top-right']) diceDots['top-right'].style.opacity = '1';
                    if (diceDots['bottom-left']) diceDots['bottom-left'].style.opacity = '1';
                    if (diceDots['bottom-right']) diceDots['bottom-right'].style.opacity = '1';
                    break;
                case 5:
                    if (diceDots['top-left']) diceDots['top-left'].style.opacity = '1';
                    if (diceDots['top-right']) diceDots['top-right'].style.opacity = '1';
                    if (diceDots.center) diceDots.center.style.opacity = '1';
                    if (diceDots['bottom-left']) diceDots['bottom-left'].style.opacity = '1';
                    if (diceDots['bottom-right']) diceDots['bottom-right'].style.opacity = '1';
                    break;
                case 6:
                    if (diceDots['top-left']) diceDots['top-left'].style.opacity = '1';
                    if (diceDots['top-right']) diceDots['top-right'].style.opacity = '1';
                    if (diceDots['middle-left']) diceDots['middle-left'].style.opacity = '1';
                    if (diceDots['middle-right']) diceDots['middle-right'].style.opacity = '1';
                    if (diceDots['bottom-left']) diceDots['bottom-left'].style.opacity = '1';
                    if (diceDots['bottom-right']) diceDots['bottom-right'].style.opacity = '1';
                    break;
            }
        }


        /**
         * Affiche la pop-up de gage et retourne une promesse qui se r√©sout quand le gage est "termin√©".
         * @param {object} gage - L'objet gage contenant title, text, duration, accessories, imageUrl.
         * @returns {Promise<void>} Une promesse qui se r√©sout lorsque le bouton "Gage termin√©" est cliqu√©.
         */
        function showGag(gage) {
            return new Promise(resolve => {
                gagTitle.textContent = gage.title;
                let fullText = gage.text;
                if (gage.duration) {
                    fullText += `<br><br>Dur√©e estim√©e : ${gage.duration}`;
                }
                if (gage.accessories && gage.accessories.length > 0) {
                    fullText += `<br>Accessoires : ${gage.accessories.join(', ')}`;
                }
                gagText.innerHTML = fullText;

                if (gage.imageUrl) {
                    gagImage.src = gage.imageUrl;
                    gagImage.style.display = 'block';
                } else {
                    gagImage.style.display = 'none';
                }

                gagPopup.style.display = 'flex';
                setTimeout(() => gagPopup.classList.add('active'), 10);

                resolveGagPromise = resolve;
            });
        }

        /**
         * Cache la pop-up de gage.
         */
        function hideGag() {
            gagPopup.classList.remove('active');
            setTimeout(() => gagPopup.style.display = 'none', 300);
            gagImage.src = '';
            if (resolveGagPromise) {
                resolveGagPromise();
                resolveGagPromise = null;
            }
        }

        /**
         * Affiche la pop-up de victoire.
         * @param {string} winnerName - Le nom du joueur gagnant.
         * @returns {Promise<void>} Une promesse qui se r√©sout lorsque le bouton de victoire est cliqu√©.
         */
        function showVictoryScreen(winnerName) {
            return new Promise(resolve => {
                victoryTitle.textContent = `F√©licitations ${winnerName} !`;
                victoryMessage.textContent = `Tu as atteint la case ${totalOriginalCases} et remport√© le Jeu des Amoureux !`;

                victoryPopup.style.display = 'flex';
                setTimeout(() => victoryPopup.classList.add('active'), 10);

                resolveVictoryPromise = resolve;
            });
        }

        /**
         * Cache la pop-up de victoire.
         */
        function hideVictoryScreen() {
            victoryPopup.classList.remove('active');
            setTimeout(() => victoryPopup.style.display = 'none', 300);
            if (resolveVictoryPromise) {
                resolveVictoryPromise();
                resolveVictoryPromise = null;
            }
        }


        /**
         * Change l'ambiance visuelle du body en fonction du niveau atteint par les joueurs.
         * @param {number} position - La position la plus avanc√©e des joueurs (index du tableau).
         */
        function updateGameAmbiance(position) {
            let level = 1;
            const visualPosition = getVisualCaseNumber(position);

            if (visualPosition >= 61) {
                level = 5;
            } else if (visualPosition >= 46) {
                level = 4;
            } else if (visualPosition >= 31) {
                level = 3;
            } else if (visualPosition >= 16) {
                level = 2;
            } else {
                level = 1;
            }
            document.body.style.backgroundColor = `var(--color-background-level${level})`;
        }

        /**
         * S√©lectionne un gage al√©atoire d'une cat√©gorie donn√©e.
         * @param {Array<object>} gageArray - Le tableau de gages de la cat√©gorie.
         * @param {number} currentVisualPosition - La position visuelle du joueur (pour les gages de niveau).
         * @returns {object} Le gage s√©lectionn√©.
         */
        function getRandomGage(gageArray, currentVisualPosition = -1) {
            let filtered = gageArray;
            if (currentVisualPosition !== -1) {
                let currentLevel = 1;
                if (currentVisualPosition >= 61) {
                    currentLevel = 5;
                } else if (currentVisualPosition >= 46) {
                    currentLevel = 4;
                } else if (currentVisualPosition >= 31) {
                    currentLevel = 3;
                } else if (currentVisualPosition >= 16) {
                    currentLevel = 2;
                } else {
                    currentLevel = 1;
                }

                if (gageArray.length > 0 && gageArray[0].hasOwnProperty('level')) {
                    filtered = gageArray.filter(gage => gage.level === currentLevel);
                }
            }

            if (filtered.length === 0) {
                console.warn(`Aucun gage trouv√© pour la cat√©gorie ou le niveau sp√©cifi√© (position visuelle: ${currentVisualPosition}, array length: ${gageArray.length}). Retourne un gage par d√©faut.`);
                return { title: "D√©fi G√©n√©ral !", text: "Un d√©fi inattendu pour vous deux !", duration: "", accessories: [], imageUrl: "" };
            }
            const randomIndex = Math.floor(Math.random() * filtered.length);
            return filtered[randomIndex];
        }


        /**
         * S√©lectionne un gage appropri√© en fonction de la position sur le plateau et du type de case.
         * @param {number} positionArrayIndex - L'index de la case d'arriv√©e dans le tableau.
         * @param {string} caseType - Le type de case ('normal', 'go-back', 'action', 'surprise', 'vestiaire-clothes', 'vestiaire-underwear', 'truth-dare', 'massage-sensory', 'role-play', 'sexual-position', 'final-gage').
         * @param {number} [stepsReceded=0] - Le nombre de cases recul√©es (pour les gages de retour).
         * @returns {object} Le gage s√©lectionn√©.
         */
        function getGage(positionArrayIndex, caseType, stepsReceded = 0) {
            let selectedGage;
            const currentPlayerName = currentPlayer === 1 ? player1Name : player2Name;
            const otherPlayerName = currentPlayer === 1 ? player2Name : player1Name;
            let playerClothesCount = currentPlayer === 1 ? player1Clothes : player2Clothes;
            let playerUnderwearCount = currentPlayer === 1 ? player1Underwear : player2Underwear;

            const visualPosition = getVisualCaseNumber(positionArrayIndex);

            if (caseType === 'final-gage') {
                selectedGage = getRandomGage(finalGageData, visualPosition);
            } else if (caseType === 'vestiaire-clothes') {
                selectedGage = vestiaireGagesData.clothes;
            } else if (caseType === 'vestiaire-underwear') {
                selectedGage = vestiaireGagesData.underwear;
            } else if (caseType === 'go-back') {
                selectedGage = getRandomGage(goBackGagesData, visualPosition);
                selectedGage.text = selectedGage.text.replace(/\[steps\]/g, stepsReceded);
            } else if (caseType === 'sexual-position') {
                selectedGage = getRandomGage(sexualPositionsGagesData, visualPosition);
            } else if (caseType === 'undress') {
                const isUnderwearLevel = visualPosition >= 31;

                if (playerClothesCount > 0) {
                    selectedGage = getRandomGage(undressGagesData.filter(g => g.type === 'clothes'), visualPosition);
                    if (currentPlayer === 1) player1Clothes--; else player2Clothes--;
                } else if (playerUnderwearCount > 0 && isUnderwearLevel) {
                    selectedGage = getRandomGage(undressGagesData.filter(g => g.type === 'underwear'), visualPosition);
                    if (currentPlayer === 1) player1Underwear--; else player2Underwear--;
                } else {
                    selectedGage = getRandomGage(actionGagesData, visualPosition);
                }
            } else if (caseType === 'action') {
                selectedGage = getRandomGage(actionGagesData, visualPosition);
            } else if (caseType === 'truth-dare') {
                selectedGage = getRandomGage(truthOrDareGagesData, visualPosition);
            } else if (caseType === 'massage-sensory') {
                selectedGage = getRandomGage(massageSensoryGagesData, visualPosition);
            } else if (caseType === 'role-play') {
                selectedGage = getRandomGage(rolePlayGagesData, visualPosition);
            } else if (caseType === 'surprise') {
                selectedGage = getRandomGage(surpriseGagesData, visualPosition);
            } else {
                console.warn("Type de case inconnu ou non g√©r√©. Retourne un gage par d√©faut.");
                selectedGage = { title: "D√©fi G√©n√©ral !", text: "Un d√©fi inattendu pour vous deux !", duration: "", accessories: [], imageUrl: "" };
            }

            let finalGageText = selectedGage.text
                .replace(/\[joueur\]/g, currentPlayerName)
                .replace(/\[autreJoueur\]/g, otherPlayerName);

            return {
                title: selectedGage.title,
                text: finalGageText,
                duration: selectedGage.duration,
                accessories: selectedGage.accessories,
                imageUrl: selectedGage.imageUrl
            };
        }

        /**
         * Met √† jour les classes de th√®me (bleu ou rose) en fonction du joueur actuel.
         */
        function updateTheme() {
            if (currentPlayer === 1) { // Joueur homme (th√®me bleu)
                currentPlayerNameDisplay.parentElement.classList.add('blue-theme');
                diceContainer.classList.add('blue-theme');
                diceArea.classList.add('blue-theme');
            } else { // Joueur femme (th√®me rose/par d√©faut)
                currentPlayerNameDisplay.parentElement.classList.remove('blue-theme');
                diceContainer.classList.remove('blue-theme');
                diceArea.classList.remove('blue-theme');
            }
        }


        /**
         * G√®re le tour d'un joueur, incluant le d√©placement, la gestion des gages et le changement de tour.
         * @param {number} potentialNewPosition - La position cible potentielle apr√®s le lancer de d√© (index du tableau).
         */
        async function handlePlayerTurn(potentialNewPosition) {
            if (isMoving) return;

            isMoving = true;
            rollDiceButton.disabled = true;
            manualMoveButton.disabled = true;

            try {
                let currentToken = currentPlayer === 1 ? player1Token : player2Token;
                let oldPosition = currentPlayer === 1 ? player1Position : player2Position;
                let playerPositionVariable = currentPlayer === 1 ? 'player1Position' : 'player2Position';

                let finalDestination = Math.min(finalCaseArrayIndex, potentialNewPosition);

                let stopAtVestiaire = null;
                if (oldPosition < vestiaire1Index && finalDestination >= vestiaire1Index) {
                    stopAtVestiaire = vestiaire1Index;
                }
                if (oldPosition < vestiaire2Index && finalDestination >= vestiaire2Index && (stopAtVestiaire === null || stopAtVestiaire < vestiaire2Index)) {
                    stopAtVestiaire = vestiaire2Index;
                }

                if (stopAtVestiaire !== null) {
                    const vestiaireType = stopAtVestiaire === vestiaire1Index ? 'vestiaire-clothes' : 'vestiaire-underwear';
                    const gage = getGage(stopAtVestiaire, vestiaireType);

                    if (currentPlayer === 1) player1Position = stopAtVestiaire; else player2Position = stopAtVestiaire;
                    await animatePlayerMovement(currentToken, oldPosition, stopAtVestiaire);
                    updateGameAmbiance(Math.max(player1Position, player2Position));

                    await showGag(gage);

                    currentPlayer = currentPlayer === 1 ? 2 : 1;
                    currentPlayerNameDisplay.textContent = currentPlayer === 1 ? player1Name : player2Name;
                    updateTheme();

                } else {
                    if (currentPlayer === 1) player1Position = finalDestination; else player2Position = finalDestination;
                    await animatePlayerMovement(currentToken, oldPosition, finalDestination);
                    updateGameAmbiance(Math.max(player1Position, player2Position));

                    let currentLandingPosition = finalDestination;
                    let caseTypeAtLanding = 'normal';
                    let stepsReceded = 0;

                    if (currentLandingPosition === finalCaseArrayIndex) {
                        caseTypeAtLanding = 'final-gage';
                    } else if (goBackCases.includes(currentLandingPosition)) {
                        caseTypeAtLanding = 'go-back';
                        stepsReceded = Math.floor(Math.random() * 6) + 1;
                    } else if (sexualPositionsStartCase <= currentLandingPosition && currentLandingPosition < finalCaseArrayIndex) {
                        caseTypeAtLanding = 'sexual-position';
                    } else if (undressCases.includes(currentLandingPosition)) {
                        caseTypeAtLanding = 'undress';
                    } else if (actionCases.includes(currentLandingPosition)) {
                        caseTypeAtLanding = 'action';
                    } else if (truthOrDareCases.includes(currentLandingPosition)) {
                        caseTypeAtLanding = 'truth-dare';
                    } else if (massageSensoryCases.includes(currentLandingPosition)) {
                        caseTypeAtLanding = 'massage-sensory';
                    } else if (rolePlayCases.includes(currentLandingPosition)) {
                        caseTypeAtLanding = 'role-play';
                    }

                    if (player1Position === player2Position && player1Position !== startCaseIndex && player1Position !== vestiaire1Index && player1Position !== vestiaire2Index) {
                        caseTypeAtLanding = 'surprise';
                    }

                    let gageToExecute = getGage(currentLandingPosition, caseTypeAtLanding, stepsReceded);
                    await showGag(gageToExecute);

                    if (caseTypeAtLanding === 'go-back') {
                        const recedeFromPosition = currentLandingPosition;
                        const recedeToPosition = Math.max(startCaseIndex, recedeFromPosition - stepsReceded);

                        if (currentPlayer === 1) player1Position = recedeToPosition; else player2Position = recedeToPosition;
                        await animatePlayerMovement(currentToken, recedeFromPosition, recedeToPosition);
                        updateGameAmbiance(Math.max(player1Position, player2Position));

                        let recededCaseType = 'normal';
                        if (recedeToPosition === finalCaseArrayIndex) {
                            recededCaseType = 'final-gage';
                        } else if (recedeToPosition === vestiaire1Index) {
                            recededCaseType = 'vestiaire-clothes';
                        } else if (recedeToPosition === vestiaire2Index) {
                            recededCaseType = 'vestiaire-underwear';
                        } else if (sexualPositionsStartCase <= recedeToPosition && recedeToPosition < finalCaseArrayIndex) {
                            recededCaseType = 'sexual-position';
                        } else if (undressCases.includes(recedeToPosition)) {
                            recededCaseType = 'undress';
                        } else if (actionCases.includes(recedeToPosition)) {
                            recededCaseType = 'action';
                        } else if (truthOrDareCases.includes(recedeToPosition)) {
                            recededCaseType = 'truth-dare';
                        } else if (massageSensoryCases.includes(recedeToPosition)) {
                            recededCaseType = 'massage-sensory';
                        } else if (rolePlayCases.includes(recedeToPosition)) {
                            recededCaseType = 'role-play';
                        }

                        if (player1Position === player2Position && player1Position !== startCaseIndex && player1Position !== vestiaire1Index && player1Position !== vestiaire2Index) {
                            recededCaseType = 'surprise';
                        }

                        if (recededCaseType !== 'normal' && recededCaseType !== 'go-back') {
                            let recededGage = getGage(recedeToPosition, recededCaseType);
                            await showGag(recededGage);
                        }
                    }

                    if (player1Position === finalCaseArrayIndex) {
                        await showVictoryScreen(player1Name);
                    } else if (player2Position === finalCaseArrayIndex) {
                        await showVictoryScreen(player2Name);
                    } else {
                        currentPlayer = currentPlayer === 1 ? 2 : 1;
                        currentPlayerNameDisplay.textContent = currentPlayer === 1 ? player1Name : player2Name;
                        updateTheme();
                    }
                }
            } catch (error) {
                console.error("Une erreur est survenue pendant le tour du joueur :", error);
            } finally {
                isMoving = false;
                rollDiceButton.disabled = false;
                manualMoveButton.disabled = false;
            }
        }

        /**
         * R√©initialise toutes les variables d'√©tat du jeu et revient √† l'√©cran de d√©marrage.
         */
        function resetGame() {
            console.log("[resetGame] R√©initialisation du jeu...");
            player1Position = startCaseIndex;
            player2Position = startCaseIndex;
            // R√©initialise les v√™tements/sous-v√™tements aux valeurs par d√©faut des inputs
            player1Clothes = parseInt(player1ClothesInput.value, 10);
            player1Underwear = parseInt(player1UnderwearInput.value, 10);
            player2Clothes = parseInt(player2ClothesInput.value, 10);
            player2Underwear = parseInt(player2UnderwearInput.value, 10);
            currentPlayer = 1;
            gameReady = false;
            isMoving = false;

            // Masque tous les √©crans de jeu et popups
            gameScreen.style.display = 'none';
            gagPopup.style.display = 'none';
            victoryPopup.style.display = 'none';
            debugControls.style.display = 'none';
            adminPopup.style.display = 'none';
            gageFormPopup.style.display = 'none'; // Cache le formulaire de gage aussi

            // Affiche l'√©cran de d√©marrage
            startScreen.style.display = 'flex';
            updateGameAmbiance(startCaseIndex); // R√©initialise l'ambiance au niveau de d√©part

            // R√©initialise les s√©lections d'emojis et les affiche
            initializeEmojiOptions(maleEmojiOptionsDiv, maleEmojis, 'male');
            initializeEmojiOptions(femaleEmojiOptionsDiv, femaleEmojis, 'female');

            displayDiceFace(1); // Affiche le d√© sur 1
            updateTheme(); // Met √† jour le th√®me pour le joueur 1
            console.log("[resetGame] Jeu r√©initialis√©.");
        }

        /**
         * Charge les donn√©es des gages depuis Firestore et met en place un listener en temps r√©el.
         */
        async function loadGagesFromFirestore() {
            if (!db) {
                console.error("[loadGagesFromFirestore] Firebase Firestore n'est pas initialis√©. Impossible de charger les gages.");
                showMessage("Erreur: Firebase non initialis√©. Impossible de charger les gages.");
                loadingIndicator.style.display = 'none';
                return;
            }

            console.log("[loadGagesFromFirestore] D√©but du chargement des gages depuis Firestore...");
            loadingIndicator.textContent = "Chargement des gages...";
            loadingIndicator.style.display = 'block';

            const gagesCollectionRef = collection(db, `artifacts/${appId}/public/data/gages`);

            // Utilisation de onSnapshot pour des mises √† jour en temps r√©el
            onSnapshot(gagesCollectionRef, async (querySnapshot) => {
                console.log("[onSnapshot] Changement d√©tect√© dans la collection 'gages'.");
                let gagesExist = false;
                allGagesData = {}; // R√©initialise l'objet global

                querySnapshot.forEach(docSnap => {
                    gagesExist = true;
                    const categoryId = docSnap.id;
                    const data = docSnap.data();

                    if (categoryId === 'vestiaire') {
                        vestiaireGagesData = data;
                        allGagesData[categoryId] = data; // Stocke l'objet vestiaire directement
                    } else {
                        // Assure que chaque gage a un ID unique
                        const gagesWithIds = (data.gages || []).map(gage => {
                            if (!gage.id) {
                                gage.id = generateUniqueId();
                                console.warn(`[onSnapshot] Gage sans ID trouv√© dans la cat√©gorie '${categoryId}'. Un ID unique lui a √©t√© assign√©.`);
                                // Optionnel: Mettre √† jour Firestore imm√©diatement pour persister l'ID
                                // updateDoc(docSnap.ref, { gages: data.gages });
                            }
                            return gage;
                        });
                        allGagesData[categoryId] = gagesWithIds;

                        // Met √† jour les tableaux sp√©cifiques pour la logique de jeu
                        switch (categoryId) {
                            case 'go_back': goBackGagesData = gagesWithIds; break;
                            case 'surprise': surpriseGagesData = gagesWithIds; break;
                            case 'action': actionGagesData = gagesWithIds; break;
                            case 'undress': undressGagesData = gagesWithIds; break;
                            case 'truth_dare': truthOrDareGagesData = gagesWithIds; break;
                            case 'massage_sensory': massageSensoryGagesData = gagesWithIds; break;
                            case 'role_play': rolePlayGagesData = gagesWithIds; break;
                            case 'sexual_positions': sexualPositionsGagesData = gagesWithIds; break;
                            case 'final_gage': finalGageData = gagesWithIds; break;
                        }
                    }
                });

                if (!gagesExist || !allGagesData['action']) { // V√©rifie si au moins 'action' existe
                    console.warn("[loadGagesFromFirestore] Aucune donn√©e de gages trouv√©e ou incompl√®te dans Firestore. Initialisation des donn√©es par d√©faut...");
                    await initializeDefaultGagesInFirestore();
                    // onSnapshot se d√©clenchera √† nouveau apr√®s l'initialisation des d√©fauts
                } else {
                    console.log("[loadGagesFromFirestore] Gages charg√©s et mis √† jour depuis Firestore avec succ√®s !");
                    renderAdminGagesList(); // Met √† jour la liste dans le panneau admin
                }
                loadingIndicator.style.display = 'none';
            }, (error) => {
                console.error("[onSnapshot] Erreur lors du chargement des gages depuis Firestore :", error);
                showMessage("Impossible de charger les gages. Veuillez v√©rifier votre connexion ou les r√®gles Firebase.");
                loadingIndicator.style.display = 'none';
            });
        }

        /**
         * Initialise les gages par d√©faut dans Firestore si les collections sont vides.
         * Chaque gage aura d√©sormais un ID unique g√©n√©r√©.
         */
        async function initializeDefaultGagesInFirestore() {
            if (!db) {
                console.error("[initializeDefaultGagesInFirestore] Firebase Firestore n'est pas initialis√©. Impossible d'initialiser les gages par d√©faut.");
                return;
            }
            console.log("[initializeDefaultGagesInFirestore] Initialisation des gages par d√©faut dans Firestore...");
            const gagesCollectionRef = collection(db, `artifacts/${appId}/public/data/gages`);

            const defaultGages = {
                go_back: [
                    { title: "Oups ! Retour en arri√®re !", text: "[joueur] recule de [steps] cases !", duration: "5s", accessories: [], imageUrl: "https://www.fullmoon.info/wp-content/uploads/2013/12/moonwalk_198x198.jpg" },
                    { title: "Demi-tour !", text: "Le chemin est bloqu√© ! [joueur] doit reculer de [steps] cases.", duration: "5s", accessories: [], imageUrl: "https://www.fullmoon.info/wp-content/uploads/2013/12/moonwalk_198x198.jpg" },
                    { title: "Faute de parcours !", text: "Tu as fait une erreur ! Recule de [steps] cases.", duration: "5s", accessories: [], imageUrl: "https://www.fullmoon.info/wp-content/uploads/2013/12/moonwalk_198x198.jpg" }
                ],
                surprise: [
                    { title: "Surprise ! Fusion !", text: "Lorsque [joueur] arrive sur la case de [autreJoueur], les deux joueurs doivent s'embrasser passionn√©ment pendant 30 secondes sans s'arr√™ter.", duration: "30s", accessories: [], imageUrl: "https://eqomcdn.com/content/photos/products/loveboxxx/40818/1625156791.LBX03-01.jpg" },
                    { title: "Surprise ! Miroir !", text: "Lorsque [joueur] arrive sur la case de [autreJoueur], les deux joueurs doivent imiter les mouvements de l'autre pendant 1 minute, de mani√®re sensuelle.", duration: "1min", accessories: [], imageUrl: "https://eqomcdn.com/content/photos/products/loveboxxx/40818/1625156791.LBX03-01.jpg" },
                    { title: "Surprise ! Duo !", text: "Lorsque [joueur] arrive sur la case de [autreJoueur], les deux joueurs doivent se d√©shabiller mutuellement en m√™me temps, jusqu'√† ce qu'ils soient tous les deux en sous-v√™tements.", duration: "1min", accessories: [], imageUrl: "https://eqomcdn.com/content/photos/products/loveboxxx/40818/1625156791.LBX03-01.jpg" },
                    { title: "Surprise ! Chuchotements Entrem√™l√©s !", text: "Lorsque [joueur] arrive sur la case de [autreJoueur], chuchotez-vous mutuellement des mots doux et coquins √† l'oreille en m√™me temps pendant 30 secondes.", duration: "30s", accessories: [], imageUrl: "https://eqomcdn.com/content/photos/products/loveboxxx/40818/1625156791.LBX03-01.jpg" },
                    { title: "Surprise ! Contact Peau √† Peau !", text: "Lorsque [joueur] arrive sur la case de [autreJoueur], les deux joueurs doivent se coller l'un √† l'autre, peau contre peau, pendant 1 minute.", duration: "1min", accessories: [], imageUrl: "https://eqomcdn.com/content/photos/products/loveboxxx/40818/1625156791.LBX03-01.jpg" }
                ],
                action: [
                    { level: 1, title: "Action Douce 1", text: "Fais un compliment sinc√®re √† [autreJoueur].", duration: "10s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 1, title: "Action Douce 2", text: "Propose un c√¢lin spontan√© √† [autreJoueur].", duration: "15s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 1, title: "Action Douce 3", text: "Chuchote un secret amusant √† l'oreille de [autreJoueur].", duration: "10s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 2, title: "Action Chaude 1", text: "Danse sensuellement pour [autreJoueur] pendant 30 secondes.", duration: "30s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 2, title: "Action Chaude 2", text: "Vole un baiser sur le cou de [autreJoueur].", duration: "5s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 2, title: "Action Chaude 3", text: "Fais un regard intense √† [autreJoueur] sans cligner des yeux pendant 15 secondes.", duration: "15s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 3, title: "Action Tr√®s Chaude 1", text: "√âchange un baiser langoureux avec [autreJoueur] pendant 20 secondes.", duration: "20s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 3, title: "Action Tr√®s Chaude 2", text: "Fais un strip-tease partiel (enl√®ve un v√™tement) pour [autreJoueur].", duration: "1min", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 3, title: "Action Tr√®s Chaude 3", text: "Prends un selfie suggestif avec [autreJoueur].", duration: "30s", accessories: ["Smartphone"], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 4, title: "Action Torride 1", text: "Donne un baiser passionn√© √† [autreJoueur] sur une partie du corps inattendue.", duration: "15s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 4, title: "Action Torride 2", text: "Fais un lap dance pour [autreJoueur] pendant 1 minute.", duration: "1min", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 4, title: "Action Torride 3", text: "Chuchote ton fantasme le plus secret √† [autreJoueur].", duration: "30s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" }
                ],
                undress: [
                    { level: 1, type: 'clothes', title: "D√©shabillage Doux 1", text: "[joueur] retire un v√™tement de son choix.", duration: "15s", accessories: [], imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg" },
                    { level: 1, type: 'clothes', title: "D√©shabillage Doux 2", text: "[joueur] retire un accessoire (montre, collier, chaussette).", duration: "10s", accessories: [], imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg" },
                    { level: 2, type: 'clothes', title: "D√©shabillage Chaud 1", text: "[joueur] retire un v√™tement de son choix, lentement.", duration: "20s", accessories: [], imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg" },
                    { level: 2, type: 'clothes', title: "D√©shabillage Chaud 2", text: "[joueur] retire un v√™tement que [autreJoueur] choisit (pas les sous-v√™tements !).", duration: "20s", accessories: [], imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg" },
                    { level: 3, type: 'clothes', title: "D√©shabillage Tr√®s Chaud 1", text: "[joueur] retire un v√™tement en faisant monter le d√©sir de [autreJoueur].", duration: "30s", accessories: [], imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg" },
                    { level: 3, type: 'underwear', title: "D√©shabillage Tr√®s Chaud 2", text: "[joueur] retire un sous-v√™tement de son choix.", duration: "30s", accessories: [], imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg" },
                    { level: 4, type: 'clothes', title: "D√©shabillage Torride 1", text: "[joueur] retire un v√™tement en regardant [autreJoueur] dans les yeux.", duration: "45s", accessories: [], imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg" },
                    { level: 4, type: 'underwear', title: "D√©shabillage Torride 2", text: "[joueur] retire son dernier sous-v√™tement (s'il en reste) ou un autre sous-v√™tement.", duration: "45s", accessories: [], imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg" }
                ],
                truth_dare: [
                    { level: 1, title: "V√©rit√© Douce 1", text: "Quel est ton souvenir pr√©f√©r√© de notre premier baiser ?", duration: "30s", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" },
                    { level: 1, title: "Ose Doux 1", text: "Fais-moi un clin d'≈ìil s√©ducteur.", duration: "5s", accessories: [], imageUrl: "https://www.union.fr/wp-content/uploads/2019/01/gettyimages-97538561.jpg" },
                    { level: 1, title: "V√©rit√© Douce 2", text: "Quelle est la chose la plus mignonne que j'aie jamais faite ?", duration: "30s", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" },
                    { level: 1, title: "Ose Doux 2", text: "Tiens ma main pendant le reste du tour.", duration: "1min", accessories: [], imageUrl: "https://www.union.fr/wp-content/uploads/2019/01/gettyimages-97538561.jpg" },
                    { level: 1, title: "V√©rit√© Douce 3", text: "Si tu pouvais changer une chose chez moi, ce serait quoi (gentiment) ?", duration: "45s", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" },
                    { level: 2, title: "V√©rit√© Chaude 1", text: "Quel est ton endroit pr√©f√©r√© pour un baiser (sur le corps) ?", duration: "30s", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" },
                    { level: 2, title: "Ose Chaud 1", text: "Chuchote-moi quelque chose de coquin √† l'oreille.", duration: "10s", accessories: [], imageUrl: "https://www.union.fr/wp-content/uploads/2019/01/gettyimages-97538561.jpg" },
                    { level: 2, title: "V√©rit√© Chaude 2", text: "Quel est le compliment le plus sexy que tu m'aies jamais fait ou voulu me faire ?", duration: "45s", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" },
                    { level: 2, title: "Ose Chaud 2", text: "Fais-moi un bisou qui me donne des frissons.", duration: "10s", accessories: [], imageUrl: "https://www.union.fr/wp-content/uploads/2019/01/gettyimages-97538561.jpg" },
                    { level: 3, title: "V√©rit√© Tr√®s Chaude 1", text: "Quel est un fantasme que tu n'as jamais os√© partager avec moi ?", duration: "1min", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" },
                    { level: 3, title: "Ose Tr√®s Chaud 1", text: "L√®che un morceau de chocolat sur mon bras.", duration: "30s", accessories: ["Chocolat"], imageUrl: "https://www.union.fr/wp-content/uploads/2019/01/gettyimages-97538561.jpg" },
                    { level: 3, title: "V√©rit√© Tr√®s Chaude 2", text: "Quelle est la chose la plus coquine que tu aies jamais faite en public ?", duration: "1min", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" },
                    { level: 4, title: "V√©rit√© Torride 1", text: "D√©cris-moi en d√©tail ce que tu aimerais que je te fasse ce soir.", duration: "2min", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" },
                    { level: 4, title: "Ose Torride 1", text: "Enl√®ve un v√™tement de [autreJoueur] avec ta bouche (si possible).", duration: "1min", accessories: [], imageUrl: "https://www.union.fr/wp-content/uploads/2019/01/gettyimages-97538561.jpg" },
                    { level: 4, title: "V√©rit√© Torride 2", text: "Quelle est ta position sexuelle pr√©f√©r√©e et pourquoi ?", duration: "1min", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" }
                ],
                massage_sensory: [
                    { level: 1, title: "Massage Doux 1", text: "Masse les mains de [autreJoueur] pendant 1 minute.", duration: "1min", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 1, title: "Sensation Douce 1", text: "Effleure d√©licatement le bras de [autreJoueur] du bout des doigts pendant 30 secondes.", duration: "30s", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 1, title: "Massage Doux 2", text: "Caresses les cheveux de [autreJoueur] pendant 1 minute.", duration: "1min", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 1, title: "Sensation Douce 2", text: "Souffle doucement dans le cou de [autreJoueur].", duration: "15s", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 2, title: "Massage Chaud 1", text: "Masse les √©paules de [autreJoueur] pendant 1 minute.", duration: "1min", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 2, title: "Sensation Chaude 1", text: "Chatouille l√©g√®rement [autreJoueur] sur une zone sensible (pieds, cou, flancs) pendant 30 secondes.", duration: "30s", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 2, title: "Massage Chaud 2", text: "Caresses les cuisses de [autreJoueur] par-dessus les v√™tements pendant 1 minute.", duration: "1min", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 3, title: "Massage Tr√®s Chaud 1", text: "Masse la nuque et le haut du dos de [autreJoueur] avec de l'huile de massage pendant 2 minutes.", duration: "2min", accessories: ["Huile de massage"], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 3, title: "Sensation Tr√®s Chaude 1", text: "Passe un gla√ßon sur le cou et la poitrine de [autreJoueur] pendant 30 secondes.", duration: "30s", accessories: ["Gla√ßon"], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 3, title: "Massage Tr√®s Chaud 2", text: "Masse les pieds de [autreJoueur] avec tes mains ou tes pieds pendant 1 minute.", duration: "1min", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 4, title: "Massage Torride 1", text: "Masse les fesses de [autreJoueur] par-dessus les sous-v√™tements pendant 2 minutes.", duration: "2min", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 4, title: "Sensation Torride 1", text: "Utilise une plume ou un pinceau pour caresser les zones sensibles de [autreJoueur] pendant 1 minute.", duration: "1min", accessories: ["Plume/Pinceau"], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 4, title: "Massage Torride 2", text: "Masse l'int√©rieur des cuisses de [autreJoueur] avec de l'huile pendant 2 minutes.", duration: "2min", accessories: ["Huile de massage"], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" }
                ],
                role_play: [
                    { level: 2, title: "Jeu de R√¥le Chaud 1", text: "Fais semblant d'√™tre un/une parfait(e) inconnu(e) qui essaie de s√©duire [autreJoueur] avec 3 phrases.", duration: "1min", accessories: [], imageUrl: "https://previews.123rf.com/images/wisky/wisky1409/wisky140900126/31530661-sexy-police-officers-isolated-on-white-background.jpg" },
                    { level: 2, title: "Jeu de R√¥le Chaud 2", text: "Incarne un personnage de film romantique et fais une d√©claration d'amour √† [autreJoueur].", duration: "1min", accessories: [], imageUrl: "https://previews.123rf.com/images/wisky/wisky1409/wisky140900126/31530661-sexy-police-officers-isolated-on-white-background.jpg" },
                    { level: 3, title: "Jeu de R√¥le Tr√®s Chaud 1", text: "Pendant 5 minutes, [joueur] est ton ma√Ætre/ma√Ætresse et tu dois ob√©ir √† ses ordres (simples et non dangereux).", duration: "5min", accessories: [], imageUrl: "https://previews.123rf.com/images/wisky/wisky1409/wisky140900126/31530661-sexy-police-officers-isolated-on-white-background.jpg" },
                    { level: 3, title: "Jeu de R√¥le Tr√®s Chaud 2", text: "Fais semblant d'√™tre un/une espion(ne) sexy qui doit r√©cup√©rer des informations aupr√®s de [autreJoueur] par la s√©duction.", duration: "2min", accessories: [], imageUrl: "https://previews.123rf.com/images/wisky/wisky1409/wisky140900126/31530661-sexy-police-officers-isolated-on-white-background.jpg" },
                    { level: 3, title: "Jeu de R√¥le Tr√®s Chaud 3", text: "Incarne un personnage de ton choix et s√©duis [autreJoueur] pendant 2 minutes.", duration: "2min", accessories: [], imageUrl: "https://previews.123rf.com/images/wisky/wisky1409/wisky140900126/31530661-sexy-police-officers-isolated-on-white-background.jpg" },
                    { level: 4, title: "Jeu de R√¥le Torride 1", text: "Fais semblant d'√™tre un/une strip-teaseur/euse priv√©(e) pour [autreJoueur] pendant 2 minutes.", duration: "2min", accessories: [], imageUrl: "https://previews.123rf.com/images/wisky/wisky1409/wisky140900126/31530661-sexy-police-officers-isolated-on-white-background.jpg" },
                    { level: 4, title: "Jeu de R√¥le Torride 2", text: "Incarne un personnage dominant/soumis de ton choix et explore cette dynamique avec [autreJoueur] pendant 3 minutes.", duration: "3min", accessories: [], imageUrl: "https://previews.123rf.com/images/wisky/wisky1409/wisky140900126/31530661-sexy-police-officers-isolated-on-white-background.jpg" },
                    { level: 4, title: "Jeu de R√¥le Torride 3", text: "Inventez ensemble un sc√©nario coquin et incarnez-le pendant 5 minutes.", duration: "5min", accessories: [], imageUrl: "https://previews.123rf.com/images/wisky/wisky1409/wisky140900126/31530661-sexy-police-officers-isolated-on-white-background.jpg" }
                ],
                sexual_positions: [
                    { title: "La Cuill√®re Coquine", text: "Allongez-vous en position de cuill√®re, mais avec un contact peau √† peau maximal.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "5min+", accessories: [] },
                    { title: "Le Baiser Papillon", text: "Face √† face, vos corps coll√©s, √©changez des baisers doux et l√©gers sur tout le visage et le cou.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "3min", accessories: [] },
                    { title: "Le N≈ìud Amoureux", text: "Enlacez vos jambes et vos bras de mani√®re √† former un n≈ìud, en vous serrant fort l'un contre l'autre.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "2min", accessories: [] },
                    { title: "La Danse Lente Intime", text: "Dansez tr√®s lentement, corps contre corps, en vous murmurant des mots doux √† l'oreille.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "3min", accessories: [] },
                    { title: "Le Regard Profond", text: "Asseyez-vous l'un en face de l'autre, genoux contre genoux, et regardez-vous intens√©ment dans les yeux sans parler pendant 2 minutes.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "2min", accessories: [] },
                    { title: "L'√âtreinte Passionn√©e", text: "Serrez-vous dans les bras tr√®s fort, en vous balan√ßant doucement, comme si vous ne vouliez plus jamais vous l√¢cher.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "1min", accessories: [] },
                    { title: "Le C√¢lin Invers√©", text: "Asseyez-vous l'un sur l'autre, dos √† dos, et penchez-vous pour vous c√¢liner par-dessus l'√©paule.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "2min", accessories: [] },
                    { title: "Le Baiser de l'Araign√©e", text: "Allongez-vous sur le dos, face √† face, et essayez de vous embrasser en utilisant uniquement vos langues, sans bouger vos t√™tes.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "1min", accessories: [] },
                    { title: "Le Pont Humain", text: "L'un est allong√© sur le dos, l'autre se penche au-dessus, les mains et les pieds au sol, pour un baiser suspendu.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "1min", accessories: [] }
                ],
                final_gage: [
                    { title: "Le Triomphe des Amoureux !", text: "[joueur] a gagn√© ! Pour c√©l√©brer, [joueur] peut choisir n'importe quel gage (m√™me un pass√©) pour [autreJoueur], qui doit l'ex√©cuter avec passion !", duration: "√Ä la discr√©tion du vainqueur", accessories: [], imageUrl: "https://pics.porn300.com/thumbs/4/9/d/1/d/49d1d9ede7c1d6f2edde98237892d4db6539482c.mp4/improved/23.jpg" },
                    { title: "Le Baiser de la Victoire !", text: " [joueur] a gagn√© ! Les deux joueurs doivent √©changer un baiser langoureux et infini, jusqu'√† ce que l'un d'eux ne puisse plus respirer (presque) !", duration: "Jusqu'√† l'√©puisement", accessories: [], imageUrl: "https://pics.porn300.com/thumbs/4/9/d/1/d/49d1d9ede7c1d6f2edde98237892d4db6539482c.mp4/improved/23.jpg" },
                    { title: "Nuit Blanche de Plaisir !", text: "[joueur] a gagn√© ! Les deux joueurs doivent se promettre une nuit enti√®re de plaisirs et d'explorations mutuelles, sans limites !", duration: "Toute la nuit", accessories: [], imageUrl: "https://pics.porn300.com/thumbs/4/9/d/1/d/49d1d9ede7c1d6f2edde98237892d4db6539482c.mp4/improved/23.jpg" },
                    { title: "Le D√©shabillage Supr√™me !", text: "[joueur] a gagn√© ! [autreJoueur] doit retirer le dernier v√™tement ou sous-v√™tement qu'il/elle porte, lentement et sensuellement, sous le regard de [joueur] !", duration: "1min", accessories: [], imageUrl: "https://pics.porn300.com/thumbs/4/9/d/1/d/49d1d9ede7c1d6f2edde98237892d4db6539482c.mp4/improved/23.jpg" }
                ],
                vestiaire: {
                    clothes: {
                        title: "Vestiaire des V√™tements !",
                        text: "Le rideau se l√®ve ! [joueur], c'est l'heure de te r√©v√©ler ! Ex√©cute un d√©shabillage torride pour [autreJoueur], ne gardant que tes dessous. Fais monter la temp√©rature !",
                        imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg",
                        duration: "Imm√©diat",
                        accessories: []
                    },
                    underwear: {
                        title: "Vestiaire Intime !",
                        text: "Plus rien √† cacher, [joueur] ! Termine ton spectacle pour [autreJoueur] en te lib√©rant de tes derniers dessous. L'intimit√© est √† son comble !",
                        imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg",
                        duration: "Imm√©diat",
                        accessories: []
                    }
                }
            };

            for (const category in defaultGages) {
                const docRef = doc(gagesCollectionRef, category);
                if (category === 'vestiaire') {
                    // Pour le vestiaire, les gages sont des objets directs, pas un tableau 'gages'
                    // On ajoute des IDs aux sous-objets si n√©cessaire, mais ce n'est pas le m√™me pattern
                    // que les autres cat√©gories. Pour l'instant, on ne leur donne pas d'ID unique au niveau des sous-objets.
                    await setDoc(docRef, defaultGages[category]);
                } else {
                    // Assure que chaque gage par d√©faut a un ID unique avant de le sauvegarder
                    const gagesWithIds = defaultGages[category].map(gage => ({ ...gage, id: generateUniqueId() }));
                    await setDoc(docRef, { gages: gagesWithIds });
                }
                console.log(`[initializeDefaultGagesInFirestore] Gages par d√©faut pour la cat√©gorie '${category}' initialis√©s.`);
            }
            console.log("[initializeDefaultGagesInFirestore] Tous les gages par d√©faut ont √©t√© initialis√©s dans Firestore.");
        }


        // --- Gestion des √©v√©nements du jeu ---

        startGameButton.addEventListener('click', async () => {
            console.log("[startGameButton] Bouton 'Commencer le jeu !' cliqu√©.");
            if (!app || !auth || !db) {
                showMessage("Le jeu ne peut pas d√©marrer : Firebase n'est pas correctement configur√©. Veuillez v√©rifier la console pour plus de d√©tails et mettre √† jour votre 'firebaseConfig' si tu es en local.");
                return;
            }

            player1Name = player1NameInput.value.trim();
            player2Name = player2NameInput.value.trim();
            player1Clothes = parseInt(player1ClothesInput.value, 10);
            player1Underwear = parseInt(player1UnderwearInput.value, 10);
            player2Clothes = parseInt(player2ClothesInput.value, 10);
            player2Underwear = parseInt(player2UnderwearInput.value, 10);


            if (player1Name && player2Name && !isNaN(player1Clothes) && !isNaN(player1Underwear) && !isNaN(player2Clothes) && !isNaN(player2Underwear)) {
                if (player1Clothes < 0 || player1Underwear < 0 || player2Clothes < 0 || player2Underwear < 0) {
                    showMessage("Le nombre de v√™tements et sous-v√™tements ne peut pas √™tre n√©gatif.");
                    return;
                }

                loadingIndicator.style.display = 'block';
                startGameButton.disabled = true;
                adminModeButton.disabled = true;

                try {
                    console.log("[startGameButton] Tentative d'authentification Firebase...");
                    await signInAnonymously(auth);

                    userId = auth.currentUser.uid;
                    console.log("[startGameButton] Authentification Firebase r√©ussie. User ID:", userId);

                    gameDocRef = doc(db, `artifacts/${appId}/users/${userId}/game_state/current_game`);
                    console.log("[startGameButton] R√©f√©rence au document de jeu:", gameDocRef.path);

                    // loadGagesFromFirestore est maintenant un onSnapshot, donc il est d√©j√† actif
                    // On attend juste que les gages soient charg√©s la premi√®re fois
                    // Pour s'assurer que les gages sont bien l√† avant de continuer, on peut ajouter une petite attente ou un flag
                    // Pour l'instant, on consid√®re que onSnapshot a d√©j√† peupl√© les donn√©es.

                    const docSnap = await getDoc(gameDocRef);
                    if (docSnap.exists()) {
                        const savedState = docSnap.data();
                        player1Name = savedState.player1Name;
                        player2Name = savedState.player2Name;
                        player1Position = savedState.player1Position;
                        player2Position = savedState.player2Position;
                        player1Clothes = savedState.player1Clothes;
                        player1Underwear = savedState.player1Underwear;
                        player2Clothes = savedState.player2Clothes;
                        player2Underwear = savedState.player2Underwear;
                        currentPlayer = savedState.currentPlayer;
                        selectedMaleEmoji = savedState.selectedMaleEmoji;
                        selectedFemaleEmoji = savedState.selectedFemaleEmoji;

                        showMessage("Partie pr√©c√©dente charg√©e !");
                        console.log("[startGameButton] Partie pr√©c√©dente charg√©e:", savedState);
                    } else {
                        await setDoc(gameDocRef, {
                            player1Name,
                            player2Name,
                            player1Position,
                            player2Position,
                            player1Clothes,
                            player1Underwear,
                            player2Clothes,
                            player2Underwear,
                            currentPlayer,
                            selectedMaleEmoji,
                            selectedFemaleEmoji
                        });
                        showMessage("Nouvelle partie commenc√©e et sauvegard√©e !");
                        console.log("[startGameButton] Nouvelle partie commenc√©e et sauvegard√©e.");
                    }

                    player1Token.textContent = selectedMaleEmoji;
                    player2Token.textContent = selectedFemaleEmoji;
                    currentPlayerNameDisplay.textContent = currentPlayer === 1 ? player1Name : player2Name;

                    startScreen.style.display = 'none';
                    gameScreen.style.display = 'flex';
                    gameReady = true;
                    createBoard();
                    updateGameAmbiance(Math.max(player1Position, player2Position));
                    updateTheme();
                    console.log("[startGameButton] Jeu d√©marr√© avec succ√®s.");

                } catch (error) {
                    console.error("[startGameButton] Erreur d'authentification ou de chargement Firebase :", error);
                    showMessage("Erreur de connexion √† Firebase. Veuillez r√©essayer ou v√©rifier votre configuration.");
                    startGameButton.disabled = false;
                    adminModeButton.disabled = false;
                } finally {
                    loadingIndicator.style.display = 'none';
                }

            } else {
                showMessage("Veuillez saisir les pr√©noms des deux joueurs, choisir leurs emojis et entrer le nombre de v√™tements/sous-v√™tements pour commencer.");
            }
        });

        async function saveGameState() {
            if (!gameDocRef) {
                console.warn("[saveGameState] gameDocRef n'est pas d√©fini. Impossible de sauvegarder l'√©tat du jeu.");
                return;
            }
            try {
                await updateDoc(gameDocRef, {
                    player1Name,
                    player2Name,
                    player1Position,
                    player2Position,
                    player1Clothes,
                    player1Underwear,
                    player2Clothes,
                    player2Underwear,
                    currentPlayer,
                    selectedMaleEmoji,
                    selectedFemaleEmoji
                });
                console.log("[saveGameState] √âtat du jeu sauvegard√© avec succ√®s !");
            } catch (error) {
                console.error("[saveGameState] Erreur lors de la sauvegarde de l'√©tat du jeu :", error);
            }
        }

        rollDiceButton.addEventListener('click', async () => {
            if (!gameReady || isMoving) return;

            let rollCount = 0;
            const animationDuration = 1000;
            const intervalTime = 100;

            const animationInterval = setInterval(() => {
                const randomValue = Math.floor(Math.random() * 6) + 1;
                displayDiceFace(randomValue);
                rollCount++;
                if (rollCount * intervalTime >= animationDuration) {
                    clearInterval(animationInterval);
                    const diceResult = Math.floor(Math.random() * 6) + 1;
                    displayDiceFace(diceResult);

                    let currentPlayersPosition = currentPlayer === 1 ? player1Position : player2Position;
                    let potentialNewPosition = currentPlayersPosition + diceResult;

                    handlePlayerTurn(potentialNewPosition);
                }
            }, intervalTime);
        });

        gagDoneButton.addEventListener('click', async () => {
            hideGag();
            await saveGameState();
        });

        restartGameButton.addEventListener('click', async () => {
            hideVictoryScreen();
            resetGame();
            if (gameDocRef) {
                try {
                    await setDoc(gameDocRef, {
                        player1Name: '', player2Name: '',
                        player1Position: startCaseIndex, player2Position: startCaseIndex,
                        player1Clothes: 0, player1Underwear: 0,
                        player2Clothes: 0, player2Underwear: 0,
                        currentPlayer: 1,
                        selectedMaleEmoji: 'üé©', selectedFemaleEmoji: 'üíã'
                    });
                    console.log("[restartGameButton] Ancienne partie r√©initialis√©e dans Firestore.");
                } catch (error) {
                    console.error("[restartGameButton] Erreur lors de la r√©initialisation de l'ancienne partie :", error);
                }
            }
        });

        endSessionButton.addEventListener('click', () => {
            hideVictoryScreen();
            resetGame();
        });

        toggleDebugButton.addEventListener('click', () => {
            if (debugControls.style.display === 'flex') {
                debugControls.style.display = 'none';
            } else {
                debugControls.style.display = 'flex';
            }
        });

        manualMoveButton.addEventListener('click', async () => {
            if (!gameReady || isMoving) return;

            const targetVisualSquare = parseInt(targetSquareInput.value, 10);

            if (isNaN(targetVisualSquare) || targetVisualSquare < 1 || targetVisualSquare > totalOriginalCases) {
                showMessage(`Veuillez entrer un num√©ro de case valide entre 1 et ${totalOriginalCases}.`);
                return;
            }

            let targetArrayIndex = targetVisualSquare;
            if (targetVisualSquare >= 31) {
                targetArrayIndex += 1;
            }
            if (targetVisualSquare >= 61) {
                targetArrayIndex += 1;
            }

            if (targetArrayIndex === vestiaire1Index || targetArrayIndex === vestiaire2Index) {
                 showMessage(`La case ${targetVisualSquare} est un vestiaire. Veuillez entrer un num√©ro de case num√©rot√©e.`);
                 return;
            }

            await handlePlayerTurn(targetArrayIndex);
            await saveGameState();
        });

        // --- Admin Mode Logic ---
        const ADMIN_PASSWORD = "admin";

        adminModeButton.addEventListener('click', () => {
            adminPopup.style.display = 'flex';
            setTimeout(() => adminPopup.classList.add('active'), 10);
            adminPanelContent.style.display = 'none'; // Cache le contenu admin par d√©faut
            adminPasswordInput.value = '';
            adminPasswordInput.style.display = 'block'; // S'assurer que le champ de mot de passe est visible
            adminLoginButton.style.display = 'inline-block'; // S'assurer que le bouton login est visible
        });

        adminCloseButton.addEventListener('click', () => {
            adminPopup.classList.remove('active');
            setTimeout(() => adminPopup.style.display = 'none', 300);
        });

        adminLoginButton.addEventListener('click', () => {
            const enteredPassword = adminPasswordInput.value;
            if (enteredPassword === ADMIN_PASSWORD) {
                showMessage("Connexion administrateur r√©ussie !");
                adminPasswordInput.style.display = 'none';
                adminLoginButton.style.display = 'none';
                adminPanelContent.style.display = 'flex'; // Affiche le panneau admin
                // Pas besoin de recharger les gages, onSnapshot s'en occupe
            } else {
                showMessage("Mot de passe incorrect.");
                adminPasswordInput.value = '';
            }
        });

        addGageButtonMain.addEventListener('click', () => {
            openGageForm(); // Ouvre le formulaire pour un nouvel ajout
        });

        cancelGageFormButton.addEventListener('click', () => {
            hideGageForm();
        });

        // G√®re la visibilit√© des champs "Niveau" et "Type" en fonction de la cat√©gorie
        gageCategorySelect.addEventListener('change', () => {
            const selectedCategory = gageCategorySelect.value;
            const needsLevel = ['action', 'undress', 'truth_dare', 'massage_sensory', 'role_play'].includes(selectedCategory);
            const needsType = selectedCategory === 'undress';

            gageLevelLabel.style.display = needsLevel ? 'block' : 'none';
            gageLevelInput.style.display = needsLevel ? 'block' : 'none';
            gageLevelInput.required = needsLevel; // Rendre requis si visible

            gageTypeLabel.style.display = needsType ? 'block' : 'none';
            gageTypeSelect.style.display = needsType ? 'block' : 'none';
            gageTypeSelect.required = needsType; // Rendre requis si visible
        });

        gageForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Emp√™che le rechargement de la page

            const gageId = gageIdInput.value || generateUniqueId();
            const title = gageTitleInput.value.trim();
            const text = gageTextInput.value.trim();
            const category = gageCategorySelect.value;
            const level = gageLevelInput.style.display === 'block' ? parseInt(gageLevelInput.value, 10) : undefined;
            const type = gageTypeSelect.style.display === 'block' ? gageTypeSelect.value : undefined;
            const duration = gageDurationInput.value.trim();
            const accessories = gageAccessoriesInput.value.trim().split(',').map(a => a.trim()).filter(a => a);
            const imageUrl = gageImageUrlInput.value.trim();

            if (!title || !text || !category) {
                showMessage("Veuillez remplir tous les champs obligatoires (Titre, Texte, Cat√©gorie).");
                return;
            }
            // Le niveau 5 est pour les positions sexuelles qui n'ont pas de niveau ajustable via le formulaire
            // et les gages finaux. Le formulaire ne doit permettre que 1-4 pour les cat√©gories avec niveau.
            if (level !== undefined && (isNaN(level) || level < 1 || level > 4)) {
                showMessage("Le niveau doit √™tre un nombre entre 1 et 4 pour cette cat√©gorie.");
                return;
            }

            const newGage = { id: gageId, title, text, duration, accessories, imageUrl };
            if (level !== undefined) newGage.level = level;
            if (type !== undefined) newGage.type = type;

            try {
                const categoryDocRef = doc(db, `artifacts/${appId}/public/data/gages/${category}`);

                if (category === 'vestiaire') {
                    // Pour la cat√©gorie 'vestiaire', la structure est diff√©rente
                    // Ici, on ne peut pas "ajouter" un gage, seulement modifier 'clothes' ou 'underwear'.
                    // Le formulaire ne g√®re pas cette distinction pour la modification/ajout simple.
                    // Donc, on bloque l'ajout/modification de 'vestiaire' via ce formulaire.
                    showMessage("La modification des gages 'Vestiaire' n'est pas support√©e via ce formulaire pour le moment.");
                    return;
                }

                // R√©cup√®re l'array existant ou un array vide
                const docSnap = await getDoc(categoryDocRef);
                let currentGages = docSnap.exists() ? (docSnap.data().gages || []) : [];

                const existingGageIndex = currentGages.findIndex(g => g.id === gageId);

                if (existingGageIndex > -1) {
                    // Modification d'un gage existant
                    currentGages[existingGageIndex] = newGage;
                    await updateDoc(categoryDocRef, { gages: currentGages });
                    showMessage("Gage modifi√© avec succ√®s !");
                } else {
                    // Ajout d'un nouveau gage
                    currentGages.push(newGage);
                    await setDoc(categoryDocRef, { gages: currentGages }, { merge: true }); // setDoc avec merge pour cr√©er si n'existe pas
                    showMessage("Nouveau gage ajout√© avec succ√®s !");
                }
                hideGageForm();
            } catch (error) {
                console.error("Erreur lors de la sauvegarde du gage :", error);
                showMessage("Erreur lors de la sauvegarde du gage. " + error.message);
            }
        });

        /**
         * Affiche le formulaire d'ajout/modification de gage.
         * @param {object|null} gage - L'objet gage √† modifier, ou null pour un nouvel ajout.
         * @param {string|null} category - La cat√©gorie du gage √† modifier (n√©cessaire pour trouver le gage).
         */
        function openGageForm(gage = null, category = null) {
            gageForm.reset(); // R√©initialise le formulaire
            gageIdInput.value = ''; // Efface l'ID cach√©
            gageLevelLabel.style.display = 'none';
            gageLevelInput.style.display = 'none';
            gageLevelInput.required = false;
            gageTypeLabel.style.display = 'none';
            gageTypeSelect.style.display = 'none';
            gageTypeSelect.required = false;

            if (gage && category) {
                gageFormTitle.textContent = "Modifier le Gage";
                gageIdInput.value = gage.id;
                gageTitleInput.value = gage.title;
                gageTextInput.value = gage.text;
                gageCategorySelect.value = category;
                gageDurationInput.value = gage.duration || '';
                gageAccessoriesInput.value = (gage.accessories || []).join(', ');
                gageImageUrlInput.value = gage.imageUrl || '';

                // G√®re les champs conditionnels pour la modification
                const needsLevel = ['action', 'undress', 'truth_dare', 'massage_sensory', 'role_play'].includes(category);
                const needsType = category === 'undress';

                if (needsLevel) {
                    gageLevelLabel.style.display = 'block';
                    gageLevelInput.style.display = 'block';
                    gageLevelInput.value = gage.level || '';
                    gageLevelInput.required = true;
                }
                if (needsType) {
                    gageTypeLabel.style.display = 'block';
                    gageTypeSelect.style.display = 'block';
                    gageTypeSelect.value = gage.type || 'clothes';
                    gageTypeSelect.required = true;
                }

            } else {
                gageFormTitle.textContent = "Ajouter un Gage";
            }

            gageFormPopup.style.display = 'flex';
            setTimeout(() => gageFormPopup.classList.add('active'), 10);
        }

        /**
         * Cache le formulaire d'ajout/modification de gage.
         */
        function hideGageForm() {
            gageFormPopup.classList.remove('active');
            setTimeout(() => gageFormPopup.style.display = 'none', 300);
        }

        /**
         * Supprime un gage de Firestore.
         * @param {string} gageId - L'ID unique du gage √† supprimer.
         * @param {string} category - La cat√©gorie du gage.
         */
        async function deleteGage(gageId, category) {
            const confirmed = await showConfirmation("√ätes-vous s√ªr de vouloir supprimer ce gage ? Cette action est irr√©versible.");

            if (!confirmed) {
                return;
            }

            try {
                const categoryDocRef = doc(db, `artifacts/${appId}/public/data/gages/${category}`);
                const docSnap = await getDoc(categoryDocRef);

                if (docSnap.exists()) {
                    let currentGages = docSnap.data().gages || [];
                    const updatedGages = currentGages.filter(gage => gage.id !== gageId);

                    if (updatedGages.length < currentGages.length) {
                        await updateDoc(categoryDocRef, { gages: updatedGages });
                        showMessage("Gage supprim√© avec succ√®s !");
                    } else {
                        showMessage("Gage non trouv√© dans la cat√©gorie.");
                    }
                } else {
                    showMessage("Cat√©gorie de gage non trouv√©e.");
                }
            } catch (error) {
                console.error("Erreur lors de la suppression du gage :", error);
                showMessage("Erreur lors de la suppression du gage. " + error.message);
            }
        }

        /**
         * Rend la liste des gages dans le panneau administrateur.
         * Cette fonction est appel√©e par le onSnapshot pour les mises √† jour en temps r√©el.
         */
        function renderAdminGagesList() {
            gagesListContainer.innerHTML = ''; // Vide la liste existante

            // Obtient la liste des cat√©gories tri√©es pour un affichage coh√©rent
            const sortedCategories = Object.keys(allGagesData).sort();

            sortedCategories.forEach(category => {
                const gages = allGagesData[category];

                if (category === 'vestiaire') {
                    // G√®re les gages vestiaire s√©par√©ment car leur structure est diff√©rente
                    const vestiaireGages = [];
                    if (gages.clothes) vestiaireGages.push({ id: 'vestiaire_clothes', title: gages.clothes.title, text: gages.clothes.text, type: 'clothes' });
                    if (gages.underwear) vestiaireGages.push({ id: 'vestiaire_underwear', title: gages.underwear.title, text: gages.underwear.text, type: 'underwear' });

                    vestiaireGages.forEach(gage => {
                        const gageItem = document.createElement('div');
                        gageItem.classList.add('gage-item');
                        gageItem.innerHTML = `
                            <div class="gage-item-title">${gage.title}</div>
                            <div class="gage-item-details">Cat√©gorie: Vestiaire (${gage.type})</div>
                            <div class="gage-item-actions">
                                <button class="edit-button" data-gage-id="${gage.id}" data-gage-category="vestiaire">Modifier</button>
                                <!-- Pas de suppression pour les gages vestiaire par d√©faut pour l'instant -->
                            </div>
                        `;
                        gagesListContainer.appendChild(gageItem);

                        // Ajoute les √©couteurs d'√©v√©nements pour les boutons "Modifier"
                        gageItem.querySelector('.edit-button').addEventListener('click', () => {
                            // Pour les gages vestiaire, il faut passer l'objet complet
                            // Note: la modification des gages vestiaire est simplifi√©e et ne permet pas l'ajout/suppression
                            // de sous-types via le formulaire actuel, seulement l'√©dition des champs existants.
                            const originalGage = (gage.type === 'clothes' ? allGagesData.vestiaire.clothes : allGagesData.vestiaire.underwear);
                            openGageForm(originalGage, category);
                        });
                    });
                } else if (Array.isArray(gages)) { // S'assure que c'est un tableau de gages
                    gages.forEach(gage => {
                        const gageItem = document.createElement('div');
                        gageItem.classList.add('gage-item');
                        gageItem.innerHTML = `
                            <div class="gage-item-title">${gage.title}</div>
                            <div class="gage-item-details">Cat√©gorie: ${category.replace('_', ' ')} ${gage.level ? `(Niveau: ${gage.level})` : ''}</div>
                            <div class="gage-item-actions">
                                <button class="edit-button" data-gage-id="${gage.id}" data-gage-category="${category}">Modifier</button>
                                <button class="delete-button" data-gage-id="${gage.id}" data-gage-category="${category}">Supprimer</button>
                            </div>
                        `;
                        gagesListContainer.appendChild(gageItem);

                        // Ajoute les √©couteurs d'√©v√©nements pour les boutons
                        gageItem.querySelector('.edit-button').addEventListener('click', () => {
                            openGageForm(gage, category);
                        });
                        gageItem.querySelector('.delete-button').addEventListener('click', () => {
                            deleteGage(gage.id, category);
                        });
                    });
                }
            });
        }


        // Initialisation du jeu au chargement complet du DOM
        document.addEventListener('DOMContentLoaded', () => {
            console.log("[DOMContentLoaded] DOM enti√®rement charg√©. D√©but de l'initialisation.");
            try {
                startScreen.style.display = 'flex';
                gameScreen.style.display = 'none';
                gagPopup.style.display = 'none';
                victoryPopup.style.display = 'none';
                debugControls.style.display = 'none';
                adminPopup.style.display = 'none';
                gageFormPopup.style.display = 'none';
                confirmationModal.style.display = 'none'; // Assurez-vous que la modale de confirmation est cach√©e

                startGameButton.disabled = false;
                adminModeButton.disabled = false;
                loadingIndicator.style.display = 'none';

                if (maleEmojiOptionsDiv && femaleEmojiOptionsDiv) {
                    initializeEmojiOptions(maleEmojiOptionsDiv, maleEmojis, 'male');
                    initializeEmojiOptions(femaleEmojiOptionsDiv, femaleEmojis, 'female');
                } else {
                    console.error("[DOMContentLoaded] Erreur: Un ou plusieurs conteneurs d'emojis n'ont pas √©t√© trouv√©s dans le DOM.");
                }

                displayDiceFace(1);
                updateTheme();
                console.log("[DOMContentLoaded] √âcran de d√©marrage pr√™t.");

                // Lance le chargement des gages via onSnapshot d√®s le d√©but
                loadGagesFromFirestore();

            } catch (e) {
                console.error("[DOMContentLoaded] Erreur critique lors de l'initialisation du DOM:", e);
                showMessage("Une erreur est survenue au d√©marrage. Veuillez recharger la page.");
            }
        });

        // --- NOUVEAU : √âv√©nement pour le bouton "Nouvelle Partie" ---
        newGameButton.addEventListener('click', async () => {
            const confirmed = await showConfirmation("Voulez-vous vraiment commencer une nouvelle partie ? La partie actuelle sera perdue.");
            if (confirmed) {
                resetGame();
                // Optionnel: R√©initialiser l'√©tat de la partie dans Firestore si tu veux effacer la sauvegarde de l'utilisateur
                if (gameDocRef) {
                    try {
                        await setDoc(gameDocRef, {
                            player1Name: '', player2Name: '',
                            player1Position: startCaseIndex, player2Position: startCaseIndex,
                            player1Clothes: 0, player1Underwear: 0,
                            player2Clothes: 0, player2Underwear: 0,
                            currentPlayer: 1,
                            selectedMaleEmoji: 'üé©', selectedFemaleEmoji: 'üíã'
                        });
                        console.log("[newGameButton] Ancienne partie r√©initialis√©e dans Firestore.");
                    } catch (error) {
                        console.error("[newGameButton] Erreur lors de la r√©initialisation de l'ancienne partie dans Firestore :", error);
                    }
                }
                showMessage("Nouvelle partie commenc√©e !");
            }
        });

    </script>
</body>
</html>
