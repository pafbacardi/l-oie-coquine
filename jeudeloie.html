<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeu de l'Oie Coquin</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíã</text></svg>">
    <style>
        /* Variables CSS pour les couleurs et l'ambiance */
        :root {
            --color-primary: #FF69B4; /* Rose vif */
            --color-secondary: #FFC0CB; /* Rose p√¢le */
            --color-text: #333;
            --color-background-start: #FCE4EC; /* Tr√®s p√¢le pour le d√©but */
            --color-background-level1: #FFEBEE; /* Rose l√©ger */
            --color-background-level2: #FFCDD2; /* Rose moyen */
            --color-background-level3: #EF9A9A; /* Rose plus soutenu */
            --color-background-level4: #E57373; /* Rouge-rose intense */
            --color-background-level5: #8B008B; /* Violet fonc√© pour le niveau 5 */
            --color-button: #FF1493; /* Rose profond */
            --color-button-hover: #C71585; /* Rose plus fonc√© */
            --color-debug-bg: rgba(255, 255, 0, 0.9);
            --color-debug-border: #999;

            /* Couleurs pour le th√®me bleu (joueur homme) */
            --color-blue-primary: #007bff; /* Bleu standard */
            --color-blue-secondary: #6cbfff; /* Bleu clair */
            --color-blue-button: #0056b3; /* Bleu fonc√© pour bouton */
            --color-blue-button-hover: #004085; /* Bleu encore plus fonc√© */
        }

        /* Styles g√©n√©raux pour le corps de la page */
        html, body {
            height: 100%; /* Ensure full height for vh units to work correctly */
            margin: 0;
            padding: 0;
            overflow: hidden; /* Emp√™che le scroll par d√©faut du body */
        }

        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: var(--color-background-start);
            color: var(--color-text);
            transition: background-color 0.8s ease-in-out; /* Transition pour le changement de fond */
        }

        /* --- √âcran d'accueil --- */
        #start-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            text-align: center;
            max-width: 350px;
            width: 90%;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-height: 85vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        #start-screen h1 {
            color: var(--color-primary);
            margin-bottom: 25px;
            font-size: 2.2em;
        }

        #start-screen label {
            margin-top: 15px;
            font-weight: bold;
            color: var(--color-primary);
        }

        #start-screen input[type="text"],
        #start-screen input[type="number"] { /* Style pour les inputs num√©riques aussi */
            padding: 12px;
            margin-top: 8px;
            border: 2px solid var(--color-secondary);
            border-radius: 8px;
            width: calc(100% - 24px);
            font-size: 1.1em;
            text-align: center;
        }

        /* Styles pour la s√©lection d'emojis */
        .emoji-selection {
            margin-top: 20px;
            width: 100%;
        }

        .emoji-options {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .emoji-option {
            font-size: 2.5em;
            cursor: pointer;
            padding: 4px;
            border: 2px solid transparent;
            border-radius: 8px;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }

        .emoji-option:hover {
            background-color: var(--color-secondary);
        }

        .emoji-option.selected {
            border-color: var(--color-button);
            background-color: var(--color-secondary);
        }

        #start-screen button {
            background-color: var(--color-button);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 30px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #start-screen button:hover {
            background-color: var(--color-button-hover);
        }

        /* Loading indicator (kept for visual consistency, but not used by Firebase anymore) */
        #loading-indicator {
            margin-top: 20px;
            font-size: 1.2em;
            color: var(--color-primary);
            display: none; /* Hide by default now */
        }

        /* --- √âcran de jeu --- */
        #game-screen {
            display: none; /* Cach√© par d√©faut, affich√© par JS */
            flex-direction: column;
            width: 100%;
            height: 100vh;
            position: relative;
            align-items: center;
        }

        #game-board-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            white-space: nowrap;
            position: relative;
            height: 200px;
            display: flex;
            align-items: center;
            margin-top: 50px;
            padding-bottom: 20px;
        }

        .case {
            display: inline-flex;
            flex-shrink: 0;
            width: 150px;
            height: 150px;
            background-color: var(--color-secondary);
            border: 2px solid var(--color-primary);
            border-radius: 10px;
            margin: 0 5px;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--color-primary);
            transition: background-color 0.5s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* Styles pour les niveaux d'intensit√© des cases (appliqu√©s par JS) */
        .level-1 { background-color: var(--color-background-level1); border-color: var(--color-primary); }
        .level-2 { background-color: var(--color-background-level2); border-color: var(--color-primary); }
        .level-3 { background-color: var(--color-background-level3); border-color: #D32F2F; }
        .level-4 { background-color: var(--color-background-level4); border-color: #B71C1C; }
        .level-5 { background-color: var(--color-background-level5); border-color: #4B0082; color: white; }


        /* Base style for all case emojis */
        .case .emoji-icon {
            position: absolute;
            font-size: 0.8em; /* Slightly smaller than case number */
        }

        /* Specific positions for each icon */
        .case .go-back-emoji { top: 5px; right: 5px; }
        .case .undress-emoji { top: 5px; left: 5px; }
        .case .action-emoji { bottom: 5px; right: 5px; }
        .case .truth-dare-emoji { bottom: 5px; left: 5px; }
        .case .massage-sensory-emoji { top: 5px; /* Adjust as needed for centering */ }
        .case .role-play-emoji { bottom: 5px; /* Adjust as needed for centering */ }
        .case .sexual-position-emoji { right: 5px; /* Adjust as needed for centering */ }


        /* Style for special cases borders/shadows */
        .case.go-back-case { border-color: #FF0000; box-shadow: 0 0 15px rgba(255, 0, 0, 0.4); }
        .case.undress-case { border-color: #FFD700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }
        .case.action-case { border-color: #00FF00; box-shadow: 0 0 15px rgba(0, 255, 0, 0.4); }
        .case.truth-dare-case { border-color: #00BFFF; /* Bleu clair */ box-shadow: 0 0 15px rgba(0, 191, 255, 0.4); }
        .case.massage-sensory-case { border-color: #FF69B4; /* Rose vif */ box-shadow: 0 0 15px rgba(255, 105, 180, 0.4); }
        .case.role-play-case { border-color: #9370DB; /* Violet moyen */ box-shadow: 0 0 15px rgba(147, 112, 219, 0.4); }
        .case.sexual-position-case { border-color: #4B0082; /* Bordure plus fonc√©e pour le violet */ box-shadow: 0 0 15px rgba(75, 0, 130, 0.4); }

        /* Styles pour les cases Vestiaire - √âclaircies et texte visible */
        .case.vestiaire-case {
            background-color: #A9A9A9; /* Gris plus clair */
            border-color: #666666; /* Bordure fonc√©e mais visible */
            color: white; /* Texte blanc pour contraster */
            font-size: 1.8em; /* Rendre le texte "Vestiaire" visible */
            flex-direction: column; /* Pour empiler ic√¥ne et texte si besoin */
            position: relative;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
        }

        .vestiaire-case .vestiaire-icon {
            font-size: 2.5em; /* Grande ic√¥ne */
            color: white; /* Couleur de l'ic√¥ne - reste blanc pour contraster avec le gris clair */
            margin-bottom: 5px; /* Espace entre ic√¥ne et texte */
            position: static; /* Supprime le positionnement absolu pour le flux normal */
        }

        /* Style pour la case D√©part */
        .case.start-case {
            background-color: #4CAF50; /* Vert pour le d√©part */
            border-color: #388E3C;
            color: white;
            font-size: 2em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }


        .player-token {
            position: absolute;
            top: calc(50% - 25px);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: left 0.8s ease-in-out, transform 0.3s ease;
            z-index: 10;
            font-size: 2.5em;
            color: white;
        }
        .player-token.male { background-color: #00BFFF; }
        .player-token.female { background-color: #FF69B4; }

        /* Styles pour les pions sur la m√™me case */
        .player-token.on-same-case.male { transform: translateX(-15px); }
        .player-token.on-same-case.female { transform: translateX(15px); }


        /* --- Zone du d√© --- */
        #dice-area {
            position: fixed;
            bottom: 100px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 20;
        }

        /* Styles pour le nouveau d√© visuel */
        #dice-container {
            width: 80px; /* Taille du d√© */
            height: 80px;
            background-color: white;
            border: 2px solid var(--color-primary);
            border-radius: 10px;
            position: relative; /* Pour positionner les points */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px; /* Espace entre le d√© et le bouton */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden; /* Pour s'assurer que les points ne d√©bordent pas */
        }

        .dot {
            position: absolute;
            width: 15px; /* Taille du point */
            height: 15px;
            background-color: black;
            border-radius: 50%;
            opacity: 0; /* Cach√© par d√©faut */
            transition: opacity 0.1s ease; /* Transition douce pour l'apparition/disparition des points */
        }

        /* Positionnement des points */
        .dot.top-left { top: 10px; left: 10px; }
        .dot.top-right { top: 10px; right: 10px; }
        .dot.middle-left { top: 50%; left: 10px; transform: translateY(-50%); }
        .dot.center { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .dot.middle-right { top: 50%; right: 10px; transform: translateY(-50%); }
        .dot.bottom-left { bottom: 10px; left: 10px; }
        .dot.bottom-right { bottom: 10px; right: 10px; }


        #roll-dice-button {
            background-color: var(--color-button);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 12px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        #roll-dice-button:hover {
            background-color: var(--color-button-hover);
        }

        #roll-dice-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* --- Pop-up de gage et de victoire (styles partag√©s) --- */
        #gag-popup, #victory-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #gag-popup.active, #victory-popup.active {
            opacity: 1;
            visibility: visible;
        }

        .gag-content { /* Appliqu√© aux deux pop-ups */
            background-color: white;
            padding: 20px 30px; /* Adjusted padding */
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            width: 400px;
            max-height: 95vh; /* Increased max-height for more scroll space */
            overflow-y: auto; /* Active le d√©filement vertical si le contenu d√©passe */
            box-sizing: border-box; /* Ensures padding is included in height calculation */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            color: var(--color-text);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #gag-popup.active .gag-content, #victory-popup.active .gag-content {
            transform: scale(1);
        }

        .gag-content h2 {
            color: var(--color-button);
            margin-top: 0;
            font-size: 2em;
        }

        .gag-content p {
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 20px;
            /* Removed overflow-y: auto and max-height from p tag, as parent .gag-content handles it */
        }

        /* Style pour l'image du gage */
        .gag-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .gag-content button {
            background-color: var(--color-button);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 5px; /* Pour espacer les boutons de victoire */
        }

        .gag-content button:hover {
            background-color: var(--color-button-hover);
        }

        /* Petit indicateur de joueur actuel */
        #current-player-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1em;
            color: var(--color-primary);
            z-index: 50;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* --- Debug Controls --- */
        #toggle-debug-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            z-index: 60;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        #debug-controls {
            display: none;
            position: fixed;
            top: 60px;
            right: 20px;
            background-color: var(--color-debug-bg);
            border: 1px solid var(--color-debug-border);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 55;
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
        }

        #debug-controls label {
            font-weight: bold;
            color: var(--color-text);
            font-size: 0.9em;
        }

        #debug-controls input[type="number"] {
            width: 80px;
            padding: 8px;
            border: 1px solid var(--color-debug-border);
            border-radius: 5px;
            font-size: 1em;
        }

        #debug-controls button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #debug-controls button:hover {
            background-color: #218838;
        }

        /* Styles pour le th√®me bleu (joueur homme) */
        #current-player-indicator.blue-theme {
            color: var(--color-blue-primary);
        }

        #dice-container.blue-theme {
            border-color: var(--color-blue-primary);
        }

        #dice-area.blue-theme #roll-dice-button {
            background-color: var(--color-blue-button);
        }

        #dice-area.blue-theme #roll-dice-button:hover {
            background-color: var(--color-blue-button-hover);
        }

        /* Admin Mode Popup */
        #admin-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #admin-popup.active {
            opacity: 1;
            visibility: visible;
        }

        .admin-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            width: 500px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            color: var(--color-text);
        }

        #admin-popup.active .admin-content {
            transform: scale(1);
        }

        .admin-content h2 {
            color: #4CAF50; /* Green for admin */
            margin-top: 0;
            font-size: 2em;
        }

        .admin-content p {
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .admin-content input[type="password"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            width: calc(100% - 20px);
            margin-bottom: 15px;
        }

        .admin-content button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 5px;
        }

        .admin-content button:hover {
            background-color: #388E3C;
        }

        /* Custom Message Box */
        #message-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            font-size: 1.2em;
            max-width: 80%;
        }
    </style>
</head>
<body>

    <!-- √âcran de D√©marrage -->
    <div id="start-screen">
        <h1>Le Jeu des Amoureux</h1>
        <label for="player1-name">Pr√©nom de Monsieur :</label>
        <input type="text" id="player1-name" placeholder="Ex: Jean">

        <div class="emoji-selection">
            <label>Choisissez l'emoji de Monsieur :</label>
            <div id="male-emoji-options" class="emoji-options">
                <!-- Emojis pour homme g√©n√©r√©s par JS -->
            </div>
        </div>

        <label for="player1-clothes">Nombre de v√™tements de Monsieur :</label>
        <input type="number" id="player1-clothes" min="0" value="3">
        <label for="player1-underwear">Nombre de sous-v√™tements de Monsieur :</label>
        <input type="number" id="player1-underwear" min="0" value="1">

        <label for="player2-name">Pr√©nom de Madame :</label>
        <input type="text" id="player2-name" placeholder="Ex: Sophie">

        <div class="emoji-selection">
            <label>Choisissez l'emoji de Madame :</label>
            <div id="female-emoji-options" class="emoji-options">
                <!-- Emojis pour femme g√©n√©r√©s par JS -->
            </div>
        </div>

        <label for="player2-clothes">Nombre de v√™tements de Madame :</label>
        <input type="number" id="player2-clothes" min="0" value="3">
        <label for="player2-underwear">Nombre de sous-v√™tements de Madame :</label>
        <input type="number" id="player2-underwear" min="0" value="1">

        <button id="start-game-button">Commencer le jeu !</button>
        <button id="admin-mode-button">Mode Administrateur</button>
        <div id="loading-indicator">Chargement du jeu...</div>
    </div>

    <!-- √âcran de Jeu -->
    <div id="game-screen">
        <div id="current-player-indicator">Au tour de : <span id="current-player-name"></span></div>

        <!-- Bouton pour afficher/masquer les contr√¥les de d√©bogage -->
        <button id="toggle-debug-button">D√©bogage</button>

        <!-- Panneau de contr√¥les de d√©bogage -->
        <div id="debug-controls">
            <label for="target-square-input">Aller √† la case :</label>
            <input type="number" id="target-square-input" min="1" max="69" value="1">
            <button id="manual-move-button">D√©placer √† la case</button>
        </div>

        <div id="game-board-container">
            <!-- Les cases seront g√©n√©r√©es ici par JavaScript -->
            <!-- Les pions utilisent maintenant les emojis choisis -->
            <div id="player1-token" class="player-token male"></div>
            <div id="player2-token" class="player-token female"></div>
        </div>

        <div id="dice-area">
            <!-- Nouveau d√© visuel -->
            <div id="dice-container">
                <span class="dot top-left"></span>
                <span class="dot top-right"></span>
                <span class="dot middle-left"></span>
                <span class="dot center"></span>
                <span class="dot middle-right"></span>
                <span class="dot bottom-left"></span>
                <span class="dot bottom-right"></span>
            </div>
            <button id="roll-dice-button">Lancer le d√© !</button>
        </div>
    </div>

    <!-- Pop-up de Gage -->
    <div id="gag-popup">
        <div class="gag-content">
            <h2 id="gag-title">D√©fi Coquin !</h2>
            <img id="gag-image" src="" alt="Image du gage" class="gag-image" onerror="this.style.display='none'">
            <p id="gag-text"></p>
            <button id="gag-done-button">Gage termin√© !</button>
        </div>
    </div>

    <!-- Pop-up de Victoire -->
    <div id="victory-popup">
        <div class="gag-content">
            <h2 id="victory-title">F√©licitations !</h2>
            <p id="victory-message"></p>
            <button id="restart-game-button">Recommencer une nouvelle partie</button>
            <button id="end-session-button">Terminer la session</button>
        </div>
    </div>

    <!-- Admin Mode Popup -->
    <div id="admin-popup">
        <div class="admin-content">
            <h2>Mode Administrateur</h2>
            <p>Veuillez entrer le mot de passe administrateur.</p>
            <input type="password" id="admin-password-input" placeholder="Mot de passe">
            <button id="admin-login-button">Se connecter</button>
            <button id="admin-close-button">Fermer</button>
            <div id="admin-panel-content" style="display: none;">
                <h3>Gestion des Gages</h3>
                <p>Ceci est un espace r√©serv√© pour l'interface de gestion des gages. Tu pourras ici ajouter, modifier et supprimer les gages.</p>
                <button id="add-gage-button">Ajouter un Gage</button>
                <!-- Plus de contr√¥les ici pour l'√©dition/suppression -->
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="message-box"></div>

    <script type="module">
        // Importe les fonctions n√©cessaires de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURATION FIREBASE
        // SI TU EX√âCUTES CE FICHIER DIRECTEMENT DANS TON NAVIGATEUR (HORS ENVIRONNEMENT CANVAS),
        // TU DOIS REMPLACER L'OBJET 'firebaseConfig' CI-DESSOUS PAR LA CONFIGURATION DE TON PROJET FIREBASE.
        // Tu peux trouver cette configuration dans ta console Firebase (Param√®tres du projet > Vos applications > Application Web).
        const firebaseConfig = {
            apiKey: "AIzaSyDXxfz5VdNiInngWzn3wtKVDJlBBz0272U", // <-- REMPLACE CECI PAR TA CL√â API FIREBASE
            authDomain: "jeuoiecoquin.firebaseapp.com", // <-- REMPLACE CECI
            projectId: "jeuoiecoquin", // <-- REMPLACE CECI
            storageBucket: "jeuoiecoquin.firebasestorage.app", // <-- REMPLACE CECI
            messagingSenderId: "642698244266", // <-- REMPLACE CECI
            appId: "1:642698244266:web:5c7a7e041b6be50bd7a0d3" // <-- REMPLACE CECI
            // measurementId: "G-XXXXXXXXXX" // Optionnel, si tu utilises Google Analytics
        };

        // L'ID de l'application est maintenant d√©riv√© du projectId de ta configuration Firebase.
        // Si tu n'as pas de projectId, il utilisera 'default-app-id'.
        const appId = firebaseConfig.projectId || 'default-app-id';

        // Ajout de logs pour v√©rifier la configuration Firebase
        console.log("[Firebase Config] Parsed firebaseConfig:", firebaseConfig);
        console.log("[Firebase Config] Using appId:", appId);


        // V√©rification si la cl√© API est pr√©sente et si l'objet n'est pas vide
        if (!firebaseConfig || Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey || firebaseConfig.apiKey === "VOTRE_API_KEY") {
            console.error("[Firebase Config] Erreur: La configuration Firebase est manquante ou la cl√© API n'est pas d√©finie. Si tu ex√©cutes ce fichier localement, assure-toi d'avoir remplac√© les valeurs par d√©faut dans 'firebaseConfig'.");
            // Afficher un message √† l'utilisateur si la configuration est critique
            document.addEventListener('DOMContentLoaded', () => {
                showMessage("Erreur de configuration Firebase: Cl√© API manquante ou incorrecte. Le jeu ne pourra pas sauvegarder la progression. Si tu es en local, mets √† jour 'firebaseConfig' dans le code.");
                // D√©sactiver les boutons qui d√©pendent de Firebase
                const startGameButton = document.getElementById('start-game-button');
                const adminModeButton = document.getElementById('admin-mode-button');
                if (startGameButton) startGameButton.disabled = true;
                if (adminModeButton) adminModeButton.disabled = true;
            });
            // Emp√™cher l'initialisation de Firebase si la config est invalide
            // throw new Error("Firebase API Key missing."); // Comment√© pour ne pas bloquer le rendu si l'utilisateur veut juste voir l'UI
        }

        // Initialise Firebase UNIQUEMENT si la configuration semble valide
        let app;
        let auth;
        let db;
        if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey !== "VOTRE_API_KEY") {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } else {
            console.warn("[Firebase Init] Firebase ne sera pas initialis√© car la configuration est invalide ou manquante. La sauvegarde ne fonctionnera pas.");
        }


        // Variables globales pour Firebase
        let userId = null; // Sera d√©fini apr√®s l'authentification
        let gameDocRef = null; // R√©f√©rence au document Firestore pour la partie en cours

        // Constantes du jeu
        const totalOriginalCases = 69; // Nombre de cases num√©rot√©es (1 √† 69)
        const numVestiaireCases = 2; // Nombre de cases vestiaire ajout√©es
        const startCaseIndex = 0; // Index de la case de d√©part dans le tableau
        const finalCaseArrayIndex = totalOriginalCases + numVestiaireCases; // Index de la derni√®re case du plateau (71)
        const totalBoardCases = finalCaseArrayIndex + 1; // Nombre total de cases dans le tableau (72, de 0 √† 71)

        // Indices des cases Vestiaire (index dans le tableau de cases)
        const vestiaire1Index = 31;
        const vestiaire2Index = 62;

        // Mise √† jour de l'indice de d√©but des positions sexuelles (index dans le tableau)
        const sexualPositionsStartCase = 63;


        // Variables d'√©tat du jeu
        let player1Name = '';
        let player2Name = '';
        let currentPlayer = 1; // 1 pour le joueur 1 (homme), 2 pour le joueur 2 (femme)
        let player1Position = startCaseIndex; // Position actuelle du joueur 1 (index de la case, 0-71)
        let player2Position = startCaseIndex; // Position actuelle du joueur 2 (index de la case, 0-71)
        let player1Clothes = 0;
        let player1Underwear = 0;
        let player2Clothes = 0;
        let player2Underwear = 0;

        let gameReady = false; // Indique si le jeu est initialis√©
        let isMoving = false; // Emp√™che de relancer le d√© pendant le d√©placement du pion

        // Emojis par d√©faut (peuvent √™tre modifi√©s par l'utilisateur)
        let selectedMaleEmoji = 'üé©';
        let selectedFemaleEmoji = 'üíã';

        // Tableaux pour stocker les index des cases sp√©ciales al√©atoires
        let goBackCases = [];
        let undressCases = [];
        let actionCases = [];
        let truthOrDareCases = [];
        let massageSensoryCases = [];
        let rolePlayCases = [];

        // Variables pour la r√©solution des promesses des pop-ups
        let resolveGagPromise = null;
        let resolveVictoryPromise = null;

        // --- Donn√©es de Gages (charg√©es depuis Firestore) ---
        // Ces variables seront remplies par la fonction loadGagesFromFirestore
        let goBackGagesData = [];
        let surpriseGagesData = [];
        let actionGagesData = [];
        let undressGagesData = [];
        let truthOrDareGagesData = [];
        let massageSensoryGagesData = [];
        let rolePlayGagesData = [];
        let sexualPositionsGagesData = [];
        let finalGageData = [];
        let vestiaireGagesData = {}; // Objet pour les gages de vestiaire


        // R√©f√©rences aux √©l√©ments DOM
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const player1NameInput = document.getElementById('player1-name');
        const player2NameInput = document.getElementById('player2-name');
        const player1ClothesInput = document.getElementById('player1-clothes');
        const player1UnderwearInput = document.getElementById('player1-underwear');
        const player2ClothesInput = document.getElementById('player2-clothes');
        const player2UnderwearInput = document.getElementById('player2-underwear');
        const startGameButton = document.getElementById('start-game-button');
        const maleEmojiOptionsDiv = document.getElementById('male-emoji-options');
        const femaleEmojiOptionsDiv = document.getElementById('female-emoji-options');
        const gameBoardContainer = document.getElementById('game-board-container');
        const player1Token = document.getElementById('player1-token');
        const player2Token = document.getElementById('player2-token');
        const rollDiceButton = document.getElementById('roll-dice-button');
        const diceContainer = document.getElementById('dice-container');
        const gagPopup = document.getElementById('gag-popup');
        const gagTitle = document.getElementById('gag-title');
        const gagText = document.getElementById('gag-text');
        const gagImage = document.getElementById('gag-image');
        const gagDoneButton = document.getElementById('gag-done-button');
        const currentPlayerNameDisplay = document.getElementById('current-player-name');
        const loadingIndicator = document.getElementById('loading-indicator');
        const diceArea = document.getElementById('dice-area'); // R√©f√©rence correcte pour diceArea

        // Debug controls references
        const toggleDebugButton = document.getElementById('toggle-debug-button');
        const debugControls = document.getElementById('debug-controls');
        const targetSquareInput = document.getElementById('target-square-input');
        const manualMoveButton = document.getElementById('manual-move-button');

        // Victory Pop-up references
        const victoryPopup = document.getElementById('victory-popup');
        const victoryTitle = document.getElementById('victory-title');
        const victoryMessage = document.getElementById('victory-message');
        const restartGameButton = document.getElementById('restart-game-button');
        const endSessionButton = document.getElementById('end-session-button');

        // Admin Mode references
        const adminModeButton = document.getElementById('admin-mode-button');
        const adminPopup = document.getElementById('admin-popup');
        const adminPasswordInput = document.getElementById('admin-password-input');
        const adminLoginButton = document.getElementById('admin-login-button');
        const adminCloseButton = document.getElementById('admin-close-button');
        const adminPanelContent = document.getElementById('admin-panel-content');
        const addGageButton = document.getElementById('add-gage-button'); // Placeholder for future use

        // Custom Message Box reference
        const messageBox = document.getElementById('message-box');

        // R√©f√©rences aux points du d√©
        const diceDots = {
            'top-left': document.querySelector('#dice-container .top-left'),
            'top-right': document.querySelector('#dice-container .top-right'),
            'middle-left': document.querySelector('#dice-container .middle-left'),
            'center': document.querySelector('#dice-container .center'),
            'middle-right': document.querySelector('#dice-container .middle-right'),
            'bottom-left': document.querySelector('#dice-container .bottom-left'),
            'bottom-right': document.querySelector('#dice-container .bottom-right')
        };


        // Listes d'emojis disponibles
        const maleEmojis = ['üé©', 'ü§µ', 'üî•', 'üï∫', 'üí™', 'üëë'];
        const femaleEmojis = ['üíã', 'üë†', 'üíÉ', '‚ù§Ô∏è', 'üíÖ', 'üë∏'];


        // --- Fonctions utilitaires ---

        /**
         * Affiche un message personnalis√© dans une bo√Æte temporaire.
         * Remplace les alertes natives du navigateur.
         * @param {string} message - Le message √† afficher.
         * @param {number} duration - La dur√©e d'affichage du message en ms.
         */
        function showMessage(message, duration = 3000) {
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }

        /**
         * Initialise les options d'emojis pour un joueur donn√©.
         * @param {HTMLElement} container - Le conteneur DOM pour les options d'emojis.
         * @param {Array<string>} emojis - La liste des emojis √† afficher.
         * @param {string} playerType - 'male' ou 'female'.
         */
        function initializeEmojiOptions(container, emojis, playerType) {
            console.log(`[initializeEmojiOptions] D√©but pour ${playerType}. Conteneur:`, container);
            if (!container) {
                console.error(`[initializeEmojiOptions] Erreur: Conteneur d'emojis non trouv√© pour ${playerType}.`);
                return;
            }
            container.innerHTML = ''; // Nettoie les options existantes
            emojis.forEach(emoji => {
                const emojiDiv = document.createElement('div');
                emojiDiv.classList.add('emoji-option');
                emojiDiv.textContent = emoji;
                emojiDiv.dataset.emoji = emoji; // Stocke l'emoji dans un attribut de donn√©es

                // S√©lectionne l'emoji par d√©faut
                if ((playerType === 'male' && emoji === selectedMaleEmoji) ||
                    (playerType === 'female' && emoji === selectedFemaleEmoji)) {
                    emojiDiv.classList.add('selected');
                }

                emojiDiv.addEventListener('click', () => {
                    // D√©s√©lectionne l'ancien emoji
                    const currentSelected = container.querySelector('.emoji-option.selected');
                    if (currentSelected) {
                        currentSelected.classList.remove('selected');
                    }
                    // S√©lectionne le nouvel emoji
                    emojiDiv.classList.add('selected');
                    if (playerType === 'male') {
                        selectedMaleEmoji = emoji;
                    } else {
                        selectedFemaleEmoji = emoji;
                    }
                    console.log(`[initializeEmojiOptions] Emoji s√©lectionn√© pour ${playerType}: ${emoji}`);
                });
                container.appendChild(emojiDiv);
            });
            console.log(`[initializeEmojiOptions] Emojis initialis√©s pour ${playerType}. Nombre d'options: ${container.children.length}`);
        }

        /**
         * S√©lectionne al√©atoirement des cases uniques pour les cat√©gories sp√©ciales.
         * @param {number} count - Le nombre de cases √† s√©lectionner.
         * @param {Array<number>} availableIndices - La liste des index de cases disponibles.
         * @param {Array<number>} selectedIndices - Le tableau o√π stocker les index s√©lectionn√©s.
         */
        function assignRandomUniqueCases(count, availableIndices, selectedIndices) {
            for (let i = 0; i < count; i++) {
                if (availableIndices.length === 0) {
                    console.warn(`Pas assez de cases disponibles pour assigner ${count - i} cases.`);
                    break;
                }
                const randomIndex = Math.floor(Math.random() * availableIndices.length);
                const caseIndex = availableIndices[randomIndex];
                selectedIndices.push(caseIndex);
                availableIndices.splice(randomIndex, 1); // Supprime pour assurer l'unicit√©
            }
        }

        /**
         * Convertit un index de tableau de case en son num√©ro de case visuel (1 √† 69).
         * G√®re la case de d√©part et les vestiaires qui ne sont pas num√©rot√©s.
         * @param {number} arrayIndex - L'index de la case dans le tableau.
         * @returns {number} Le num√©ro de case visuel (1-69) ou 0 pour la case de d√©part, ou un float pour les vestiaires.
         */
        function getVisualCaseNumber(arrayIndex) {
            if (arrayIndex === startCaseIndex) return 0; // Case de d√©part
            if (arrayIndex === vestiaire1Index) return 30.5; // Vestiaire 1 (entre 30 et 31)
            if (arrayIndex === vestiaire2Index) return 60.5; // Vestiaire 2 (entre 60 et 61)

            // Pour les cases num√©rot√©es
            let visualNumber = arrayIndex;
            if (arrayIndex > vestiaire2Index) {
                visualNumber -= numVestiaireCases; // D√©calage pour les deux vestiaires
            } else if (arrayIndex > vestiaire1Index) {
                visualNumber -= 1; // D√©calage pour le premier vestiaire
            }
            // D√©calage pour la case de d√©part (index 0)
            visualNumber -= 0; // La case 1 est √† l'index 1, donc pas de -1 ici si on consid√®re le 0 comme d√©part

            return visualNumber;
        }


        /**
         * G√©n√®re dynamiquement les cases du plateau de jeu et leur applique les styles de niveau.
         */
        function createBoard() {
            console.log("[createBoard] Cr√©ation du plateau de jeu...");
            gameBoardContainer.innerHTML = ''; // Nettoie le plateau existant avant de le recr√©er

            // Ajout des pions directement au conteneur du plateau
            gameBoardContainer.appendChild(player1Token);
            gameBoardContainer.appendChild(player2Token);

            // R√©initialise les tableaux de cases sp√©ciales
            goBackCases = [];
            undressCases = [];
            actionCases = [];
            truthOrDareCases = [];
            massageSensoryCases = [];
            rolePlayCases = [];

            // D√©finition des plages de cases par niveau pour l'assignation des cases sp√©ciales
            // Les startIdx/endIdx sont les INDEX r√©els du tableau de cases.
            // Les 'level' sont bas√©s sur le NUM√âRO VISUEL de la case.
            const levelRangesForRandomAssignment = [
                // Niveau 1: Cases 1-15 (indices 1-15)
                { startIdx: 1, endIdx: 15, level: 1, goBack: 1, undress: 2, action: 3, truthDare: 5, massage: 4, rolePlay: 0 },
                // Niveau 2: Cases 16-30 (indices 16-30)
                { startIdx: 16, endIdx: 30, level: 2, goBack: 1, undress: 2, action: 3, truthDare: 4, massage: 3, rolePlay: 2 },
                // Niveau 3: Cases 31-45 (indices 32-46, car vestiaire1Index est √† 31)
                { startIdx: 32, endIdx: 46, level: 3, goBack: 1, undress: 2, action: 3, truthDare: 3, massage: 3, rolePlay: 3 },
                // Niveau 4: Cases 46-60 (indices 47-61, car vestiaire1Index et vestiaire2Index sont avant)
                { startIdx: 47, endIdx: 61, level: 4, goBack: 1, undress: 2, action: 3, truthDare: 3, massage: 3, rolePlay: 3 }
            ];

            // Assignation des cases sp√©ciales al√©atoirement dans les plages d√©finies
            levelRangesForRandomAssignment.forEach(range => {
                let currentAvailable = [];
                for (let i = range.startIdx; i <= range.endIdx; i++) {
                    // Exclut les indices des vestiaires des cases disponibles pour les autres types de gages
                    // (Bien que les ranges soient d√©j√† d√©finis pour les exclure, c'est une s√©curit√©)
                    if (i !== vestiaire1Index && i !== vestiaire2Index && i !== startCaseIndex && i !== finalCaseArrayIndex) {
                        currentAvailable.push(i);
                    }
                }
                assignRandomUniqueCases(range.goBack, currentAvailable, goBackCases);
                assignRandomUniqueCases(range.undress, currentAvailable, undressCases);
                assignRandomUniqueCases(range.action, currentAvailable, actionCases);
                assignRandomUniqueCases(range.truthDare, currentAvailable, truthOrDareCases);
                assignRandomUniqueCases(range.massage, currentAvailable, massageSensoryCases);
                assignRandomUniqueCases(range.rolePlay, currentAvailable, rolePlayCases);
            });


            // Construction du plateau case par case
            let currentNumberedCaseCount = 0; // Compteur pour les num√©ros de cases visuels
            for (let i = 0; i < totalBoardCases; i++) {
                const caseDiv = document.createElement('div');
                caseDiv.classList.add('case');
                caseDiv.dataset.caseIndex = i; // Stocke l'indice r√©el de la case (0 √† 71)

                if (i === startCaseIndex) {
                    caseDiv.classList.add('start-case');
                    caseDiv.textContent = "D√©part";
                } else if (i === vestiaire1Index) {
                    caseDiv.classList.add('vestiaire-case');
                    addEmojiToCase(caseDiv, 'üíÉ', 'vestiaire-icon'); // Ic√¥ne pour le vestiaire v√™tements (Danseuse)
                    const textSpan = document.createElement('span');
                    textSpan.textContent = "Vestiaire";
                    caseDiv.appendChild(textSpan);
                } else if (i === vestiaire2Index) {
                    caseDiv.classList.add('vestiaire-case');
                    addEmojiToCase(caseDiv, 'üòâ', 'vestiaire-icon'); // Ic√¥ne pour le vestiaire sous-v√™tements (Clin d'≈ìil)
                    const textSpan = document.createElement('span');
                    textSpan.textContent = "Vestiaire";
                    caseDiv.appendChild(textSpan);
                } else if (i === finalCaseArrayIndex) {
                    caseDiv.textContent = "Arriv√©e"; // Derni√®re case
                    caseDiv.classList.add('level-5'); // La case d'arriv√©e est toujours de niveau 5
                }
                else {
                    // Cas normaux num√©rot√©s
                    currentNumberedCaseCount++;
                    caseDiv.textContent = currentNumberedCaseCount;

                    // Attribution des classes de niveau pour le style visuel
                    const visualCaseNum = currentNumberedCaseCount; // Utilise le compteur pour le niveau
                    if (visualCaseNum >= 1 && visualCaseNum <= 15) {
                        caseDiv.classList.add('level-1');
                    } else if (visualCaseNum >= 16 && visualCaseNum <= 30) {
                        caseDiv.classList.add('level-2');
                    } else if (visualCaseNum >= 31 && visualCaseNum <= 45) {
                        caseDiv.classList.add('level-3');
                    } else if (visualCaseNum >= 46 && visualCaseNum <= 60) {
                        caseDiv.classList.add('level-4');
                    } else if (visualCaseNum >= 61 && visualCaseNum <= 69) { // Cases de positions sexuelles
                        caseDiv.classList.add('level-5');
                        caseDiv.classList.add('sexual-position-case');
                        addEmojiToCase(caseDiv, 'üî•', 'sexual-position-emoji');
                    }

                    // Ajoute les classes et emojis pour les autres cases sp√©ciales
                    if (goBackCases.includes(i)) {
                        caseDiv.classList.add('go-back-case');
                        addEmojiToCase(caseDiv, '‚Ü©Ô∏è', 'go-back-emoji');
                    }
                    if (undressCases.includes(i)) {
                        caseDiv.classList.add('undress-case');
                        addEmojiToCase(caseDiv, 'üëó', 'undress-emoji');
                    }
                    if (actionCases.includes(i)) {
                        caseDiv.classList.add('action-case');
                        addEmojiToCase(caseDiv, '‚ö°', 'action-emoji');
                    }
                    if (truthOrDareCases.includes(i)) {
                        caseDiv.classList.add('truth-dare-case');
                        addEmojiToCase(caseDiv, '‚ùì', 'truth-dare-emoji');
                    }
                    if (massageSensoryCases.includes(i)) {
                        caseDiv.classList.add('massage-sensory-case');
                        addEmojiToCase(caseDiv, 'üñêÔ∏è', 'massage-sensory-emoji');
                    }
                    if (rolePlayCases.includes(i)) {
                        caseDiv.classList.add('role-play-case');
                        addEmojiToCase(caseDiv, 'üé≠', 'role-play-emoji');
                    }
                }
                gameBoardContainer.appendChild(caseDiv);
            }
            // Positionne les pions sur la case de d√©part apr√®s la cr√©ation du plateau
            updatePlayerTokenPositions(player1Token, player1Position);
            updatePlayerTokenPositions(player2Token, player2Position);
            scrollBoardToPlayers(); // Centre la vue sur le d√©part
            console.log("[createBoard] Plateau de jeu cr√©√©.");
        }

        /**
         * Ajoute un √©l√©ment emoji √† une case.
         * @param {HTMLElement} caseDiv - L'√©l√©ment DIV de la case.
         * @param {string} emojiChar - Le caract√®re emoji.
         * @param {string} className - La classe CSS √† ajouter au span de l'emoji.
         */
        function addEmojiToCase(caseDiv, emojiChar, className) {
            const emojiSpan = document.createElement('span');
            emojiSpan.classList.add('emoji-icon', className);
            emojiSpan.textContent = emojiChar;
            caseDiv.appendChild(emojiSpan);
        }

        /**
         * Met √† jour la position visuelle d'un pion sur le plateau.
         * @param {HTMLElement} tokenElement - L'√©l√©ment DOM du pion (player1Token ou player2Token).
         * @param {number} position - La nouvelle position (index de la case).
         */
        function updatePlayerTokenPositions(tokenElement, position) {
            const caseElement = document.querySelector(`.case[data-case-index="${position}"]`);
            if (caseElement) {
                // Calcule la position 'left' du pion par rapport au conteneur du plateau
                // Centre le pion sur la case
                tokenElement.style.left = `${caseElement.offsetLeft + (caseElement.offsetWidth / 2) - (tokenElement.offsetWidth / 2)}px`;
            }

            // G√®re le d√©calage si les deux pions sont sur la m√™me case
            if (player1Position === player2Position && player1Position !== startCaseIndex) { // Ne d√©cale pas sur la case D√©part
                player1Token.classList.add('on-same-case');
                player2Token.classList.add('on-same-case');
            } else {
                player1Token.classList.remove('on-same-case');
                player2Token.classList.remove('on-same-case');
            }
        }

        /**
         * Fait d√©filer le conteneur du plateau pour centrer la vue sur le joueur actif.
         */
        function scrollBoardToPlayers() {
            const currentPositionIndex = currentPlayer === 1 ? player1Position : player2Position;
            const caseElement = document.querySelector(`.case[data-case-index="${currentPositionIndex}"]`);

            if (caseElement) {
                // Calcule la position de d√©filement pour centrer la case actuelle
                const targetScrollLeft = caseElement.offsetLeft - (gameBoardContainer.offsetWidth / 2) + (caseElement.offsetWidth / 2);

                gameBoardContainer.scrollTo({
                    left: targetScrollLeft,
                    behavior: 'smooth' // D√©filement fluide
                });
            }
        }

        /**
         * Anime le d√©placement d'un pion case par case. Retourne une Promesse.
         * @param {HTMLElement} tokenElement - Le pion √† animer.
         * @param {number} startPos - Position de d√©part (index de la case).
         * @param {number} endPos - Position d'arriv√©e (index de la case).
         * @returns {Promise<void>} Une promesse qui se r√©sout une fois l'animation termin√©e.
         */
        function animatePlayerMovement(tokenElement, startPos, endPos) {
            return new Promise(resolve => {
                let currentPos = startPos;
                const stepDuration = 200; // Dur√©e de l'animation pour chaque case

                const moveStep = () => {
                    if (currentPos === endPos) {
                        resolve(); // R√©sout la promesse
                        return;
                    }

                    // D√©termine la direction du mouvement
                    const direction = (endPos > currentPos) ? 1 : -1;
                    currentPos += direction;

                    // Met √† jour la position visuelle du pion
                    updatePlayerTokenPositions(tokenElement, currentPos);
                    scrollBoardToPlayers(); // Fait d√©filer le plateau pour suivre le pion

                    // Appelle la prochaine √©tape apr√®s un d√©lai
                    setTimeout(moveStep, stepDuration);
                };

                moveStep(); // D√©marre l'animation
            });
        }

        /**
         * Affiche la face du d√© avec les points correspondants au nombre.
         * @param {number} number - Le nombre √† afficher sur le d√© (1-6).
         */
        function displayDiceFace(number) {
            // Cacher tous les points
            Object.values(diceDots).forEach(dot => {
                if (dot) dot.style.opacity = '0';
            });

            // Afficher les points pour le nombre donn√©
            switch (number) {
                case 1:
                    if (diceDots.center) diceDots.center.style.opacity = '1';
                    break;
                case 2:
                    if (diceDots['top-left']) diceDots['top-left'].style.opacity = '1';
                    if (diceDots['bottom-right']) diceDots['bottom-right'].style.opacity = '1';
                    break;
                case 3:
                    if (diceDots['top-left']) diceDots['top-left'].style.opacity = '1';
                    if (diceDots.center) diceDots.center.style.opacity = '1';
                    if (diceDots['bottom-right']) diceDots['bottom-right'].style.opacity = '1';
                    break;
                case 4:
                    if (diceDots['top-left']) diceDots['top-left'].style.opacity = '1';
                    if (diceDots['top-right']) diceDots['top-right'].style.opacity = '1';
                    if (diceDots['bottom-left']) diceDots['bottom-left'].style.opacity = '1';
                    if (diceDots['bottom-right']) diceDots['bottom-right'].style.opacity = '1';
                    break;
                case 5:
                    if (diceDots['top-left']) diceDots['top-left'].style.opacity = '1';
                    if (diceDots['top-right']) diceDots['top-right'].style.opacity = '1';
                    if (diceDots.center) diceDots.center.style.opacity = '1';
                    if (diceDots['bottom-left']) diceDots['bottom-left'].style.opacity = '1';
                    if (diceDots['bottom-right']) diceDots['bottom-right'].style.opacity = '1';
                    break;
                case 6:
                    if (diceDots['top-left']) diceDots['top-left'].style.opacity = '1';
                    if (diceDots['top-right']) diceDots['top-right'].style.opacity = '1';
                    if (diceDots['middle-left']) diceDots['middle-left'].style.opacity = '1';
                    if (diceDots['middle-right']) diceDots['middle-right'].style.opacity = '1';
                    if (diceDots['bottom-left']) diceDots['bottom-left'].style.opacity = '1';
                    if (diceDots['bottom-right']) diceDots['bottom-right'].style.opacity = '1';
                    break;
            }
        }


        /**
         * Affiche la pop-up de gage et retourne une promesse qui se r√©sout quand le gage est "termin√©".
         * @param {object} gage - L'objet gage contenant title, text, duration, accessories, imageUrl.
         * @returns {Promise<void>} Une promesse qui se r√©sout lorsque le bouton "Gage termin√©" est cliqu√©.
         */
        function showGag(gage) {
            return new Promise(resolve => {
                gagTitle.textContent = gage.title;
                let fullText = gage.text;
                if (gage.duration) {
                    fullText += `<br><br>Dur√©e estim√©e : ${gage.duration}`;
                }
                if (gage.accessories && gage.accessories.length > 0) {
                    fullText += `<br>Accessoires : ${gage.accessories.join(', ')}`;
                }
                gagText.innerHTML = fullText; // Utilise innerHTML pour les balises <br>

                // G√®re l'image du gage
                if (gage.imageUrl) {
                    gagImage.src = gage.imageUrl;
                    gagImage.style.display = 'block'; // Affiche l'image
                } else {
                    gagImage.style.display = 'none'; // Cache l'image si pas d'URL
                }

                gagPopup.style.display = 'flex';
                setTimeout(() => gagPopup.classList.add('active'), 10);

                // Stocke la fonction resolve pour qu'elle puisse √™tre appel√©e par le gestionnaire de clic global
                resolveGagPromise = resolve;
            });
        }

        /**
         * Cache la pop-up de gage.
         */
        function hideGag() {
            gagPopup.classList.remove('active');
            setTimeout(() => gagPopup.style.display = 'none', 300);
            gagImage.src = ''; // R√©initialise l'image pour le prochain gage
            if (resolveGagPromise) { // S'assure qu'il y a une promesse en attente
                resolveGagPromise(); // R√©sout la promesse
                resolveGagPromise = null; // Nettoie la r√©f√©rence √† la promesse r√©solue
            }
        }

        /**
         * Affiche la pop-up de victoire.
         * @param {string} winnerName - Le nom du joueur gagnant.
         * @returns {Promise<void>} Une promesse qui se r√©sout lorsque le bouton de victoire est cliqu√©.
         */
        function showVictoryScreen(winnerName) {
            return new Promise(resolve => {
                victoryTitle.textContent = `F√©licitations ${winnerName} !`;
                victoryMessage.textContent = `Tu as atteint la case ${totalOriginalCases} et remport√© le Jeu des Amoureux !`;

                victoryPopup.style.display = 'flex';
                setTimeout(() => victoryPopup.classList.add('active'), 10);

                resolveVictoryPromise = resolve; // Stocke la fonction resolve pour la victoire
            });
        }

        /**
         * Cache la pop-up de victoire.
         */
        function hideVictoryScreen() {
            victoryPopup.classList.remove('active');
            setTimeout(() => victoryPopup.style.display = 'none', 300);
            if (resolveVictoryPromise) {
                resolveVictoryPromise();
                resolveVictoryPromise = null;
            }
        }


        /**
         * Change l'ambiance visuelle du body en fonction du niveau atteint par les joueurs.
         * @param {number} position - La position la plus avanc√©e des joueurs (index du tableau).
         */
        function updateGameAmbiance(position) {
            let level = 1;
            const visualPosition = getVisualCaseNumber(position); // Utilise la position visuelle pour le niveau

            if (visualPosition >= 61) { // Visual cases 61-69 (sexual positions)
                level = 5;
            } else if (visualPosition >= 46) { // Visual cases 46-60
                level = 4;
            } else if (visualPosition >= 31) { // Visual cases 31-45
                level = 3;
            } else if (visualPosition >= 16) { // Visual cases 16-30
                level = 2;
            } else { // Visual cases 1-15 (and start case 0)
                level = 1;
            }
            document.body.style.backgroundColor = `var(--color-background-level${level})`;
        }

        /**
         * S√©lectionne un gage al√©atoire d'une cat√©gorie donn√©e.
         * @param {Array<object>} gageArray - Le tableau de gages de la cat√©gorie.
         * @param {number} currentVisualPosition - La position visuelle du joueur (pour les gages de niveau).
         * @returns {object} Le gage s√©lectionn√©.
         */
        function getRandomGage(gageArray, currentVisualPosition = -1) {
            let filtered = gageArray;
            if (currentVisualPosition !== -1) {
                let currentLevel = 1;
                // D√©termine le niveau en fonction de la position visuelle
                if (currentVisualPosition >= 61) {
                    currentLevel = 5;
                } else if (currentVisualPosition >= 46) {
                    currentLevel = 4;
                } else if (currentVisualPosition >= 31) {
                    currentLevel = 3;
                } else if (currentVisualPosition >= 16) {
                    currentLevel = 2;
                } else {
                    currentLevel = 1;
                }

                // Filtre par niveau si le tableau de gages a une propri√©t√© 'level'
                if (gageArray.length > 0 && gageArray[0].hasOwnProperty('level')) {
                    filtered = gageArray.filter(gage => gage.level === currentLevel);
                }
            }

            if (filtered.length === 0) {
                console.warn(`Aucun gage trouv√© pour la cat√©gorie ou le niveau sp√©cifi√© (position visuelle: ${currentVisualPosition}, array length: ${gageArray.length}). Retourne un gage par d√©faut.`);
                return { title: "D√©fi G√©n√©ral !", text: "Un d√©fi inattendu pour vous deux !", duration: "", accessories: [], imageUrl: "" };
            }
            const randomIndex = Math.floor(Math.random() * filtered.length);
            return filtered[randomIndex];
        }


        /**
         * S√©lectionne un gage appropri√© en fonction de la position sur le plateau et du type de case.
         * @param {number} positionArrayIndex - L'index de la case d'arriv√©e dans le tableau.
         * @param {string} caseType - Le type de case ('normal', 'go-back', 'action', 'surprise', 'vestiaire-clothes', 'vestiaire-underwear', 'truth-dare', 'massage-sensory', 'role-play', 'sexual-position', 'final-gage').
         * @param {number} [stepsReceded=0] - Le nombre de cases recul√©es (pour les gages de retour).
         * @returns {object} Le gage s√©lectionn√©.
         */
        function getGage(positionArrayIndex, caseType, stepsReceded = 0) {
            let selectedGage;
            const currentPlayerName = currentPlayer === 1 ? player1Name : player2Name;
            const otherPlayerName = currentPlayer === 1 ? player2Name : player1Name;
            let playerClothesCount = currentPlayer === 1 ? player1Clothes : player2Clothes;
            let playerUnderwearCount = currentPlayer === 1 ? player1Underwear : player2Underwear;

            // D√©termine la position visuelle pour le filtrage des gages par niveau
            const visualPosition = getVisualCaseNumber(positionArrayIndex);

            if (caseType === 'final-gage') {
                selectedGage = getRandomGage(finalGageData, visualPosition);
            } else if (caseType === 'vestiaire-clothes') {
                selectedGage = vestiaireGagesData.clothes;
            } else if (caseType === 'vestiaire-underwear') {
                selectedGage = vestiaireGagesData.underwear;
            } else if (caseType === 'go-back') {
                selectedGage = getRandomGage(goBackGagesData, visualPosition);
                selectedGage.text = selectedGage.text.replace(/\[steps\]/g, stepsReceded);
            } else if (caseType === 'sexual-position') {
                selectedGage = getRandomGage(sexualPositionsGagesData, visualPosition);
            } else if (caseType === 'undress') {
                // Les gages de sous-v√™tements (type 'underwear') ne sont disponibles qu'√† partir du niveau 3.
                // Le niveau 3 commence √† la case visuelle 31.
                const isUnderwearLevel = visualPosition >= 31;

                if (playerClothesCount > 0) {
                    selectedGage = getRandomGage(undressGagesData.filter(g => g.type === 'clothes'), visualPosition);
                    // D√©cr√©mente le v√™tement
                    if (currentPlayer === 1) player1Clothes--; else player2Clothes--;
                } else if (playerUnderwearCount > 0 && isUnderwearLevel) { // Ne retire les sous-v√™tements que si au bon niveau
                    selectedGage = getRandomGage(undressGagesData.filter(g => g.type === 'underwear'), visualPosition);
                    // D√©cr√©mente le sous-v√™tement
                    if (currentPlayer === 1) player1Underwear--; else player2Underwear--;
                } else {
                    // Compl√®tement nu OU pas encore au niveau des sous-v√™tements, donne un gage action √† la place
                    selectedGage = getRandomGage(actionGagesData, visualPosition);
                }
            } else if (caseType === 'action') {
                selectedGage = getRandomGage(actionGagesData, visualPosition);
            } else if (caseType === 'truth-dare') {
                selectedGage = getRandomGage(truthOrDareGagesData, visualPosition);
            } else if (caseType === 'massage-sensory') {
                selectedGage = getRandomGage(massageSensoryGagesData, visualPosition);
            } else if (caseType === 'role-play') {
                selectedGage = getRandomGage(rolePlayGagesData, visualPosition);
            } else if (caseType === 'surprise') {
                selectedGage = getRandomGage(surpriseGagesData, visualPosition); // Surprise gages don't have levels, but pass anyway
            } else { // Fallback, should not happen if all cases are assigned a type
                console.warn("Type de case inconnu ou non g√©r√©. Retourne un gage par d√©faut.");
                selectedGage = { title: "D√©fi G√©n√©ral !", text: "Un d√©fi inattendu pour vous deux !", duration: "", accessories: [], imageUrl: "" };
            }

            // Remplace les placeholders par les pr√©noms des joueurs dans le texte final
            let finalGageText = selectedGage.text
                .replace(/\[joueur\]/g, currentPlayerName)
                .replace(/\[autreJoueur\]/g, otherPlayerName);

            return {
                title: selectedGage.title,
                text: finalGageText,
                duration: selectedGage.duration,
                accessories: selectedGage.accessories,
                imageUrl: selectedGage.imageUrl
            };
        }

        /**
         * Met √† jour les classes de th√®me (bleu ou rose) en fonction du joueur actuel.
         */
        function updateTheme() {
            if (currentPlayer === 1) { // Joueur 1 (homme)
                currentPlayerNameDisplay.parentElement.classList.add('blue-theme');
                diceContainer.classList.add('blue-theme');
                diceArea.classList.add('blue-theme'); // Ajoute la classe au conteneur du d√© et au bouton
            } else { // Joueur 2 (femme)
                currentPlayerNameDisplay.parentElement.classList.remove('blue-theme');
                diceContainer.classList.remove('blue-theme');
                diceArea.classList.remove('blue-theme'); // Retire la classe
            }
        }


        /**
         * G√®re le tour d'un joueur, incluant le d√©placement, la gestion des gages et le changement de tour.
         * @param {number} potentialNewPosition - La position cible potentielle apr√®s le lancer de d√© (index du tableau).
         */
        async function handlePlayerTurn(potentialNewPosition) {
            if (isMoving) return;

            isMoving = true;
            rollDiceButton.disabled = true;
            manualMoveButton.disabled = true;

            try {
                let currentToken = currentPlayer === 1 ? player1Token : player2Token;
                let oldPosition = currentPlayer === 1 ? player1Position : player2Position;
                let playerPositionVariable = currentPlayer === 1 ? 'player1Position' : 'player2Position';

                let finalDestination = Math.min(finalCaseArrayIndex, potentialNewPosition); // La case finale th√©orique apr√®s le lancer de d√©

                let stopAtVestiaire = null;
                // V√©rifie si le joueur passe ou atterrit sur le Vestiaire 1
                if (oldPosition < vestiaire1Index && finalDestination >= vestiaire1Index) {
                    stopAtVestiaire = vestiaire1Index;
                }
                // V√©rifie si le joueur passe ou atterrit sur le Vestiaire 2 (et n'a pas d√©j√† √©t√© arr√™t√© au Vestiaire 1)
                if (oldPosition < vestiaire2Index && finalDestination >= vestiaire2Index && (stopAtVestiaire === null || stopAtVestiaire < vestiaire2Index)) {
                    stopAtVestiaire = vestiaire2Index;
                }

                if (stopAtVestiaire !== null) {
                    // Le joueur doit s'arr√™ter au vestiaire
                    const vestiaireType = stopAtVestiaire === vestiaire1Index ? 'vestiaire-clothes' : 'vestiaire-underwear';
                    const gage = getGage(stopAtVestiaire, vestiaireType);

                    // D√©place le pion jusqu'au vestiaire
                    if (currentPlayer === 1) player1Position = stopAtVestiaire; else player2Position = stopAtVestiaire;
                    await animatePlayerMovement(currentToken, oldPosition, stopAtVestiaire);
                    updateGameAmbiance(Math.max(player1Position, player2Position));

                    // Affiche le gage du vestiaire
                    await showGag(gage);

                    // Le tour se termine ici. Le joueur est maintenant sur la case vestiaire.
                    // Au prochain tour, il relancera le d√© de cette position.
                    currentPlayer = currentPlayer === 1 ? 2 : 1; // Change de joueur
                    currentPlayerNameDisplay.textContent = currentPlayer === 1 ? player1Name : player2Name;
                    updateTheme();

                } else {
                    // Pas d'arr√™t au vestiaire, le joueur se d√©place directement vers la destination finale
                    if (currentPlayer === 1) player1Position = finalDestination; else player2Position = finalDestination;
                    await animatePlayerMovement(currentToken, oldPosition, finalDestination);
                    updateGameAmbiance(Math.max(player1Position, player2Position));

                    let currentLandingPosition = finalDestination; // La position o√π le joueur a finalement atterri
                    let caseTypeAtLanding = 'normal';
                    let stepsReceded = 0;

                    // D√©termine le type de case √† la position d'atterrissage actuelle
                    if (currentLandingPosition === finalCaseArrayIndex) {
                        caseTypeAtLanding = 'final-gage';
                    } else if (goBackCases.includes(currentLandingPosition)) {
                        caseTypeAtLanding = 'go-back';
                        stepsReceded = Math.floor(Math.random() * 6) + 1;
                    } else if (sexualPositionsStartCase <= currentLandingPosition && currentLandingPosition < finalCaseArrayIndex) {
                        caseTypeAtLanding = 'sexual-position';
                    } else if (undressCases.includes(currentLandingPosition)) {
                        caseTypeAtLanding = 'undress';
                    } else if (actionCases.includes(currentLandingPosition)) {
                        caseTypeAtLanding = 'action';
                    } else if (truthOrDareCases.includes(currentLandingPosition)) {
                        caseTypeAtLanding = 'truth-dare';
                    } else if (massageSensoryCases.includes(currentLandingPosition)) {
                        caseTypeAtLanding = 'massage-sensory';
                    } else if (rolePlayCases.includes(currentLandingPosition)) {
                        caseTypeAtLanding = 'role-play';
                    }

                    // V√©rifie si les joueurs sont sur la m√™me case (surprise)
                    if (player1Position === player2Position && player1Position !== startCaseIndex && player1Position !== vestiaire1Index && player1Position !== vestiaire2Index) {
                        caseTypeAtLanding = 'surprise';
                    }

                    let gageToExecute = getGage(currentLandingPosition, caseTypeAtLanding, stepsReceded);
                    await showGag(gageToExecute);

                    // Si c'√©tait une case "Retour en arri√®re", g√®re le mouvement de recul et le gage de la nouvelle case
                    if (caseTypeAtLanding === 'go-back') {
                        const recedeFromPosition = currentLandingPosition;
                        const recedeToPosition = Math.max(startCaseIndex, recedeFromPosition - stepsReceded);

                        if (currentPlayer === 1) player1Position = recedeToPosition; else player2Position = recedeToPosition;
                        await animatePlayerMovement(currentToken, recedeFromPosition, recedeToPosition);
                        updateGameAmbiance(Math.max(player1Position, player2Position));

                        // R√©√©value le type de case √† la position de recul
                        let recededCaseType = 'normal';
                        if (recedeToPosition === finalCaseArrayIndex) {
                            recededCaseType = 'final-gage';
                        } else if (recedeToPosition === vestiaire1Index) {
                            recededCaseType = 'vestiaire-clothes';
                        } else if (recedeToPosition === vestiaire2Index) {
                            recededCaseType = 'vestiaire-underwear';
                        } else if (sexualPositionsStartCase <= recedeToPosition && recedeToPosition < finalCaseArrayIndex) {
                            recededCaseType = 'sexual-position';
                        } else if (undressCases.includes(recedeToPosition)) {
                            recededCaseType = 'undress';
                        } else if (actionCases.includes(recedeToPosition)) {
                            recededCaseType = 'action';
                        } else if (truthOrDareCases.includes(recedeToPosition)) {
                            recededCaseType = 'truth-dare';
                        } else if (massageSensoryCases.includes(recedeToPosition)) {
                            recededCaseType = 'massage-sensory';
                        } else if (rolePlayCases.includes(recedeToPosition)) {
                            recededCaseType = 'role-play';
                        }

                        // V√©rifie si les joueurs sont sur la m√™me case (surprise) √† la position de recul
                        if (player1Position === player2Position && player1Position !== startCaseIndex && player1Position !== vestiaire1Index && player1Position !== vestiaire2Index) {
                            recededCaseType = 'surprise';
                        }

                        // Affiche un nouveau gage si la case de recul est sp√©ciale (et n'est pas un autre "retour en arri√®re" pour √©viter les boucles)
                        if (recededCaseType !== 'normal' && recededCaseType !== 'go-back') {
                            let recededGage = getGage(recedeToPosition, recededCaseType);
                            await showGag(recededGage);
                        }
                    }

                    // V√©rifie la victoire apr√®s tous les mouvements et gages
                    if (player1Position === finalCaseArrayIndex) {
                        await showVictoryScreen(player1Name);
                    } else if (player2Position === finalCaseArrayIndex) {
                        await showVictoryScreen(player2Name);
                    } else {
                        currentPlayer = currentPlayer === 1 ? 2 : 1;
                        currentPlayerNameDisplay.textContent = currentPlayer === 1 ? player1Name : player2Name;
                        updateTheme();
                    }
                } // Fin du bloc 'else' pour les mouvements sans vestiaire
            } catch (error) {
                console.error("Une erreur est survenue pendant le tour du joueur :", error);
            } finally {
                isMoving = false;
                rollDiceButton.disabled = false;
                manualMoveButton.disabled = false;
            }
        }

        /**
         * R√©initialise toutes les variables d'√©tat du jeu et revient √† l'√©cran de d√©marrage.
         */
        function resetGame() {
            console.log("[resetGame] R√©initialisation du jeu...");
            player1Position = startCaseIndex; // R√©initialise √† la case de d√©part
            player2Position = startCaseIndex; // R√©initialise √† la case de d√©part
            player1Clothes = parseInt(player1ClothesInput.value, 10);
            player1Underwear = parseInt(player1UnderwearInput.value, 10);
            player2Clothes = parseInt(player2ClothesInput.value, 10);
            player2Underwear = parseInt(player2UnderwearInput.value, 10);
            currentPlayer = 1;
            gameReady = false;
            isMoving = false;

            // Masquer les √©crans de jeu et de pop-up
            gameScreen.style.display = 'none';
            gagPopup.style.display = 'none';
            victoryPopup.style.display = 'none';
            debugControls.style.display = 'none';
            adminPopup.style.display = 'none'; // Cache aussi la popup admin

            // Afficher l'√©cran de d√©marrage
            startScreen.style.display = 'flex';
            updateGameAmbiance(startCaseIndex); // R√©initialiser l'ambiance √† la case de d√©part

            // R√©initialiser les s√©lections d'emojis
            initializeEmojiOptions(maleEmojiOptionsDiv, maleEmojis, 'male');
            initializeEmojiOptions(femaleEmojiOptionsDiv, femaleEmojis, 'female');

            // R√©initialiser le d√© √† sa face par d√©faut
            displayDiceFace(1);
            updateTheme(); // S'assurer que le th√®me est correct au reset (bleu pour le joueur 1 au d√©but)
            console.log("[resetGame] Jeu r√©initialis√©.");
        }

        /**
         * Charge les donn√©es des gages depuis Firestore.
         */
        async function loadGagesFromFirestore() {
            // V√©rifie si Firebase est initialis√© avant de tenter d'acc√©der √† db
            if (!db) {
                console.error("[loadGagesFromFirestore] Firebase Firestore n'est pas initialis√©. Impossible de charger les gages.");
                showMessage("Erreur: Firebase non initialis√©. Impossible de charger les gages.");
                loadingIndicator.style.display = 'none';
                return;
            }

            console.log("[loadGagesFromFirestore] D√©but du chargement des gages depuis Firestore...");
            loadingIndicator.textContent = "Chargement des gages...";
            loadingIndicator.style.display = 'block';

            try {
                // Chemin pour les donn√©es publiques des gages
                const gagesCollectionRef = collection(db, `artifacts/${appId}/public/data/gages`);

                // R√©cup√®re tous les documents de la collection 'gages'
                const querySnapshot = await getDocs(gagesCollectionRef);
                console.log("[loadGagesFromFirestore] QuerySnapshot obtenu. Nombre de documents:", querySnapshot.docs.length);

                // V√©rifie si les gages sont vides ou incomplets (par exemple, si la cat√©gorie 'action' manque)
                if (querySnapshot.empty || !querySnapshot.docs.some(doc => doc.id === 'action')) {
                    console.warn("[loadGagesFromFirestore] Aucune donn√©e de gages trouv√©e ou incompl√®te dans Firestore. Initialisation des donn√©es par d√©faut...");
                    await initializeDefaultGagesInFirestore();
                    // Apr√®s l'initialisation, on les recharge pour s'assurer d'avoir les donn√©es fra√Æches
                    const reQuerySnapshot = await getDocs(gagesCollectionRef);
                    reQuerySnapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        switch (docSnap.id) {
                            case 'go_back': goBackGagesData = data.gages || []; break;
                            case 'surprise': surpriseGagesData = data.gages || []; break;
                            case 'action': actionGagesData = data.gages || []; break;
                            case 'undress': undressGagesData = data.gages || []; break;
                            case 'truth_dare': truthOrDareGagesData = data.gages || []; break;
                            case 'massage_sensory': massageSensoryGagesData = data.gages || []; break;
                            case 'role_play': rolePlayGagesData = data.gages || []; break;
                            case 'sexual_positions': sexualPositionsGagesData = data.gages || []; break;
                            case 'final_gage': finalGageData = data.gages || []; break;
                            case 'vestiaire': vestiaireGagesData = data; break; // Vestiaire est un objet, pas un tableau
                            default: console.warn(`[loadGagesFromFirestore] Cat√©gorie de gage inconnue: ${docSnap.id}`);
                        }
                    });
                } else {
                    querySnapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        switch (docSnap.id) {
                            case 'go_back': goBackGagesData = data.gages || []; break;
                            case 'surprise': surpriseGagesData = data.gages || []; break;
                            case 'action': actionGagesData = data.gages || []; break;
                            case 'undress': undressGagesData = data.gages || []; break;
                            case 'truth_dare': truthOrDareGagesData = data.gages || []; break;
                            case 'massage_sensory': massageSensoryGagesData = data.gages || []; break;
                            case 'role_play': rolePlayGagesData = data.gages || []; break;
                            case 'sexual_positions': sexualPositionsGagesData = data.gages || []; break;
                            case 'final_gage': finalGageData = data.gages || []; break;
                            case 'vestiaire': vestiaireGagesData = data; break; // Vestiaire est un objet, pas un tableau
                            default: console.warn(`[loadGagesFromFirestore] Cat√©gorie de gage inconnue: ${docSnap.id}`);
                        }
                    });
                }
                console.log("[loadGagesFromFirestore] Gages charg√©s depuis Firestore avec succ√®s !");
            } catch (error) {
                console.error("[loadGagesFromFirestore] Erreur lors du chargement des gages depuis Firestore :", error);
                showMessage("Impossible de charger les gages. Veuillez v√©rifier votre connexion ou les r√®gles Firebase.");
                // Fallback to empty arrays if Firestore fails
                goBackGagesData = [];
                surpriseGagesData = [];
                actionGagesData = [];
                undressGagesData = [];
                truthOrDareGagesData = [];
                massageSensoryGagesData = [];
                rolePlayGagesData = [];
                sexualPositionsGagesData = [];
                finalGageData = [];
                vestiaireGagesData = {};
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        /**
         * Initialise les gages par d√©faut dans Firestore si les collections sont vides.
         * Cette fonction est √† appeler une seule fois ou quand les gages sont manquants.
         */
        async function initializeDefaultGagesInFirestore() {
            // V√©rifie si db est d√©fini avant de l'utiliser
            if (!db) {
                console.error("[initializeDefaultGagesInFirestore] Firebase Firestore n'est pas initialis√©. Impossible d'initialiser les gages par d√©faut.");
                return;
            }
            console.log("[initializeDefaultGagesInFirestore] Initialisation des gages par d√©faut dans Firestore...");
            const gagesCollectionRef = collection(db, `artifacts/${appId}/public/data/gages`);

            const defaultGages = {
                go_back: [
                    { title: "Oups ! Retour en arri√®re !", text: "[joueur] recule de [steps] cases !", duration: "5s", accessories: [], imageUrl: "https://www.fullmoon.info/wp-content/uploads/2013/12/moonwalk_198x198.jpg" },
                    { title: "Demi-tour !", text: "Le chemin est bloqu√© ! [joueur] doit reculer de [steps] cases.", duration: "5s", accessories: [], imageUrl: "https://www.fullmoon.info/wp-content/uploads/2013/12/moonwalk_198x198.jpg" },
                    { title: "Faute de parcours !", text: "Tu as fait une erreur ! Recule de [steps] cases.", duration: "5s", accessories: [], imageUrl: "https://www.fullmoon.info/wp-content/uploads/2013/12/moonwalk_198x198.jpg" }
                ],
                surprise: [
                    { title: "Surprise ! Fusion !", text: "Lorsque [joueur] arrive sur la case de [autreJoueur], les deux joueurs doivent s'embrasser passionn√©ment pendant 30 secondes sans s'arr√™ter.", duration: "30s", accessories: [], imageUrl: "https://eqomcdn.com/content/photos/products/loveboxxx/40818/1625156791.LBX03-01.jpg" },
                    { title: "Surprise ! Miroir !", text: "Lorsque [joueur] arrive sur la case de [autreJoueur], les deux joueurs doivent imiter les mouvements de l'autre pendant 1 minute, de mani√®re sensuelle.", duration: "1min", accessories: [], imageUrl: "https://eqomcdn.com/content/photos/products/loveboxxx/40818/1625156791.LBX03-01.jpg" },
                    { title: "Surprise ! Duo !", text: "Lorsque [joueur] arrive sur la case de [autreJoueur], les deux joueurs doivent se d√©shabiller mutuellement en m√™me temps, jusqu'√† ce qu'ils soient tous les deux en sous-v√™tements.", duration: "1min", accessories: [], imageUrl: "https://eqomcdn.com/content/photos/products/loveboxxx/40818/1625156791.LBX03-01.jpg" },
                    { title: "Surprise ! Chuchotements Entrem√™l√©s !", text: "Lorsque [joueur] arrive sur la case de [autreJoueur], chuchotez-vous mutuellement des mots doux et coquins √† l'oreille en m√™me temps pendant 30 secondes.", duration: "30s", accessories: [], imageUrl: "https://eqomcdn.com/content/photos/products/loveboxxx/40818/1625156791.LBX03-01.jpg" },
                    { title: "Surprise ! Contact Peau √† Peau !", text: "Lorsque [joueur] arrive sur la case de [autreJoueur], les deux joueurs doivent se coller l'un √† l'autre, peau contre peau, pendant 1 minute.", duration: "1min", accessories: [], imageUrl: "https://eqomcdn.com/content/photos/products/loveboxxx/40818/1625156791.LBX03-01.jpg" }
                ],
                action: [
                    { level: 1, title: "Action Douce 1", text: "Fais un compliment sinc√®re √† [autreJoueur].", duration: "10s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 1, title: "Action Douce 2", text: "Propose un c√¢lin spontan√© √† [autreJoueur].", duration: "15s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 1, title: "Action Douce 3", text: "Chuchote un secret amusant √† l'oreille de [autreJoueur].", duration: "10s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 2, title: "Action Chaude 1", text: "Danse sensuellement pour [autreJoueur] pendant 30 secondes.", duration: "30s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 2, title: "Action Chaude 2", text: "Vole un baiser sur le cou de [autreJoueur].", duration: "5s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 2, title: "Action Chaude 3", text: "Fais un regard intense √† [autreJoueur] sans cligner des yeux pendant 15 secondes.", duration: "15s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 3, title: "Action Tr√®s Chaude 1", text: "√âchange un baiser langoureux avec [autreJoueur] pendant 20 secondes.", duration: "20s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 3, title: "Action Tr√®s Chaude 2", text: "Fais un strip-tease partiel (enl√®ve un v√™tement) pour [autreJoueur].", duration: "1min", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 3, title: "Action Tr√®s Chaude 3", text: "Prends un selfie suggestif avec [autreJoueur].", duration: "30s", accessories: ["Smartphone"], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 4, title: "Action Torride 1", text: "Donne un baiser passionn√© √† [autreJoueur] sur une partie du corps inattendue.", duration: "15s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 4, title: "Action Torride 2", text: "Fais un lap dance pour [autreJoueur] pendant 1 minute.", duration: "1min", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" },
                    { level: 4, title: "Action Torride 3", text: "Chuchote ton fantasme le plus secret √† [autreJoueur].", duration: "30s", accessories: [], imageUrl: "https://thumbs.dreamstime.com/b/homme-caressant-une-femme-58084899.jpg" }
                ],
                undress: [
                    { level: 1, type: 'clothes', title: "D√©shabillage Doux 1", text: "[joueur] retire un v√™tement de son choix.", duration: "15s", accessories: [], imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg" },
                    { level: 1, type: 'clothes', title: "D√©shabillage Doux 2", text: "[joueur] retire un accessoire (montre, collier, chaussette).", duration: "10s", accessories: [], imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg" },
                    { level: 2, type: 'clothes', title: "D√©shabillage Chaud 1", text: "[joueur] retire un v√™tement de son choix, lentement.", duration: "20s", accessories: [], imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg" },
                    { level: 2, type: 'clothes', title: "D√©shabillage Chaud 2", text: "[joueur] retire un v√™tement que [autreJoueur] choisit (pas les sous-v√™tements !).", duration: "20s", accessories: [], imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg" },
                    { level: 3, type: 'clothes', title: "D√©shabillage Tr√®s Chaud 1", text: "[joueur] retire un v√™tement en faisant monter le d√©sir de [autreJoueur].", duration: "30s", accessories: [], imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg" },
                    { level: 3, type: 'underwear', title: "D√©shabillage Tr√®s Chaud 2", text: "[joueur] retire un sous-v√™tement de son choix.", duration: "30s", accessories: [], imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg" },
                    { level: 4, type: 'clothes', title: "D√©shabillage Torride 1", text: "[joueur] retire un v√™tement en regardant [autreJoueur] dans les yeux.", duration: "45s", accessories: [], imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg" },
                    { level: 4, type: 'underwear', title: "D√©shabillage Torride 2", text: "[joueur] retire son dernier sous-v√™tement (s'il en reste) ou un autre sous-v√™tement.", duration: "45s", accessories: [], imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg" }
                ],
                truth_dare: [
                    { level: 1, title: "V√©rit√© Douce 1", text: "Quel est ton souvenir pr√©f√©r√© de notre premier baiser ?", duration: "30s", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" },
                    { level: 1, title: "Ose Doux 1", text: "Fais-moi un clin d'≈ìil s√©ducteur.", duration: "5s", accessories: [], imageUrl: "https://www.union.fr/wp-content/uploads/2019/01/gettyimages-97538561.jpg" },
                    { level: 1, title: "V√©rit√© Douce 2", text: "Quelle est la chose la plus mignonne que j'aie jamais faite ?", duration: "30s", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" },
                    { level: 1, title: "Ose Doux 2", text: "Tiens ma main pendant le reste du tour.", duration: "1min", accessories: [], imageUrl: "https://www.union.fr/wp-content/uploads/2019/01/gettyimages-97538561.jpg" },
                    { level: 1, title: "V√©rit√© Douce 3", text: "Si tu pouvais changer une chose chez moi, ce serait quoi (gentiment) ?", duration: "45s", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" },
                    { level: 2, title: "V√©rit√© Chaude 1", text: "Quel est ton endroit pr√©f√©r√© pour un baiser (sur le corps) ?", duration: "30s", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" },
                    { level: 2, title: "Ose Chaud 1", text: "Chuchote-moi quelque chose de coquin √† l'oreille.", duration: "10s", accessories: [], imageUrl: "https://www.union.fr/wp-content/uploads/2019/01/gettyimages-97538561.jpg" },
                    { level: 2, title: "V√©rit√© Chaude 2", text: "Quel est le compliment le plus sexy que tu m'aies jamais fait ou voulu me faire ?", duration: "45s", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" },
                    { level: 2, title: "Ose Chaud 2", text: "Fais-moi un bisou qui me donne des frissons.", duration: "10s", accessories: [], imageUrl: "https://www.union.fr/wp-content/uploads/2019/01/gettyimages-97538561.jpg" },
                    { level: 3, title: "V√©rit√© Tr√®s Chaude 1", text: "Quel est un fantasme que tu n'as jamais os√© partager avec moi ?", duration: "1min", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" },
                    { level: 3, title: "Ose Tr√®s Chaud 1", text: "L√®che un morceau de chocolat sur mon bras.", duration: "30s", accessories: ["Chocolat"], imageUrl: "https://www.union.fr/wp-content/uploads/2019/01/gettyimages-97538561.jpg" },
                    { level: 3, title: "V√©rit√© Tr√®s Chaude 2", text: "Quelle est la chose la plus coquine que tu aies jamais faite en public ?", duration: "1min", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" },
                    { level: 4, title: "V√©rit√© Torride 1", text: "D√©cris-moi en d√©tail ce que tu aimerais que je te fasse ce soir.", duration: "2min", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" },
                    { level: 4, title: "Ose Torride 1", text: "Enl√®ve un v√™tement de [autreJoueur] avec ta bouche (si possible).", duration: "1min", accessories: [], imageUrl: "https://www.union.fr/wp-content/uploads/2019/01/gettyimages-97538561.jpg" },
                    { level: 4, title: "V√©rit√© Torride 2", text: "Quelle est ta position sexuelle pr√©f√©r√©e et pourquoi ?", duration: "1min", accessories: [], imageUrl: "https://img.pixers.pics/pho_wat(s3:700/FO/60/36/92/01/700_FO60369201_feed8d48e19113dfceccfac14af3eef9.jpg,700,700,cms:2018/10/5bd1b6b8d04b8_220x50-watermark.png,over,480,650,jpg)/posters-gros-closen-d-39-une-femme-levres-avec-le-doigt-pour-demander-le-silence.jpg.jpg" }
                ],
                massage_sensory: [
                    { level: 1, title: "Massage Doux 1", text: "Masse les mains de [autreJoueur] pendant 1 minute.", duration: "1min", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 1, title: "Sensation Douce 1", text: "Effleure d√©licatement le bras de [autreJoueur] du bout des doigts pendant 30 secondes.", duration: "30s", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 1, title: "Massage Doux 2", text: "Caresses les cheveux de [autreJoueur] pendant 1 minute.", duration: "1min", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 1, title: "Sensation Douce 2", text: "Souffle doucement dans le cou de [autreJoueur].", duration: "15s", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 2, title: "Massage Chaud 1", text: "Masse les √©paules de [autreJoueur] pendant 1 minute.", duration: "1min", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 2, title: "Sensation Chaude 1", text: "Chatouille l√©g√®rement [autreJoueur] sur une zone sensible (pieds, cou, flancs) pendant 30 secondes.", duration: "30s", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 2, title: "Massage Chaud 2", text: "Caresses les cuisses de [autreJoueur] par-dessus les v√™tements pendant 1 minute.", duration: "1min", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 3, title: "Massage Tr√®s Chaud 1", text: "Masse la nuque et le haut du dos de [autreJoueur] avec de l'huile de massage pendant 2 minutes.", duration: "2min", accessories: ["Huile de massage"], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 3, title: "Sensation Tr√®s Chaude 1", text: "Passe un gla√ßon sur le cou et la poitrine de [autreJoueur] pendant 30 secondes.", duration: "30s", accessories: ["Gla√ßon"], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 3, title: "Massage Tr√®s Chaud 2", text: "Masse les pieds de [autreJoueur] avec tes mains ou tes pieds pendant 1 minute.", duration: "1min", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 4, title: "Massage Torride 1", text: "Masse les fesses de [autreJoueur] par-dessus les sous-v√™tements pendant 2 minutes.", duration: "2min", accessories: [], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 4, title: "Sensation Torride 1", text: "Utilise une plume ou un pinceau pour caresser les zones sensibles de [autreJoueur] pendant 1 minute.", duration: "1min", accessories: ["Plume/Pinceau"], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" },
                    { level: 4, title: "Massage Torride 2", text: "Masse l'int√©rieur des cuisses de [autreJoueur] avec de l'huile pendant 2 minutes.", duration: "2min", accessories: ["Huile de massage"], imageUrl: "https://img.freepik.com/photos-gratuite/homme-masser-dos-femme_23-2148531257.jpg" }
                ],
                role_play: [
                    { level: 2, title: "Jeu de R√¥le Chaud 1", text: "Fais semblant d'√™tre un/une parfait(e) inconnu(e) qui essaie de s√©duire [autreJoueur] avec 3 phrases.", duration: "1min", accessories: [], imageUrl: "https://previews.123rf.com/images/wisky/wisky1409/wisky140900126/31530661-sexy-police-officers-isolated-on-white-background.jpg" },
                    { level: 2, title: "Jeu de R√¥le Chaud 2", text: "Incarne un personnage de film romantique et fais une d√©claration d'amour √† [autreJoueur].", duration: "1min", accessories: [], imageUrl: "https://previews.123rf.com/images/wisky/wisky1409/wisky140900126/31530661-sexy-police-officers-isolated-on-white-background.jpg" },
                    { level: 3, title: "Jeu de R√¥le Tr√®s Chaud 1", text: "Pendant 5 minutes, [joueur] est ton ma√Ætre/ma√Ætresse et tu dois ob√©ir √† ses ordres (simples et non dangereux).", duration: "5min", accessories: [], imageUrl: "https://previews.123rf.com/images/wisky/wisky1409/wisky140900126/31530661-sexy-police-officers-isolated-on-white-background.jpg" },
                    { level: 3, title: "Jeu de R√¥le Tr√®s Chaud 2", text: "Fais semblant d'√™tre un/une espion(ne) sexy qui doit r√©cup√©rer des informations aupr√®s de [autreJoueur] par la s√©duction.", duration: "2min", accessories: [], imageUrl: "https://previews.123rf.com/images/wisky/wisky1409/wisky140900126/31530661-sexy-police-officers-isolated-on-white-background.jpg" },
                    { level: 3, title: "Jeu de R√¥le Tr√®s Chaud 3", text: "Incarne un personnage de ton choix et s√©duis [autreJoueur] pendant 2 minutes.", duration: "2min", accessories: [], imageUrl: "https://previews.123rf.com/images/wisky/wisky1409/wisky140900126/31530661-sexy-police-officers-isolated-on-white-background.jpg" },
                    { level: 4, title: "Jeu de R√¥le Torride 1", text: "Fais semblant d'√™tre un/une strip-teaseur/euse priv√©(e) pour [autreJoueur] pendant 2 minutes.", duration: "2min", accessories: [], imageUrl: "https://previews.123rf.com/images/wisky/wisky1409/wisky140900126/31530661-sexy-police-officers-isolated-on-white-background.jpg" },
                    { level: 4, title: "Jeu de R√¥le Torride 2", text: "Incarne un personnage dominant/soumis de ton choix et explore cette dynamique avec [autreJoueur] pendant 3 minutes.", duration: "3min", accessories: [], imageUrl: "https://previews.123rf.com/images/wisky/wisky1409/wisky140900126/31530661-sexy-police-officers-isolated-on-white-background.jpg" },
                    { level: 4, title: "Jeu de R√¥le Torride 3", text: "Inventez ensemble un sc√©nario coquin et incarnez-le pendant 5 minutes.", duration: "5min", accessories: [], imageUrl: "https://previews.123rf.com/images/wisky/wisky1409/wisky140900126/31530661-sexy-police-officers-isolated-on-white-background.jpg" }
                ],
                sexual_positions: [
                    { title: "La Cuill√®re Coquine", text: "Allongez-vous en position de cuill√®re, mais avec un contact peau √† peau maximal.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "5min+", accessories: [] },
                    { title: "Le Baiser Papillon", text: "Face √† face, vos corps coll√©s, √©changez des baisers doux et l√©gers sur tout le visage et le cou.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "3min", accessories: [] },
                    { title: "Le N≈ìud Amoureux", text: "Enlacez vos jambes et vos bras de mani√®re √† former un n≈ìud, en vous serrant fort l'un contre l'autre.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "2min", accessories: [] },
                    { title: "La Danse Lente Intime", text: "Dansez tr√®s lentement, corps contre corps, en vous murmurant des mots doux √† l'oreille.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "3min", accessories: [] },
                    { title: "Le Regard Profond", text: "Asseyez-vous l'un en face de l'autre, genoux contre genoux, et regardez-vous intens√©ment dans les yeux sans parler pendant 2 minutes.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "2min", accessories: [] },
                    { title: "L'√âtreinte Passionn√©e", text: "Serrez-vous dans les bras tr√®s fort, en vous balan√ßant doucement, comme si vous ne vouliez plus jamais vous l√¢cher.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "1min", accessories: [] },
                    { title: "Le C√¢lin Invers√©", text: "Asseyez-vous l'un sur l'autre, dos √† dos, et penchez-vous pour vous c√¢liner par-dessus l'√©paule.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "2min", accessories: [] },
                    { title: "Le Baiser de l'Araign√©e", text: "Allongez-vous sur le dos, face √† face, et essayez de vous embrasser en utilisant uniquement vos langues, sans bouger vos t√™tes.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "1min", accessories: [] },
                    { title: "Le Pont Humain", text: "L'un est allong√© sur le dos, l'autre se penche au-dessus, les mains et les pieds au sol, pour un baiser suspendu.", imageUrl: "https://sf1.doctissimo.fr/wp-content/uploads/doctissimo/2024/06/kamasutra-acrobatique-20-positions-spectaculaires-c09ac6e842b31429.jpeg", duration: "1min", accessories: [] }
                ],
                final_gage: [
                    { title: "Le Triomphe des Amoureux !", text: "[joueur] a gagn√© ! Pour c√©l√©brer, [joueur] peut choisir n'importe quel gage (m√™me un pass√©) pour [autreJoueur], qui doit l'ex√©cuter avec passion !", duration: "√Ä la discr√©tion du vainqueur", accessories: [], imageUrl: "https://pics.porn300.com/thumbs/4/9/d/1/d/49d1d9ede7c1d6f2edde98237892d4db6539482c.mp4/improved/23.jpg" },
                    { title: "Le Baiser de la Victoire !", text: " [joueur] a gagn√© ! Les deux joueurs doivent √©changer un baiser langoureux et infini, jusqu'√† ce que l'un d'eux ne puisse plus respirer (presque) !", duration: "Jusqu'√† l'√©puisement", accessories: [], imageUrl: "https://pics.porn300.com/thumbs/4/9/d/1/d/49d1d9ede7c1d6f2edde98237892d4db6539482c.mp4/improved/23.jpg" },
                    { title: "Nuit Blanche de Plaisir !", text: "[joueur] a gagn√© ! Les deux joueurs doivent se promettre une nuit enti√®re de plaisirs et d'explorations mutuelles, sans limites !", duration: "Toute la nuit", accessories: [], imageUrl: "https://pics.porn300.com/thumbs/4/9/d/1/d/49d1d9ede7c1d6f2edde98237892d4db6539482c.mp4/improved/23.jpg" },
                    { title: "Le D√©shabillage Supr√™me !", text: "[joueur] a gagn√© ! [autreJoueur] doit retirer le dernier v√™tement ou sous-v√™tement qu'il/elle porte, lentement et sensuellement, sous le regard de [joueur] !", duration: "1min", accessories: [], imageUrl: "https://pics.porn300.com/thumbs/4/9/d/1/d/49d1d9ede7c1d6f2edde98237892d4db6539482c.mp4/improved/23.jpg" }
                ],
                vestiaire: {
                    clothes: {
                        title: "Vestiaire des V√™tements !",
                        text: "Le rideau se l√®ve ! [joueur], c'est l'heure de te r√©v√©ler ! Ex√©cute un d√©shabillage torride pour [autreJoueur], ne gardant que tes dessous. Fais monter la temp√©rature !",
                        imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg",
                        duration: "Imm√©diat",
                        accessories: []
                    },
                    underwear: {
                        title: "Vestiaire Intime !",
                        text: "Plus rien √† cacher, [joueur] ! Termine ton spectacle pour [autreJoueur] en te lib√©rant de tes derniers dessous. L'intimit√© est √† son comble !",
                        imageUrl: "https://previews.123rf.com/images/vadimgozhda/vadimgozhda1804/vadimgozhda180400072/99616711-passionate-woman-in-thongs-takes-off-stocking-in-front-of-man-lying-in-bed-striptease-sexual.jpg",
                        duration: "Imm√©diat",
                        accessories: []
                    }
                }
            };

            for (const category in defaultGages) {
                const docRef = doc(gagesCollectionRef, category);
                if (category === 'vestiaire') {
                    await setDoc(docRef, defaultGages[category]); // Pour l'objet vestiaire
                } else {
                    await setDoc(docRef, { gages: defaultGages[category] }); // Pour les tableaux
                }
                console.log(`[initializeDefaultGagesInFirestore] Gages par d√©faut pour la cat√©gorie '${category}' initialis√©s.`);
            }
            console.log("[initializeDefaultGagesInFirestore] Tous les gages par d√©faut ont √©t√© initialis√©s dans Firestore.");
        }


        // --- Gestion des √©v√©nements ---

        // √âcouteur d'√©v√©nement pour le bouton "Commencer le jeu !"
        startGameButton.addEventListener('click', async () => {
            console.log("[startGameButton] Bouton 'Commencer le jeu !' cliqu√©.");
            // V√©rifie si Firebase est initialis√© avant de continuer
            if (!app || !auth || !db) {
                showMessage("Le jeu ne peut pas d√©marrer : Firebase n'est pas correctement configur√©. Veuillez v√©rifier la console pour plus de d√©tails et mettre √† jour votre 'firebaseConfig' si tu es en local.");
                return;
            }

            player1Name = player1NameInput.value.trim();
            player2Name = player2NameInput.value.trim();
            player1Clothes = parseInt(player1ClothesInput.value, 10);
            player1Underwear = parseInt(player1UnderwearInput.value, 10);
            player2Clothes = parseInt(player2ClothesInput.value, 10);
            player2Underwear = parseInt(player2UnderwearInput.value, 10);


            if (player1Name && player2Name && !isNaN(player1Clothes) && !isNaN(player1Underwear) && !isNaN(player2Clothes) && !isNaN(player2Underwear)) {
                // Validation des nombres de v√™tements
                if (player1Clothes < 0 || player1Underwear < 0 || player2Clothes < 0 || player2Underwear < 0) {
                    showMessage("Le nombre de v√™tements et sous-v√™tements ne peut pas √™tre n√©gatif.");
                    return;
                }

                // Authentification Firebase
                loadingIndicator.style.display = 'block'; // Affiche l'indicateur de chargement
                startGameButton.disabled = true; // D√©sactive le bouton pendant le chargement
                adminModeButton.disabled = true; // D√©sactive le bouton admin aussi

                try {
                    console.log("[startGameButton] Tentative d'authentification Firebase...");
                    // Pour l'ex√©cution locale, on utilise l'authentification anonyme.
                    await signInAnonymously(auth);

                    userId = auth.currentUser.uid; // R√©cup√®re l'UID de l'utilisateur
                    console.log("[startGameButton] Authentification Firebase r√©ussie. User ID:", userId);

                    // D√©finit la r√©f√©rence au document Firestore pour cette partie
                    gameDocRef = doc(db, `artifacts/${appId}/users/${userId}/game_state/current_game`);
                    console.log("[startGameButton] R√©f√©rence au document de jeu:", gameDocRef.path);

                    // Charge les gages depuis Firestore avant de charger l'√©tat du jeu
                    await loadGagesFromFirestore();
                    console.log("[startGameButton] Gages charg√©s. Tentative de chargement de l'√©tat du jeu...");

                    // Tente de charger l'√©tat du jeu existant
                    const docSnap = await getDoc(gameDocRef);
                    if (docSnap.exists()) {
                        const savedState = docSnap.data();
                        player1Name = savedState.player1Name;
                        player2Name = savedState.player2Name;
                        player1Position = savedState.player1Position;
                        player2Position = savedState.player2Position;
                        player1Clothes = savedState.player1Clothes;
                        player1Underwear = savedState.player1Underwear;
                        player2Clothes = savedState.player2Clothes;
                        player2Underwear = savedState.player2Underwear;
                        currentPlayer = savedState.currentPlayer;
                        selectedMaleEmoji = savedState.selectedMaleEmoji;
                        selectedFemaleEmoji = savedState.selectedFemaleEmoji;

                        showMessage("Partie pr√©c√©dente charg√©e !");
                        console.log("[startGameButton] Partie pr√©c√©dente charg√©e:", savedState);
                    } else {
                        // Si pas de partie sauvegard√©e, sauvegarde l'√©tat initial
                        await setDoc(gameDocRef, {
                            player1Name,
                            player2Name,
                            player1Position,
                            player2Position,
                            player1Clothes,
                            player1Underwear,
                            player2Clothes,
                            player2Underwear,
                            currentPlayer,
                            selectedMaleEmoji,
                            selectedFemaleEmoji
                        });
                        showMessage("Nouvelle partie commenc√©e et sauvegard√©e !");
                        console.log("[startGameButton] Nouvelle partie commenc√©e et sauvegard√©e.");
                    }

                    // Met √† jour les pions avec les emojis s√©lectionn√©s
                    player1Token.textContent = selectedMaleEmoji;
                    player2Token.textContent = selectedFemaleEmoji;
                    // Affiche le nom du premier joueur
                    currentPlayerNameDisplay.textContent = currentPlayer === 1 ? player1Name : player2Name;

                    // Bascule l'affichage de l'√©cran de d√©marrage √† l'√©cran de jeu
                    startScreen.style.display = 'none';
                    gameScreen.style.display = 'flex';
                    gameReady = true; // Le jeu est pr√™t
                    createBoard(); // G√©n√®re le plateau
                    updateGameAmbiance(Math.max(player1Position, player2Position)); // Initialise l'ambiance
                    updateTheme(); // Applique le th√®me initial
                    console.log("[startGameButton] Jeu d√©marr√© avec succ√®s.");

                } catch (error) {
                    console.error("[startGameButton] Erreur d'authentification ou de chargement Firebase :", error);
                    showMessage("Erreur de connexion √† Firebase. Veuillez r√©essayer ou v√©rifier votre configuration.");
                    startGameButton.disabled = false; // R√©active le bouton en cas d'erreur
                    adminModeButton.disabled = false;
                } finally {
                    loadingIndicator.style.display = 'none'; // Cache l'indicateur de chargement
                }

            } else {
                // Utilise une alerte simple pour les pr√©noms manquants
                showMessage("Veuillez saisir les pr√©noms des deux joueurs, choisir leurs emojis et entrer le nombre de v√™tements/sous-v√™tements pour commencer.");
            }
        });

        // Fonction pour sauvegarder l'√©tat du jeu dans Firestore
        async function saveGameState() {
            if (!gameDocRef) {
                console.warn("[saveGameState] gameDocRef n'est pas d√©fini. Impossible de sauvegarder l'√©tat du jeu.");
                return;
            }
            try {
                await updateDoc(gameDocRef, {
                    player1Name,
                    player2Name,
                    player1Position,
                    player2Position,
                    player1Clothes,
                    player1Underwear,
                    player2Clothes,
                    player2Underwear,
                    currentPlayer,
                    selectedMaleEmoji,
                    selectedFemaleEmoji
                });
                console.log("[saveGameState] √âtat du jeu sauvegard√© avec succ√®s !");
            } catch (error) {
                console.error("[saveGameState] Erreur lors de la sauvegarde de l'√©tat du jeu :", error);
            }
        }

        // √âcouteur d'√©v√©nement pour le bouton "Lancer le d√© !"
        rollDiceButton.addEventListener('click', async () => {
            if (!gameReady || isMoving) return;

            let rollCount = 0;
            const animationDuration = 1000; // Dur√©e de l'animation en ms
            const intervalTime = 100; // Intervalle entre chaque changement de valeur

            const animationInterval = setInterval(() => {
                const randomValue = Math.floor(Math.random() * 6) + 1;
                displayDiceFace(randomValue); // Afficher une face al√©atoire pendant l'animation
                rollCount++;
                if (rollCount * intervalTime >= animationDuration) {
                    clearInterval(animationInterval);
                    const diceResult = Math.floor(Math.random() * 6) + 1; // R√©sultat final du d√©
                    displayDiceFace(diceResult); // Afficher la face finale du d√©

                    // D√©termine la nouvelle position du joueur (index du tableau)
                    let currentPlayersPosition = currentPlayer === 1 ? player1Position : player2Position;
                    let potentialNewPosition = currentPlayersPosition + diceResult;

                    // Appelle la fonction g√©n√©rique de gestion de tour
                    handlePlayerTurn(potentialNewPosition);
                }
            }, intervalTime);
            // La sauvegarde se fait apr√®s le handlePlayerTurn pour s'assurer que toutes les mises √† jour sont faites
            // avant de sauvegarder.
        });

        // √âcouteur d'√©v√©nement UNIQUE pour le bouton "Gage termin√©" dans la pop-up
        gagDoneButton.addEventListener('click', async () => {
            hideGag();
            await saveGameState(); // Sauvegarde l'√©tat apr√®s avoir termin√© un gage
        });

        // √âcouteur d'√©v√©nement pour le bouton "Recommencer une nouvelle partie"
        restartGameButton.addEventListener('click', async () => {
            hideVictoryScreen();
            resetGame();
            // Supprime l'ancienne partie de Firestore si l'utilisateur red√©marre
            if (gameDocRef) {
                try {
                    // Utilise setDoc avec un objet vide pour effacer le contenu du document
                    // ou deleteDoc si tu veux supprimer compl√®tement le document.
                    // setDoc({}, { merge: false }) est plus s√ªr pour "vider" sans supprimer le document lui-m√™me.
                    await setDoc(gameDocRef, {
                        player1Name: '', player2Name: '',
                        player1Position: startCaseIndex, player2Position: startCaseIndex,
                        player1Clothes: 0, player1Underwear: 0,
                        player2Clothes: 0, player2Underwear: 0,
                        currentPlayer: 1,
                        selectedMaleEmoji: 'üé©', selectedFemaleEmoji: 'üíã'
                    });
                    console.log("[restartGameButton] Ancienne partie r√©initialis√©e dans Firestore.");
                } catch (error) {
                    console.error("[restartGameButton] Erreur lors de la r√©initialisation de l'ancienne partie :", error);
                }
            }
            // Pas besoin de saveGameState ici, car resetGame initialise les valeurs et le setDoc ci-dessus les met √† z√©ro.
        });

        // √âcouteur d'√©v√©nement pour le bouton "Terminer la session"
        endSessionButton.addEventListener('click', () => {
            hideVictoryScreen();
            resetGame();
            // Pas de sauvegarde ici, car la session est termin√©e
        });

        // √âcouteur d'√©v√©nement pour le bouton "D√©bogage" (toggle)
        toggleDebugButton.addEventListener('click', () => {
            if (debugControls.style.display === 'flex') {
                debugControls.style.display = 'none';
            } else {
                debugControls.style.display = 'flex';
            }
        });

        // √âcouteur d'√©v√©nement pour le bouton "D√©placer √† la case" (d√©bogage)
        manualMoveButton.addEventListener('click', async () => {
            if (!gameReady || isMoving) return;

            const targetVisualSquare = parseInt(targetSquareInput.value, 10);

            if (isNaN(targetVisualSquare) || targetVisualSquare < 1 || targetVisualSquare > totalOriginalCases) {
                showMessage(`Veuillez entrer un num√©ro de case valide entre 1 et ${totalOriginalCases}.`);
                return;
            }

            // Convertit le num√©ro de case visuel en index de tableau
            let targetArrayIndex = targetVisualSquare;
            if (targetVisualSquare >= 31) { // Si la case visuelle est 31 ou plus, on a pass√© le premier vestiaire
                targetArrayIndex += 1;
            }
            if (targetVisualSquare >= 61) { // Si la case visuelle est 61 ou plus, on a pass√© le deuxi√®me vestiaire
                targetArrayIndex += 1;
            }

            // G√®re le cas o√π l'utilisateur entre un num√©ro de case qui correspondrait √† un vestiaire
            // (Bien que l'input min/max le limite aux cases num√©rot√©es, c'est une s√©curit√©)
            if (targetArrayIndex === vestiaire1Index || targetArrayIndex === vestiaire2Index) {
                 showMessage(`La case ${targetVisualSquare} est un vestiaire. Veuillez entrer un num√©ro de case num√©rot√©e.`);
                 return;
            }

            // Appelle la fonction g√©n√©rique de gestion de tour
            await handlePlayerTurn(targetArrayIndex); // Attendre la fin du tour
            await saveGameState(); // Sauvegarde l'√©tat apr√®s le mouvement manuel
        });

        // --- Admin Mode Logic ---
        const ADMIN_PASSWORD = "admin"; // Mot de passe simple pour le mode admin (√Ä NE PAS UTILISER EN PRODUCTION !)

        adminModeButton.addEventListener('click', () => {
            adminPopup.style.display = 'flex';
            setTimeout(() => adminPopup.classList.add('active'), 10);
            adminPanelContent.style.display = 'none'; // Cache le contenu admin par d√©faut
            adminPasswordInput.value = ''; // R√©initialise le champ de mot de passe
        });

        adminCloseButton.addEventListener('click', () => {
            adminPopup.classList.remove('active');
            setTimeout(() => adminPopup.style.display = 'none', 300);
        });

        adminLoginButton.addEventListener('click', () => {
            const enteredPassword = adminPasswordInput.value;
            if (enteredPassword === ADMIN_PASSWORD) {
                showMessage("Connexion administrateur r√©ussie !");
                adminPasswordInput.style.display = 'none';
                adminLoginButton.style.display = 'none';
                adminPanelContent.style.display = 'block'; // Affiche le panneau admin
            } else {
                showMessage("Mot de passe incorrect.");
                adminPasswordInput.value = '';
            }
        });

        // Placeholder for future admin functionality
        addGageButton.addEventListener('click', () => {
            showMessage("Fonctionnalit√© d'ajout de gage √† impl√©menter ici !");
        });


        // D√©finition des plages de niveaux (doit √™tre apr√®s les constantes globales comme vestiaire1Index etc.)
        // Ces plages sont utilis√©es pour l'assignation al√©atoire des types de cases,
        // et leurs startIdx/endIdx sont les INDEX R√âELS du tableau de cases.
        const newLevelRanges = [
            { startIdx: 1, endIdx: 15, level: 1, goBack: 1, undress: 2, action: 3, truthDare: 5, massage: 4, rolePlay: 0 },
            { startIdx: 16, endIdx: 30, level: 2, goBack: 1, undress: 2, action: 3, truthDare: 4, massage: 3, rolePlay: 2 },
            { startIdx: 32, endIdx: 46, level: 3, goBack: 1, undress: 2, action: 3, truthDare: 3, massage: 3, rolePlay: 3 },
            { startIdx: 47, endIdx: 61, level: 4, goBack: 1, undress: 2, action: 3, truthDare: 3, massage: 3, rolePlay: 3 }
        ];

        // Initialisation du jeu au chargement complet du DOM
        document.addEventListener('DOMContentLoaded', () => {
            console.log("[DOMContentLoaded] DOM enti√®rement charg√©. D√©but de l'initialisation.");
            try {
                startScreen.style.display = 'flex';
                gameScreen.style.display = 'none';
                gagPopup.style.display = 'none';
                victoryPopup.style.display = 'none';
                debugControls.style.display = 'none';
                adminPopup.style.display = 'none'; // S'assurer que la popup admin est cach√©e au d√©marrage

                startGameButton.disabled = false;
                adminModeButton.disabled = false; // Rendre le bouton admin actif au d√©marrage
                loadingIndicator.style.display = 'none';

                // V√©rifier si les √©l√©ments existent avant d'appeler initializeEmojiOptions
                if (maleEmojiOptionsDiv && femaleEmojiOptionsDiv) {
                    initializeEmojiOptions(maleEmojiOptionsDiv, maleEmojis, 'male');
                    initializeEmojiOptions(femaleEmojiOptionsDiv, femaleEmojis, 'female');
                } else {
                    console.error("[DOMContentLoaded] Erreur: Un ou plusieurs conteneurs d'emojis n'ont pas √©t√© trouv√©s dans le DOM.");
                }

                displayDiceFace(1);
                updateTheme();
                console.log("[DOMContentLoaded] √âcran de d√©marrage pr√™t.");
            } catch (e) {
                console.error("[DOMContentLoaded] Erreur critique lors de l'initialisation du DOM:", e);
                showMessage("Une erreur est survenue au d√©marrage. Veuillez recharger la page.");
            }
        });

    </script>
</body>
</html>
